module.exports=[67691,e=>{"use strict";let t,r,o,i,a,n,s,c,l,d,u,p;var f,m,h,g=e.i(47909),w=e.i(74017),y=e.i(96250),A=e.i(59756),E=e.i(61916),T=e.i(14444),I=e.i(37092),b=e.i(69741),_=e.i(16795),k=e.i(87718),v=e.i(95169),R=e.i(47587),U=e.i(66012),S=e.i(70101),O=e.i(26937),x=e.i(10372),D=e.i(93695);e.i(52474);var N=e.i(220),L=e.i(89695),P=e.i(96017),C=e.i(26863),j=e.i(31428);let $=(e,t="ms")=>new Date(Date.now()+("sec"===t?1e3*e:e)),V=new WeakMap;function q(e,t){let r=t.fields,o={};for(let t in e){let i=r[t];if(!i){o[t]=e[t];continue}!1!==i.returned&&(o[t]=e[t])}return o}function M(e,t){V.has(e)||V.set(e,new Map);let r=V.get(e);if(r.has(t))return r.get(t);let o={..."user"===t?e.user?.additionalFields:{},..."session"===t?e.session?.additionalFields:{}};for(let r of e.plugins||[])r.schema&&r.schema[t]&&(o={...o,...r.schema[t].fields});return V.get(e).set(t,o),o}function z(e,t){return{...q(t,{fields:M(e,"user")}),id:t.id}}function B(e,t){return q(t,{fields:M(e,"session")})}function F(e,t){let r=t.action||"create",o=t.fields,i=Object.assign(Object.create(null),null);for(let t in o){if(t in e){if(!1===o[t].input){if(void 0!==o[t].defaultValue&&"update"!==r){i[t]=o[t].defaultValue;continue}if(e[t])throw new j.APIError("BAD_REQUEST",{message:`${t} is not allowed to be set`});continue}if(o[t].validator?.input&&void 0!==e[t]){i[t]=o[t].validator.input["~standard"].validate(e[t]);continue}if(o[t].transform?.input&&void 0!==e[t]){i[t]=o[t].transform?.input(e[t]);continue}i[t]=e[t];continue}if(void 0!==o[t].defaultValue&&"create"===r){if("function"==typeof o[t].defaultValue){i[t]=o[t].defaultValue();continue}i[t]=o[t].defaultValue;continue}if(o[t].required&&"create"===r)throw new j.APIError("BAD_REQUEST",{message:`${t} is required`})}return i}function H(e,t={},r){return F(t,{fields:M(e,"user"),action:r})}e.i(89139);var Z=e.i(72717),Z=Z,W=Z,Y=e.i(7855);function K(e,t){if(t.advanced?.ipAddress?.disableIpTracking)return null;if((0,W.p)()||(0,Z.d)())return"127.0.0.1";let r="headers"in e?e.headers:e;for(let e of t.advanced?.ipAddress?.ipAddressHeaders||["x-forwarded-for"]){let t="get"in r?r.get(e):r[e];if("string"==typeof t){var o;let e=t.split(",")[0].trim();if(o=e,Y.ipv4().safeParse(o).success||Y.ipv6().safeParse(o).success)return e}}return null}var G=e.i(18994);e.i(25528);var Q=e.i(31228),Q=Q,J=Q,X=Q,ee=Z,et=e.i(45300);e.i(71616);var er=e.i(27273),eo=e.i(13031);e.i(54048);var ei=e.i(62810);async function ea(t,r){let o;if(t.database)o="function"==typeof t.database?t.database(t):await r(t);else{let r=Object.keys((0,P.a)(t)).reduce((e,t)=>(e[t]=[],e),{}),{memoryAdapter:i}=await e.A(76372);o=i(r)(t)}return o.transaction||(et.logger.warn("Adapter does not correctly implement transaction function, patching it automatically. Please update your adapter implementation."),o.transaction=async e=>e(o)),o}async function en(t){return ea(t,async t=>{let{createKyselyAdapter:r}=await e.A(46120),{kysely:o,databaseType:i,transaction:a}=await r(t);if(!o)throw new er.BetterAuthError("Failed to initialize database adapter");let{kyselyAdapter:n}=await e.A(46120);return n(o,{type:i||"sqlite",debugLogs:!!t.database&&"debugLogs"in t.database&&t.database.debugLogs,transaction:a})(t)})}e.s(["default",0,ei],61166),e.i(61166),e.s(["$brand",()=>ei.$brand,"$input",()=>ei.$input,"$output",()=>ei.$output,"NEVER",()=>ei.NEVER,"TimePrecision",()=>ei.TimePrecision,"ZodAny",()=>ei.ZodAny,"ZodArray",()=>ei.ZodArray,"ZodBase64",()=>ei.ZodBase64,"ZodBase64URL",()=>ei.ZodBase64URL,"ZodBigInt",()=>ei.ZodBigInt,"ZodBigIntFormat",()=>ei.ZodBigIntFormat,"ZodBoolean",()=>ei.ZodBoolean,"ZodCIDRv4",()=>ei.ZodCIDRv4,"ZodCIDRv6",()=>ei.ZodCIDRv6,"ZodCUID",()=>ei.ZodCUID,"ZodCUID2",()=>ei.ZodCUID2,"ZodCatch",()=>ei.ZodCatch,"ZodCodec",()=>ei.ZodCodec,"ZodCustom",()=>ei.ZodCustom,"ZodCustomStringFormat",()=>ei.ZodCustomStringFormat,"ZodDate",()=>ei.ZodDate,"ZodDefault",()=>ei.ZodDefault,"ZodDiscriminatedUnion",()=>ei.ZodDiscriminatedUnion,"ZodE164",()=>ei.ZodE164,"ZodEmail",()=>ei.ZodEmail,"ZodEmoji",()=>ei.ZodEmoji,"ZodEnum",()=>ei.ZodEnum,"ZodError",()=>ei.ZodError,"ZodFile",()=>ei.ZodFile,"ZodFirstPartyTypeKind",()=>ei.ZodFirstPartyTypeKind,"ZodFunction",()=>ei.ZodFunction,"ZodGUID",()=>ei.ZodGUID,"ZodIPv4",()=>ei.ZodIPv4,"ZodIPv6",()=>ei.ZodIPv6,"ZodISODate",()=>ei.ZodISODate,"ZodISODateTime",()=>ei.ZodISODateTime,"ZodISODuration",()=>ei.ZodISODuration,"ZodISOTime",()=>ei.ZodISOTime,"ZodIntersection",()=>ei.ZodIntersection,"ZodIssueCode",()=>ei.ZodIssueCode,"ZodJWT",()=>ei.ZodJWT,"ZodKSUID",()=>ei.ZodKSUID,"ZodLazy",()=>ei.ZodLazy,"ZodLiteral",()=>ei.ZodLiteral,"ZodMAC",()=>ei.ZodMAC,"ZodMap",()=>ei.ZodMap,"ZodNaN",()=>ei.ZodNaN,"ZodNanoID",()=>ei.ZodNanoID,"ZodNever",()=>ei.ZodNever,"ZodNonOptional",()=>ei.ZodNonOptional,"ZodNull",()=>ei.ZodNull,"ZodNullable",()=>ei.ZodNullable,"ZodNumber",()=>ei.ZodNumber,"ZodNumberFormat",()=>ei.ZodNumberFormat,"ZodObject",()=>ei.ZodObject,"ZodOptional",()=>ei.ZodOptional,"ZodPipe",()=>ei.ZodPipe,"ZodPrefault",()=>ei.ZodPrefault,"ZodPromise",()=>ei.ZodPromise,"ZodReadonly",()=>ei.ZodReadonly,"ZodRealError",()=>ei.ZodRealError,"ZodRecord",()=>ei.ZodRecord,"ZodSet",()=>ei.ZodSet,"ZodString",()=>ei.ZodString,"ZodStringFormat",()=>ei.ZodStringFormat,"ZodSuccess",()=>ei.ZodSuccess,"ZodSymbol",()=>ei.ZodSymbol,"ZodTemplateLiteral",()=>ei.ZodTemplateLiteral,"ZodTransform",()=>ei.ZodTransform,"ZodTuple",()=>ei.ZodTuple,"ZodType",()=>ei.ZodType,"ZodULID",()=>ei.ZodULID,"ZodURL",()=>ei.ZodURL,"ZodUUID",()=>ei.ZodUUID,"ZodUndefined",()=>ei.ZodUndefined,"ZodUnion",()=>ei.ZodUnion,"ZodUnknown",()=>ei.ZodUnknown,"ZodVoid",()=>ei.ZodVoid,"ZodXID",()=>ei.ZodXID,"_ZodString",()=>ei._ZodString,"_default",()=>ei._default,"_function",()=>ei._function,"any",()=>ei.any,"array",()=>ei.array,"base64",()=>ei.base64,"base64url",()=>ei.base64url,"bigint",()=>ei.bigint,"boolean",()=>ei.boolean,"catch",()=>ei.catch,"check",()=>ei.check,"cidrv4",()=>ei.cidrv4,"cidrv6",()=>ei.cidrv6,"clone",()=>ei.clone,"codec",()=>ei.codec,"coerce",()=>ei.coerce,"config",()=>ei.config,"core",()=>ei.core,"cuid",()=>ei.cuid,"cuid2",()=>ei.cuid2,"custom",()=>ei.custom,"date",()=>ei.date,"decode",()=>ei.decode,"decodeAsync",()=>ei.decodeAsync,"default",0,ei,"describe",()=>ei.describe,"discriminatedUnion",()=>ei.discriminatedUnion,"e164",()=>ei.e164,"email",()=>ei.email,"emoji",()=>ei.emoji,"encode",()=>ei.encode,"encodeAsync",()=>ei.encodeAsync,"endsWith",()=>ei.endsWith,"enum",()=>ei.enum,"file",()=>ei.file,"flattenError",()=>ei.flattenError,"float32",()=>ei.float32,"float64",()=>ei.float64,"formatError",()=>ei.formatError,"function",()=>ei.function,"getErrorMap",()=>ei.getErrorMap,"globalRegistry",()=>ei.globalRegistry,"gt",()=>ei.gt,"gte",()=>ei.gte,"guid",()=>ei.guid,"hash",()=>ei.hash,"hex",()=>ei.hex,"hostname",()=>ei.hostname,"httpUrl",()=>ei.httpUrl,"includes",()=>ei.includes,"instanceof",()=>ei.instanceof,"int",()=>ei.int,"int32",()=>ei.int32,"int64",()=>ei.int64,"intersection",()=>ei.intersection,"ipv4",()=>ei.ipv4,"ipv6",()=>ei.ipv6,"iso",()=>ei.iso,"json",()=>ei.json,"jwt",()=>ei.jwt,"keyof",()=>ei.keyof,"ksuid",()=>ei.ksuid,"lazy",()=>ei.lazy,"length",()=>ei.length,"literal",()=>ei.literal,"locales",()=>ei.locales,"looseObject",()=>ei.looseObject,"lowercase",()=>ei.lowercase,"lt",()=>ei.lt,"lte",()=>ei.lte,"mac",()=>ei.mac,"map",()=>ei.map,"maxLength",()=>ei.maxLength,"maxSize",()=>ei.maxSize,"meta",()=>ei.meta,"mime",()=>ei.mime,"minLength",()=>ei.minLength,"minSize",()=>ei.minSize,"multipleOf",()=>ei.multipleOf,"nan",()=>ei.nan,"nanoid",()=>ei.nanoid,"nativeEnum",()=>ei.nativeEnum,"negative",()=>ei.negative,"never",()=>ei.never,"nonnegative",()=>ei.nonnegative,"nonoptional",()=>ei.nonoptional,"nonpositive",()=>ei.nonpositive,"normalize",()=>ei.normalize,"null",()=>ei.null,"nullable",()=>ei.nullable,"nullish",()=>ei.nullish,"number",()=>ei.number,"object",()=>ei.object,"optional",()=>ei.optional,"overwrite",()=>ei.overwrite,"parse",()=>ei.parse,"parseAsync",()=>ei.parseAsync,"partialRecord",()=>ei.partialRecord,"pipe",()=>ei.pipe,"positive",()=>ei.positive,"prefault",()=>ei.prefault,"preprocess",()=>ei.preprocess,"prettifyError",()=>ei.prettifyError,"promise",()=>ei.promise,"property",()=>ei.property,"readonly",()=>ei.readonly,"record",()=>ei.record,"refine",()=>ei.refine,"regex",()=>ei.regex,"regexes",()=>ei.regexes,"registry",()=>ei.registry,"safeDecode",()=>ei.safeDecode,"safeDecodeAsync",()=>ei.safeDecodeAsync,"safeEncode",()=>ei.safeEncode,"safeEncodeAsync",()=>ei.safeEncodeAsync,"safeParse",()=>ei.safeParse,"safeParseAsync",()=>ei.safeParseAsync,"set",()=>ei.set,"setErrorMap",()=>ei.setErrorMap,"size",()=>ei.size,"slugify",()=>ei.slugify,"startsWith",()=>ei.startsWith,"strictObject",()=>ei.strictObject,"string",()=>ei.string,"stringFormat",()=>ei.stringFormat,"stringbool",()=>ei.stringbool,"success",()=>ei.success,"superRefine",()=>ei.superRefine,"symbol",()=>ei.symbol,"templateLiteral",()=>ei.templateLiteral,"toJSONSchema",()=>ei.toJSONSchema,"toLowerCase",()=>ei.toLowerCase,"toUpperCase",()=>ei.toUpperCase,"transform",()=>ei.transform,"treeifyError",()=>ei.treeifyError,"trim",()=>ei.trim,"tuple",()=>ei.tuple,"uint32",()=>ei.uint32,"uint64",()=>ei.uint64,"ulid",()=>ei.ulid,"undefined",()=>ei.undefined,"union",()=>ei.union,"unknown",()=>ei.unknown,"uppercase",()=>ei.uppercase,"url",()=>ei.url,"util",()=>ei.util,"uuid",()=>ei.uuid,"uuidv4",()=>ei.uuidv4,"uuidv6",()=>ei.uuidv6,"uuidv7",()=>ei.uuidv7,"void",()=>ei.void,"xid",()=>ei.xid,"z",0,ei],90544),e.i(90544);let es=(e,t)=>{let r,o=t.logger,i=t.options,a=i.secondaryStorage,n=i.session?.expiresIn||604800,{createWithHooks:s,updateWithHooks:c,updateManyWithHooks:l,deleteWithHooks:d,deleteManyWithHooks:u}=(r=t.hooks,{createWithHooks:async function(t,o,i){let a=await (0,J.u)(),n=t;for(let e of r||[]){let t=e[o]?.create?.before;if(t){let e=await t(n,a);if(!1===e)return null;"object"==typeof e&&"data"in e&&(n={...n,...e.data})}}let s=i?await i.fn(n):null,c=!i||i.executeMainFn?await (await (0,Q.t)(e)).create({model:o,data:n,forceAllowId:!0}):s;for(let e of r||[]){let t=e[o]?.create?.after;t&&await t(c,a)}return c},updateWithHooks:async function(t,o,i,a){let n=await (0,J.u)(),s=t;for(let e of r||[]){let r=e[i]?.update?.before;if(r){let e=await r(t,n);if(!1===e)return null;"object"==typeof e&&"data"in e&&(s={...s,...e.data})}}let c=a?await a.fn(s):null,l=!a||a.executeMainFn?await (await (0,Q.t)(e)).update({model:i,update:s,where:o}):c;for(let e of r||[]){let t=e[i]?.update?.after;t&&await t(l,n)}return l},updateManyWithHooks:async function(t,o,i,a){let n=await (0,J.u)(),s=t;for(let e of r||[]){let r=e[i]?.update?.before;if(r){let e=await r(t,n);if(!1===e)return null;"object"==typeof e&&"data"in e&&(s={...s,...e.data})}}let c=a?await a.fn(s):null,l=!a||a.executeMainFn?await (await (0,Q.t)(e)).updateMany({model:i,update:s,where:o}):c;for(let e of r||[]){let t=e[i]?.update?.after;t&&await t(l,n)}return l},deleteWithHooks:async function(t,o,i){let a=await (0,J.u)(),n=null;try{n=(await (await (0,Q.t)(e)).findMany({model:o,where:t,limit:1}))[0]||null}catch(e){}if(n)for(let e of r||[]){let t=e[o]?.delete?.before;if(t&&await t(n,a)===!1)return null}let s=i?await i.fn(t):null,c=!i||i.executeMainFn?await (await (0,Q.t)(e)).delete({model:o,where:t}):s;if(n)for(let e of r||[]){let t=e[o]?.delete?.after;t&&await t(n,a)}return c},deleteManyWithHooks:async function(t,o,i){let a=await (0,J.u)(),n=[];try{n=await (await (0,Q.t)(e)).findMany({model:o,where:t})}catch(e){}for(let e of n)for(let t of r||[]){let r=t[o]?.delete?.before;if(r&&await r(e,a)===!1)return null}let s=i?await i.fn(t):null,c=!i||i.executeMainFn?await (await (0,Q.t)(e)).deleteMany({model:o,where:t}):s;for(let e of n)for(let t of r||[]){let r=t[o]?.delete?.after;r&&await r(e,a)}return c}});async function p(e){if(!a)return;let t=await a.get(`active-sessions-${e.id}`);if(!t)return;let r=Date.now(),o=((0,G.t)(t)||[]).filter(e=>e.expiresAt>r);await Promise.all(o.map(async({token:t})=>{let o=await a.get(t);if(!o)return;let i=(0,G.t)(o);if(!i)return;let n=Math.max(Math.floor(new Date(i.session.expiresAt).getTime()-r)/1e3,0);await a.set(t,JSON.stringify({session:i.session,user:e}),Math.floor(n))}))}return{createOAuthUser:async(t,r)=>(0,X.i)(e,async()=>{let e=await s({createdAt:new Date,updatedAt:new Date,...t},"user",void 0);return{user:e,account:await s({...r,userId:e.id,createdAt:new Date,updatedAt:new Date},"account",void 0)}}),createUser:async e=>await s({createdAt:new Date,updatedAt:new Date,...e,email:e.email?.toLowerCase()},"user",void 0),createAccount:async e=>await s({createdAt:new Date,updatedAt:new Date,...e},"account",void 0),listSessions:async r=>{if(a){let e=await a.get(`active-sessions-${r}`);if(!e)return[];let o=(0,G.t)(e)||[],i=Date.now(),n=o.filter(e=>e.expiresAt>i),s=[];for(let e of n){let r=await a.get(e.token);if(r){let e=(0,G.t)(r);if(!e)return[];let o=B(t.options,{...e.session,expiresAt:new Date(e.session.expiresAt)});s.push(o)}}return s}return await (await (0,Q.t)(e)).findMany({model:"session",where:[{field:"userId",value:r}]})},listUsers:async(t,r,o,i)=>await (await (0,Q.t)(e)).findMany({model:"user",limit:t,offset:r,sortBy:o,where:i}),countTotalUsers:async t=>{let r=await (await (0,Q.t)(e)).count({model:"user",where:t});return"string"==typeof r?parseInt(r):r},deleteUser:async e=>{a&&await a.delete(`active-sessions-${e}`),(!a||i.session?.storeSessionInDatabase)&&await u([{field:"userId",value:e}],"session",void 0),await u([{field:"userId",value:e}],"account",void 0),await d([{field:"id",value:e}],"user",void 0)},createSession:async(t,r,o,c)=>{let l=await (0,J.u)().catch(()=>null),d=l?.headers||l?.request?.headers,{id:u,...p}=o||{},f=F({},{fields:M(l?.context.options??i,"session")}),m={ipAddress:(l?.request||l?.headers)&&K(l?.request||l?.headers,l?.context.options)||"",userAgent:d?.get("user-agent")||"",...p,expiresAt:r?$(86400,"sec"):$(n,"sec"),userId:t,token:(0,C.t)(32),createdAt:new Date,updatedAt:new Date,...f,...c?p:{}};return await s(m,"session",a?{fn:async r=>{let o=await a.get(`active-sessions-${t}`),i=[],n=Date.now();o&&(i=(i=(0,G.t)(o)||[]).filter(e=>e.expiresAt>n));let s=i.sort((e,t)=>e.expiresAt-t.expiresAt),c=s.at(-1)?.expiresAt;s.push({token:m.token,expiresAt:m.expiresAt.getTime()}),(!c||c<m.expiresAt.getTime())&&(c=m.expiresAt.getTime());let l=Math.max(Math.floor((c-n)/1e3),0);l>0&&await a.set(`active-sessions-${t}`,JSON.stringify(s),l);let d=await e.findOne({model:"user",where:[{field:"id",value:t}]}),u=Math.max(Math.floor((m.expiresAt.getTime()-n)/1e3),0);return u>0&&await a.set(m.token,JSON.stringify({session:r,user:d}),u),r},executeMainFn:i.session?.storeSessionInDatabase}:void 0)},findSession:async r=>{if(a){let e=await a.get(r);if(!e&&!i.session?.storeSessionInDatabase)return null;if(e){let r=(0,G.t)(e);return r?{session:B(t.options,{...r.session,expiresAt:new Date(r.session.expiresAt),createdAt:new Date(r.session.createdAt),updatedAt:new Date(r.session.updatedAt)}),user:z(t.options,{...r.user,createdAt:new Date(r.user.createdAt),updatedAt:new Date(r.user.updatedAt)})}:null}}let o=await (await (0,Q.t)(e)).findOne({model:"session",where:[{value:r,field:"token"}],join:{user:!0}});if(!o)return null;let{user:n,...s}=o;return n?{session:B(t.options,s),user:z(t.options,n)}:null},findSessions:async t=>{if(a){let e=[];for(let r of t){let t=await a.get(r);if(t){let r=(0,G.t)(t);if(!r)return[];let o={session:{...r.session,expiresAt:new Date(r.session.expiresAt)},user:{...r.user,createdAt:new Date(r.user.createdAt),updatedAt:new Date(r.user.updatedAt)}};e.push(o)}}return e}let r=await (await (0,Q.t)(e)).findMany({model:"session",where:[{field:"token",value:t,operator:"in"}],join:{user:!0}});return!r.length||r.some(e=>!e.user)?[]:r.map(e=>{let{user:t,...r}=e;return{session:r,user:t}})},updateSession:async(e,t)=>await c(t,[{field:"token",value:e}],"session",a?{async fn(t){let r=await a.get(e);if(!r)return null;{let e=(0,G.t)(r);return e?{...e.session,...t}:null}},executeMainFn:i.session?.storeSessionInDatabase}:void 0),deleteSession:async r=>{if(a){let e=await a.get(r);if(e){let{session:t}=(0,G.t)(e)??{};if(!t)return void o.error("Session not found in secondary storage");let i=t.userId,n=await a.get(`active-sessions-${i}`);if(n){let e=(0,G.t)(n)||[],t=Date.now(),o=e.filter(e=>e.expiresAt>t&&e.token!==r),s=o.sort((e,t)=>e.expiresAt-t.expiresAt).at(-1)?.expiresAt;o.length>0&&s&&s>Date.now()?await a.set(`active-sessions-${i}`,JSON.stringify(o),Math.floor((s-t)/1e3)):await a.delete(`active-sessions-${i}`)}else o.error("Active sessions list not found in secondary storage")}if(await a.delete(r),!i.session?.storeSessionInDatabase||t.options.session?.preserveSessionInDatabase)return}await (await (0,Q.t)(e)).delete({model:"session",where:[{field:"token",value:r}]})},deleteAccounts:async e=>{await u([{field:"userId",value:e}],"account",void 0)},deleteAccount:async e=>{await d([{field:"id",value:e}],"account",void 0)},deleteSessions:async e=>{if(a){if("string"==typeof e){let t=await a.get(`active-sessions-${e}`),r=t?(0,G.t)(t):[];if(!r)return;for(let e of r)await a.delete(e.token)}else for(let t of e)await a.get(t)&&await a.delete(t);if(!i.session?.storeSessionInDatabase||t.options.session?.preserveSessionInDatabase)return}await u([{field:Array.isArray(e)?"token":"userId",value:e,operator:Array.isArray(e)?"in":void 0}],"session",void 0)},findOAuthUser:async(t,r,o)=>{let i=await (await (0,Q.t)(e)).findMany({model:"account",where:[{value:r,field:"accountId"}],join:{user:!0}}).then(e=>e.find(e=>e.providerId===o));if(i)if(i.user)return{user:i.user,accounts:[i]};else{let r=await (await (0,Q.t)(e)).findOne({model:"user",where:[{value:t.toLowerCase(),field:"email"}]});return r?{user:r,accounts:[i]}:null}{let r=await (await (0,Q.t)(e)).findOne({model:"user",where:[{value:t.toLowerCase(),field:"email"}]});return r?{user:r,accounts:await (await (0,Q.t)(e)).findMany({model:"account",where:[{value:r.id,field:"userId"}]})||[]}:null}},findUserByEmail:async(t,r)=>{let o=await (await (0,Q.t)(e)).findOne({model:"user",where:[{value:t.toLowerCase(),field:"email"}],join:{...r?.includeAccounts?{account:!0}:{}}});if(!o)return null;let{account:i,...a}=o;return{user:a,accounts:i??[]}},findUserById:async t=>t?await (await (0,Q.t)(e)).findOne({model:"user",where:[{field:"id",value:t}]}):null,linkAccount:async e=>await s({createdAt:new Date,updatedAt:new Date,...e},"account",void 0),updateUser:async(e,t)=>{let r=await c(t,[{field:"id",value:e}],"user",void 0);return await p(r),await p(r),r},updateUserByEmail:async(e,t)=>{let r=await c(t,[{field:"email",value:e.toLowerCase()}],"user",void 0);return await p(r),await p(r),r},updatePassword:async(e,t)=>{await l({password:t},[{field:"userId",value:e},{field:"providerId",value:"credential"}],"account",void 0)},findAccounts:async t=>await (await (0,Q.t)(e)).findMany({model:"account",where:[{field:"userId",value:t}]}),findAccount:async t=>await (await (0,Q.t)(e)).findOne({model:"account",where:[{field:"accountId",value:t}]}),findAccountByProviderId:async(t,r)=>await (await (0,Q.t)(e)).findOne({model:"account",where:[{field:"accountId",value:t},{field:"providerId",value:r}]}),findAccountByUserId:async t=>await (await (0,Q.t)(e)).findMany({model:"account",where:[{field:"userId",value:t}]}),updateAccount:async(e,t)=>await c(t,[{field:"id",value:e}],"account",void 0),createVerificationValue:async e=>await s({createdAt:new Date,updatedAt:new Date,...e},"verification",void 0),findVerificationValue:async t=>{let r=await (await (0,Q.t)(e)).findMany({model:"verification",where:[{field:"identifier",value:t}],sortBy:{field:"createdAt",direction:"desc"},limit:1});return i.verification?.disableCleanup||await (await (0,Q.t)(e)).deleteMany({model:"verification",where:[{field:"expiresAt",value:new Date,operator:"lt"}]}),r[0]},deleteVerificationValue:async t=>{await (await (0,Q.t)(e)).delete({model:"verification",where:[{field:"id",value:t}]})},deleteVerificationByIdentifier:async t=>{await (await (0,Q.t)(e)).delete({model:"verification",where:[{field:"identifier",value:t}]})},updateVerificationValue:async(e,t)=>await c(t,[{field:"id",value:e}],"verification",void 0)}},ec={postgres:{string:["character varying","varchar","text","uuid"],number:["int4","integer","bigint","smallint","numeric","real","double precision"],boolean:["bool","boolean"],date:["timestamptz","timestamp","date"],json:["json","jsonb"]},mysql:{string:["varchar","text","uuid"],number:["integer","int","bigint","smallint","decimal","float","double"],boolean:["boolean","tinyint"],date:["timestamp","datetime","date"],json:["json"]},sqlite:{string:["TEXT"],number:["INTEGER","REAL"],boolean:["INTEGER","BOOLEAN"],date:["DATE","INTEGER"],json:["TEXT"]},mssql:{string:["varchar","nvarchar","uniqueidentifier"],number:["int","bigint","smallint","decimal","float","double"],boolean:["bit","smallint"],date:["datetime2","date","datetime"],json:["varchar","nvarchar"]}};async function el(e){try{let t=await eo.sql`SHOW search_path`.execute(e);if(t.rows[0]?.search_path)return t.rows[0].search_path.split(",").map(e=>e.trim()).map(e=>e.replace(/^["']|["']$/g,"")).filter(e=>!e.startsWith("$"))[0]||"public"}catch(e){}return"public"}async function ed(e){let t=function(e){let t=(0,P.a)(e),r={};for(let e in t){let o=t[e],i=o.fields,a={};if(Object.entries(i).forEach(([e,r])=>{if(a[r.fieldName||e]=r,r.references){let o=t[r.references.model];o&&(a[r.fieldName||e].references={...r.references,model:o.modelName,field:r.references.field})}}),r[o.modelName]){r[o.modelName].fields={...r[o.modelName].fields,...a};continue}r[o.modelName]={fields:a,order:o.order||1/0}}return r}(e),r=(0,ee.n)(e.logger),{kysely:o,databaseType:i}=await (0,L.t)(e);i||(r.warn("Could not determine database type, defaulting to sqlite. Please provide a type in the database options to avoid this."),i="sqlite"),o||(r.error("Only kysely adapter is supported for migrations. You can use `generate` command to generate the schema, if you're using a different adapter."),process.exit(1));let a="public";if("postgres"===i){a=await el(o),r.debug(`PostgreSQL migration: Using schema '${a}' (from search_path)`);try{(await eo.sql`
				SELECT schema_name 
				FROM information_schema.schemata 
				WHERE schema_name = ${a}
			`.execute(o)).rows[0]||r.warn(`Schema '${a}' does not exist. Tables will be inspected from available schemas. Consider creating the schema first or checking your database configuration.`)}catch(e){r.debug(`Could not verify schema existence: ${e instanceof Error?e.message:String(e)}`)}}let n=await o.introspection.getTables(),s=n;if("postgres"===i)try{let e=await eo.sql`
				SELECT table_name 
				FROM information_schema.tables 
				WHERE table_schema = ${a}
				AND table_type = 'BASE TABLE'
			`.execute(o),t=new Set(e.rows.map(e=>e.table_name));s=n.filter(e=>e.schema===a&&t.has(e.name)),r.debug(`Found ${s.length} table(s) in schema '${a}': ${s.map(e=>e.name).join(", ")||"(none)"}`)}catch(e){r.warn(`Could not filter tables by schema. Using all discovered tables. Error: ${e instanceof Error?e.message:String(e)}`)}let c=[],l=[];for(let[e,o]of Object.entries(t)){let t=s.find(t=>t.name===e);if(!t){let t=c.findIndex(t=>t.table===e),r={table:e,fields:o.fields,order:o.order||1/0},i=c.findIndex(e=>(e.order||1/0)>r.order);-1===i?-1===t?c.push(r):c[t].fields={...c[t].fields,...o.fields}:c.splice(i,0,r);continue}let a={};for(let[n,s]of Object.entries(o.fields)){let o=t.columns.find(e=>e.name===n);if(!o){a[n]=s;continue}!function(e,t,r){if("string[]"===t||"number[]"===t)return e.toLowerCase().includes("json");let o=ec[r];return(Array.isArray(t)?o.string.map(e=>e.toLowerCase()):o[t].map(e=>e.toLowerCase())).includes(e.toLowerCase().split("(")[0].trim())}(o.dataType,s.type,i)&&r.warn(`Field ${n} in table ${e} has a different type in the database. Expected ${s.type} but got ${o.dataType}.`)}Object.keys(a).length>0&&l.push({table:e,fields:a,order:o.order||1/0})}let d=[],u=e.advanced?.database?.generateId==="uuid",p=e.advanced?.database?.useNumberId||e.advanced?.database?.generateId==="serial";function f(e,t){let r=e.type,o={string:{sqlite:"text",postgres:"text",mysql:e.unique?"varchar(255)":e.references?"varchar(36)":e.sortable||e.index?"varchar(255)":"text",mssql:e.unique||e.sortable?"varchar(255)":e.references?"varchar(36)":"varchar(8000)"},boolean:{sqlite:"integer",postgres:"boolean",mysql:"boolean",mssql:"smallint"},number:{sqlite:e.bigint?"bigint":"integer",postgres:e.bigint?"bigint":"integer",mysql:e.bigint?"bigint":"integer",mssql:e.bigint?"bigint":"integer"},date:{sqlite:"date",postgres:"timestamptz",mysql:"timestamp(3)",mssql:eo.sql`datetime2(3)`},json:{sqlite:"text",postgres:"jsonb",mysql:"json",mssql:"varchar(8000)"},id:{postgres:p?eo.sql`integer GENERATED BY DEFAULT AS IDENTITY`:u?"uuid":"text",mysql:p?"integer":"varchar(36)",mssql:p?"integer":"varchar(36)",sqlite:p?"integer":"text"},foreignKeyId:{postgres:p?"integer":u?"uuid":"text",mysql:p?"integer":"varchar(36)",mssql:p?"integer":"varchar(36)",sqlite:p?"integer":"text"}};if("id"===t||e.references?.field==="id")return"id"===t?o.id[i]:o.foreignKeyId[i];if("sqlite"===i&&("string[]"===r||"number[]"===r))return"text";if("string[]"===r||"number[]"===r)return"jsonb";if(Array.isArray(r))return"text";if(!(r in o))throw Error(`Unsupported field type '${String(r)}' for field '${t}'. Allowed types are: string, number, boolean, date, string[], number[]. If you need to store structured data, store it as a JSON string (type: "string") or split it into primitive fields. See https://better-auth.com/docs/advanced/schema#additional-fields`);return o[r][i||"sqlite"]}let m=(0,P.t)({schema:(0,P.a)(e),usePlural:!1}),h=(0,P.n)({schema:(0,P.a)(e),usePlural:!1});function g(e,t){try{return`${m(e)}.${h({model:e,field:t})}`}catch{return`${e}.${t}`}}if(l.length)for(let e of l)for(let[t,r]of Object.entries(e.fields)){let a=f(r,t),n=o.schema.alterTable(e.table);if(r.index){let r=o.schema.alterTable(e.table).addIndex(`${e.table}_${t}_idx`);d.push(r)}let s=n.addColumn(t,a,e=>(e=!1!==r.required?e.notNull():e,r.references&&(e=e.references(g(r.references.model,r.references.field)).onDelete(r.references.onDelete||"cascade")),r.unique&&(e=e.unique()),"date"===r.type&&"function"==typeof r.defaultValue&&("postgres"===i||"mysql"===i||"mssql"===i)&&(e="mysql"===i?e.defaultTo(eo.sql`CURRENT_TIMESTAMP(3)`):e.defaultTo(eo.sql`CURRENT_TIMESTAMP`)),e));d.push(s)}let w=[];if(e.advanced?.database?.useNumberId&&r.warn("`useNumberId` is deprecated. Please use `generateId` with `serial` instead."),c.length)for(let e of c){let t=f({type:p?"number":"string"},"id"),r=o.schema.createTable(e.table).addColumn("id",t,e=>{if(p)return"postgres"===i?e.primaryKey().notNull():"sqlite"===i?e.primaryKey().notNull():"mssql"===i?e.identity().primaryKey().notNull():e.autoIncrement().primaryKey().notNull();return u&&"postgres"===i?e.primaryKey().defaultTo(eo.sql`pg_catalog.gen_random_uuid()`).notNull():e.primaryKey().notNull()});for(let[t,a]of Object.entries(e.fields)){let n=f(a,t);if(r=r.addColumn(t,n,e=>(e=!1!==a.required?e.notNull():e,a.references&&(e=e.references(g(a.references.model,a.references.field)).onDelete(a.references.onDelete||"cascade")),a.unique&&(e=e.unique()),"date"===a.type&&"function"==typeof a.defaultValue&&("postgres"===i||"mysql"===i||"mssql"===i)&&(e="mysql"===i?e.defaultTo(eo.sql`CURRENT_TIMESTAMP(3)`):e.defaultTo(eo.sql`CURRENT_TIMESTAMP`)),e)),a.index){let r=o.schema.createIndex(`${e.table}_${t}_${a.unique?"uidx":"idx"}`).on(e.table).columns([t]);w.push(a.unique?r.unique():r)}}d.push(r)}if(w.length)for(let e of w)d.push(e);return{toBeCreated:c,toBeAdded:l,runMigrations:async function(){for(let e of d)await e.execute()},compileMigrations:async function(){return d.map(e=>e.compile().sql).join(";\n\n")+";"}}}var eu=e.i(59872);function ep(e,t="/api/auth"){try{let t=new URL(e);if("http:"!==t.protocol&&"https:"!==t.protocol)throw new er.BetterAuthError(`Invalid base URL: ${e}. URL must include 'http://' or 'https://'`)}catch(t){if(t instanceof er.BetterAuthError)throw t;throw new er.BetterAuthError(`Invalid base URL: ${e}. Please provide a valid base URL.`,String(t))}if(function(e){try{return"/"!==(new URL(e).pathname.replace(/\/+$/,"")||"/")}catch(t){throw new er.BetterAuthError(`Invalid base URL: ${e}. Please provide a valid base URL.`)}}(e))return e;let r=e.replace(/\/+$/,"");return t&&"/"!==t?(t=t.startsWith("/")?t:`/${t}`,`${r}${t}`):r}function ef(e,t,r,o,i){if(e)return ep(e,t);if(!1!==o){let e=ew.c.BETTER_AUTH_URL||ew.c.NEXT_PUBLIC_BETTER_AUTH_URL||ew.c.PUBLIC_BETTER_AUTH_URL||ew.c.NUXT_PUBLIC_BETTER_AUTH_URL||ew.c.NUXT_PUBLIC_AUTH_URL||("/"!==ew.c.BASE_URL?ew.c.BASE_URL:void 0);if(e)return ep(e,t)}let a=r?.headers.get("x-forwarded-host"),n=r?.headers.get("x-forwarded-proto");if(a&&n&&i)return ep(`${n}://${a}`,t);if(r){let e=em(r.url);if(!e)throw new er.BetterAuthError("Could not get origin from request. Please provide a valid base URL.");return ep(e,t)}}function em(e){try{let t=new URL(e);return"null"===t.origin?null:t.origin}catch(e){return null}}function eh(e){try{return new URL(e).protocol}catch(e){return null}}function eg(e){try{return new URL(e).host}catch(e){return null}}e.i(73625);var ew=Z,ey=Z,eA=e.i(30501);let eE=new Map,eT={decode:(e,t="utf-8")=>(eE.has(t)||eE.set(t,new TextDecoder(t)),eE.get(t).decode(e)),encode:new TextEncoder().encode};var eI=e.i(72381),eb=e.i(96101);let e_=(e="SHA-256",t="none")=>{let r={importKey:async(t,r)=>(0,eb.getWebcryptoSubtle)().importKey("raw","string"==typeof t?new TextEncoder().encode(t):t,{name:"HMAC",hash:{name:e}},!1,[r]),sign:async(e,o)=>{"string"==typeof e&&(e=await r.importKey(e,"sign"));let i=await (0,eb.getWebcryptoSubtle)().sign("HMAC",e,"string"==typeof o?new TextEncoder().encode(o):o);return"hex"===t?eI.hex.encode(i):"base64"===t||"base64url"===t||"base64urlnopad"===t?eA.base64Url.encode(i,{padding:"base64urlnopad"!==t}):i},verify:async(e,o,i)=>("string"==typeof e&&(e=await r.importKey(e,"verify")),"hex"===t&&(i=eI.hex.decode(i)),("base64"===t||"base64url"===t||"base64urlnopad"===t)&&(i=await eA.base64.decode(i)),(0,eb.getWebcryptoSubtle)().verify("HMAC",e,"string"==typeof i?new TextEncoder().encode(i):i,"string"==typeof o?new TextEncoder().encode(o):o))};return r};function ek(e,t){if("string"==typeof e)return function(e){if("string"!=typeof e||0===e.length||e.length>100)throw Error(`Value provided to ms.parse() must be a string with length between 1 and 99. value=${JSON.stringify(e)}`);let t=/^(?<value>-?\d*\.?\d+) *(?<unit>milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|months?|mo|years?|yrs?|y)?$/i.exec(e);if(!t?.groups)return NaN;let{value:r,unit:o="ms"}=t.groups,i=parseFloat(r),a=o.toLowerCase();switch(a){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*i;case"months":case"month":case"mo":return 26298e5*i;case"weeks":case"week":case"w":return 6048e5*i;case"days":case"day":case"d":return 864e5*i;case"hours":case"hour":case"hrs":case"hr":case"h":return 36e5*i;case"minutes":case"minute":case"mins":case"min":case"m":return 6e4*i;case"seconds":case"second":case"secs":case"sec":case"s":return 1e3*i;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return i;default:throw Error(`Unknown unit "${a}" provided to ms.parse(). value=${JSON.stringify(e)}`)}}(e);if("number"==typeof e)return function(e,t){let r,o;if("number"!=typeof e||!Number.isFinite(e))throw Error("Value provided to ms.format() must be of type number.");return t?.long?(r=Math.abs(e))>=315576e5?ev(e,r,315576e5,"year"):r>=26298e5?ev(e,r,26298e5,"month"):r>=6048e5?ev(e,r,6048e5,"week"):r>=864e5?ev(e,r,864e5,"day"):r>=36e5?ev(e,r,36e5,"hour"):r>=6e4?ev(e,r,6e4,"minute"):r>=1e3?ev(e,r,1e3,"second"):`${e} ms`:(o=Math.abs(e))>=315576e5?`${Math.round(e/315576e5)}y`:o>=26298e5?`${Math.round(e/26298e5)}mo`:o>=6048e5?`${Math.round(e/6048e5)}w`:o>=864e5?`${Math.round(e/864e5)}d`:o>=36e5?`${Math.round(e/36e5)}h`:o>=6e4?`${Math.round(e/6e4)}m`:o>=1e3?`${Math.round(e/1e3)}s`:`${e}ms`}(e,t);throw Error(`Value provided to ms() must be a string or number. value=${JSON.stringify(e)}`)}function ev(e,t,r,o){return`${Math.round(e/r)} ${o}${t>=1.5*r?"s":""}`}function eR(e){let t=e.split("."),r=parseInt(t[t.length-1]||"0",10);return isNaN(r)?0:r}function eU(e,t){let r={};for(let o in e)r[o]={name:o,value:"",options:{...t,maxAge:0}};return r}let eS=e=>(t,r,o)=>{let i=function(e,t){let r={};for(let[o,i]of Object.entries(function(e){let t=e.headers?.get("cookie");if(!t)return{};let r={};for(let e of t.split("; ")){let[t,...o]=e.split("=");t&&o.length>0&&(r[t]=o.join("="))}return r}(t)))o.startsWith(e)&&(r[o]=i);return r}(t,o),a=o.context.logger;return{getValue:()=>Object.keys(i).sort((e,t)=>eR(e)-eR(t)).map(e=>i[e]).join(""),hasChunks:()=>Object.keys(i).length>0,chunk(o,n){let s=eU(i,r);for(let e in i)delete i[e];for(let c of function(e,t,r,o){let i=Math.ceil(t.value.length/3896);if(1===i)return r[t.name]=t.value,[t];let a=[];for(let e=0;e<i;e++){let o=`${t.name}.${e}`,i=3896*e,n=t.value.substring(i,i+3896);a.push({...t,name:o,value:n}),r[o]=n}return o.debug(`CHUNKING_${e.toUpperCase()}_COOKIE`,{message:`${e} cookie exceeds allowed 4096 bytes.`,emptyCookieSize:200,valueSize:t.value.length,chunkCount:i,chunks:a.map(e=>e.value.length+200)}),a}(e,{name:t,value:o,options:{...r,...n}},i,a))s[c.name]=c;return Object.values(s)},clean(){let e=eU(i,r);for(let e in i)delete i[e];return Object.values(e)},setCookies(e){for(let t of e)o.setCookie(t.name,t.value,t.options)}}},eO=eS("Session"),ex=eS("Account");function eD(e,t){let r=e.getCookie(t);if(r)return r;let o=[],i=e.headers?.get("cookie");if(!i)return null;let a={};for(let e of i.split("; ")){let[t,...r]=e.split("=");t&&r.length>0&&(a[t]=r.join("="))}for(let[e,r]of Object.entries(a))if(e.startsWith(t+".")){let t=parseInt(e.split(".").at(-1)||"0",10);isNaN(t)||o.push({index:t,value:r})}return o.length>0?(o.sort((e,t)=>e.index-t.index),o.map(e=>e.value).join("")):null}async function eN(e,t){let r=e.context.authCookies.accountData,o={maxAge:300,...r.options},i=await (0,eu.c)(t,e.context.secret,"better-auth-account",o.maxAge);if(i.length>4096){let t=ex(r.name,o,e),a=t.chunk(i,o);t.setCookies(a)}else{let t=ex(r.name,o,e);if(t.hasChunks()){let e=t.clean();t.setCookies(e)}e.setCookie(r.name,i,o)}}async function eL(e){let t=eD(e,e.context.authCookies.accountData.name);if(t){let r=(0,G.t)(await (0,eu.s)(t,e.context.secret,"better-auth-account"));if(r)return r}return null}let eP=Y.optional(Y.object({disableCookieCache:ei.coerce.boolean().meta({description:"Disable cookie cache and fetch session from database"}).optional(),disableRefresh:ei.coerce.boolean().meta({description:"Disable session refresh. Useful for checking session status, without updating the session"}).optional()}));function eC(e){let t=(e.advanced?.useSecureCookies!==void 0?e.advanced?.useSecureCookies:void 0!==e.baseURL?!!e.baseURL.startsWith("https://"):ey.f)?"__Secure-":"",r=!!e.advanced?.crossSubDomainCookies?.enabled,o=r?e.advanced?.crossSubDomainCookies?.domain||(e.baseURL?new URL(e.baseURL).hostname:void 0):void 0;if(r&&!o)throw new er.BetterAuthError("baseURL is required when crossSubdomainCookies are enabled");return function(i,a={}){let n=e.advanced?.cookiePrefix||"better-auth",s=e.advanced?.cookies?.[i]?.name||`${n}.${i}`,c=e.advanced?.cookies?.[i]?.attributes;return{name:`${t}${s}`,attributes:{secure:!!t,sameSite:"lax",path:"/",httpOnly:!0,...r?{domain:o}:{},...e.advanced?.defaultCookieAttributes,...a,...c}}}}async function ej(e,t,r){if(e.context.options.session?.cookieCache?.enabled){let o,i=Object.entries(t.session).reduce((t,[r,o])=>{let i=e.context.options.session?.additionalFields?.[r];return i&&!1===i.returned||(t[r]=o),t},{}),a=z(e.context.options,t.user),n=e.context.options.session?.cookieCache?.version,s="1";if(n){if("string"==typeof n)s=n;else if("function"==typeof n){let e=n(t.session,t.user);s=e instanceof Promise?await e:e}}let c={session:i,user:a,updatedAt:Date.now(),version:s},l={...e.context.authCookies.sessionData.options,maxAge:r?void 0:e.context.authCookies.sessionData.options.maxAge},d=$(l.maxAge||60,"sec").getTime(),u=e.context.options.session?.cookieCache?.strategy||"compact";if((o="jwe"===u?await (0,eu.c)(c,e.context.secret,"better-auth-session",l.maxAge||300):"jwt"===u?await (0,eu.o)(c,e.context.secret,l.maxAge||300):eA.base64Url.encode(JSON.stringify({session:c,expiresAt:d,signature:await e_("SHA-256","base64urlnopad").sign(e.context.secret,JSON.stringify({...c,expiresAt:d}))}),{padding:!1})).length>4093){let t=eO(e.context.authCookies.sessionData.name,l,e),r=t.chunk(o,l);t.setCookies(r)}else{let t=eO(e.context.authCookies.sessionData.name,l,e);if(t.hasChunks()){let e=t.clean();t.setCookies(e)}e.setCookie(e.context.authCookies.sessionData.name,o,l)}}}async function e$(e,t,r,o){let i=await e.getSignedCookie(e.context.authCookies.dontRememberToken.name,e.context.secret);r=void 0!==r?r:!!i;let a=e.context.authCookies.sessionToken.options,n=r?void 0:e.context.sessionConfig.expiresIn;await e.setSignedCookie(e.context.authCookies.sessionToken.name,t.session.token,e.context.secret,{...a,maxAge:n,...o}),r&&await e.setSignedCookie(e.context.authCookies.dontRememberToken.name,"true",e.context.secret,e.context.authCookies.dontRememberToken.options),await ej(e,t,r),e.context.setNewSession(t),e.context.options.secondaryStorage&&await e.context.secondaryStorage?.set(t.session.token,JSON.stringify({user:t.user,session:t.session}),Math.floor((new Date(t.session.expiresAt).getTime()-Date.now())/1e3))}function eV(e,t){e.setCookie(e.context.authCookies.sessionToken.name,"",{...e.context.authCookies.sessionToken.options,maxAge:0});let r=eO(e.context.authCookies.sessionData.name,e.context.authCookies.sessionData.options,e),o=r.clean();r.setCookies(o),t||e.setCookie(e.context.authCookies.dontRememberToken.name,"",{...e.context.authCookies.dontRememberToken.options,maxAge:0})}var eq=e.i(92653),eq=eq;e.i(3300);var eM=Q;let ez=(0,j.createMiddleware)(async()=>({})),eB=j.createMiddleware.create({use:[ez,(0,j.createMiddleware)(async()=>({}))]}),eF=[ez],eH=(e,t,r)=>(0,j.createEndpoint)(e,{...t,use:[...t?.use||[],...eF]},async e=>(0,eM.f)(e,()=>r(e))),eZ=()=>eH("/get-session",{method:"GET",operationId:"getSession",query:eP,requireHeaders:!0,metadata:{openapi:{operationId:"getSession",description:"Get the current session",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{session:{$ref:"#/components/schemas/Session"},user:{$ref:"#/components/schemas/User"}},required:["session","user"]}}}}}}}},async e=>{try{let t=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!t)return null;let r=eD(e,e.context.authCookies.sessionData.name),o=null;if(r){let t=e.context.options.session?.cookieCache?.strategy||"compact";if("jwe"===t){let t=await (0,eu.s)(r,e.context.secret,"better-auth-session");if(t&&t.session&&t.user)o={session:{session:t.session,user:t.user,updatedAt:t.updatedAt,version:t.version},expiresAt:t.exp?1e3*t.exp:Date.now()};else{let t=e.context.authCookies.sessionData.name;return e.setCookie(t,"",{maxAge:0}),e.json(null)}}else if("jwt"===t){let t=await (0,eu.l)(r,e.context.secret);if(t&&t.session&&t.user)o={session:{session:t.session,user:t.user,updatedAt:t.updatedAt,version:t.version},expiresAt:t.exp?1e3*t.exp:Date.now()};else{let t=e.context.authCookies.sessionData.name;return e.setCookie(t,"",{maxAge:0}),e.json(null)}}else{let t=(0,G.t)(eT.decode(eA.base64Url.decode(r)));if(t)if(await e_("SHA-256","base64urlnopad").verify(e.context.secret,JSON.stringify({...t.session,expiresAt:t.expiresAt}),t.signature))o=t;else{let t=e.context.authCookies.sessionData.name;return e.setCookie(t,"",{maxAge:0}),e.json(null)}}}let i=await e.getSignedCookie(e.context.authCookies.dontRememberToken.name,e.context.secret);if(o?.session&&e.context.options.session?.cookieCache?.enabled&&!e.query?.disableCookieCache){let t=o.session,r=e.context.options.session?.cookieCache?.version,i="1";if(r){if("string"==typeof r)i=r;else if("function"==typeof r){let e=r(t.session,t.user);i=e instanceof Promise?await e:e}}if((t.version||"1")!==i){let t=e.context.authCookies.sessionData.name;e.setCookie(t,"",{maxAge:0})}else if(o.expiresAt<Date.now()||t.session.expiresAt<new Date){let t=e.context.authCookies.sessionData.name;e.setCookie(t,"",{maxAge:0})}else{let r=e.context.sessionConfig.cookieRefreshCache;if(!1===r)return e.context.session=t,e.json({session:t.session,user:t.user});if(o.expiresAt-Date.now()<1e3*r.updateAge){let r=$(e.context.options.session?.cookieCache?.maxAge||300,"sec"),o={session:{...t.session,expiresAt:r},user:t.user,updatedAt:Date.now()};await ej(e,o,!1);let i=B(e.context.options,{...o.session,expiresAt:new Date(o.session.expiresAt),createdAt:new Date(o.session.createdAt),updatedAt:new Date(o.session.updatedAt)}),a=z(e.context.options,{...o.user,createdAt:new Date(o.user.createdAt),updatedAt:new Date(o.user.updatedAt)});return e.context.session={session:i,user:a},e.json({session:i,user:a})}let i=B(e.context.options,{...t.session,expiresAt:new Date(t.session.expiresAt),createdAt:new Date(t.session.createdAt),updatedAt:new Date(t.session.updatedAt)}),a=z(e.context.options,{...t.user,createdAt:new Date(t.user.createdAt),updatedAt:new Date(t.user.updatedAt)});return e.context.session={session:i,user:a},e.json({session:i,user:a})}}let a=await e.context.internalAdapter.findSession(t);if(e.context.session=a,!a||a.session.expiresAt<new Date)return eV(e),a&&await e.context.internalAdapter.deleteSession(a.session.token),e.json(null);if(i||e.query?.disableRefresh){let t=B(e.context.options,a.session),r=z(e.context.options,a.user);return e.json({session:t,user:r})}let n=e.context.sessionConfig.expiresIn,s=e.context.sessionConfig.updateAge;if(a.session.expiresAt.valueOf()-1e3*n+1e3*s<=Date.now()&&(!e.query?.disableRefresh||!e.context.options.session?.disableSessionRefresh)){let t=await e.context.internalAdapter.updateSession(a.session.token,{expiresAt:$(e.context.sessionConfig.expiresIn,"sec"),updatedAt:new Date});if(!t)return eV(e),e.json(null,{status:401});let r=(t.expiresAt.valueOf()-Date.now())/1e3;await e$(e,{session:t,user:a.user},!1,{maxAge:r});let o=B(e.context.options,t),i=z(e.context.options,a.user);return e.json({session:o,user:i})}return await ej(e,a,!!i),e.json(a)}catch(t){throw e.context.logger.error("INTERNAL_SERVER_ERROR",t),new j.APIError("INTERNAL_SERVER_ERROR",{message:eq.n.FAILED_TO_GET_SESSION})}}),eW=async(e,t)=>{if(e.context.session)return e.context.session;let r=await eZ()({...e,asResponse:!1,headers:e.headers,returnHeaders:!1,returnStatus:!1,query:{...t,...e.query}}).catch(e=>null);return e.context.session=r,r},eY=eB(async e=>{let t=await eW(e);if(!t?.session)throw new j.APIError("UNAUTHORIZED");return{session:t}}),eK=eB(async e=>{let t=await eW(e,{disableCookieCache:!0});if(!t?.session)throw new j.APIError("UNAUTHORIZED");return{session:t}});eB(async e=>{let t=await eW(e);if(!t?.session&&(e.request||e.headers))throw new j.APIError("UNAUTHORIZED");return{session:t}});let eG=eB(async e=>{let t=await eW(e);if(!t?.session)throw new j.APIError("UNAUTHORIZED");if(0===e.context.sessionConfig.freshAge)return{session:t};let r=e.context.sessionConfig.freshAge,o=new Date(t.session.updatedAt||t.session.createdAt).getTime();if(!(Date.now()-o<1e3*r))throw new j.APIError("FORBIDDEN",{message:"Session is not fresh"});return{session:t}}),eQ=eH("/revoke-session",{method:"POST",body:Y.object({token:Y.string().meta({description:"The token to revoke"})}),use:[eK],requireHeaders:!0,metadata:{openapi:{description:"Revoke a single session",requestBody:{content:{"application/json":{schema:{type:"object",properties:{token:{type:"string",description:"The token to revoke"}},required:["token"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if the session was revoked successfully"}},required:["status"]}}}}}}}},async e=>{let t=e.body.token;if((await e.context.internalAdapter.findSession(t))?.session.userId===e.context.session.user.id)try{await e.context.internalAdapter.deleteSession(t)}catch(t){throw e.context.logger.error(t&&"object"==typeof t&&"name"in t?t.name:"",t),new j.APIError("INTERNAL_SERVER_ERROR")}return e.json({status:!0})}),eJ=eH("/revoke-sessions",{method:"POST",use:[eK],requireHeaders:!0,metadata:{openapi:{description:"Revoke all sessions for the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if all sessions were revoked successfully"}},required:["status"]}}}}}}}},async e=>{try{await e.context.internalAdapter.deleteSessions(e.context.session.user.id)}catch(t){throw e.context.logger.error(t&&"object"==typeof t&&"name"in t?t.name:"",t),new j.APIError("INTERNAL_SERVER_ERROR")}return e.json({status:!0})}),eX=eH("/revoke-other-sessions",{method:"POST",requireHeaders:!0,use:[eK],metadata:{openapi:{description:"Revoke all other sessions for the user except the current one",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if all other sessions were revoked successfully"}},required:["status"]}}}}}}}},async e=>{let t=e.context.session;if(!t.user)throw new j.APIError("UNAUTHORIZED");let r=(await e.context.internalAdapter.listSessions(t.user.id)).filter(e=>e.expiresAt>new Date).filter(t=>t.token!==e.context.session.session.token);return await Promise.all(r.map(t=>e.context.internalAdapter.deleteSession(t.token))),e.json({status:!0})});var e0=Q,e1=Q,e2=Q,X=Q,Z=Z,ey=Z,e6=Z,eq=eq,e4=e.i(9939),e5=Z,e3=Object.defineProperty,e8=Object.defineProperties,e9=Object.getOwnPropertyDescriptors,e7=Object.getOwnPropertySymbols,te=Object.prototype.hasOwnProperty,tt=Object.prototype.propertyIsEnumerable,tr=(e,t,r)=>t in e?e3(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,to=(e,t)=>{for(var r in t||(t={}))te.call(t,r)&&tr(e,r,t[r]);if(e7)for(var r of e7(t))tt.call(t,r)&&tr(e,r,t[r]);return e},ti=(e,t)=>e8(e,e9(t)),ta=class extends Error{constructor(e,t,r){super(t||e.toString(),{cause:r}),this.status=e,this.statusText=t,this.error=r}},tn=async(e,t)=>{var r,o,i,a,n,s;let c=t||{},l={onRequest:[null==t?void 0:t.onRequest],onResponse:[null==t?void 0:t.onResponse],onSuccess:[null==t?void 0:t.onSuccess],onError:[null==t?void 0:t.onError],onRetry:[null==t?void 0:t.onRetry]};if(!t||!(null==t?void 0:t.plugins))return{url:e,options:c,hooks:l};for(let d of(null==t?void 0:t.plugins)||[]){if(d.init){let o=await (null==(r=d.init)?void 0:r.call(d,e.toString(),t));c=o.options||c,e=o.url}l.onRequest.push(null==(o=d.hooks)?void 0:o.onRequest),l.onResponse.push(null==(i=d.hooks)?void 0:i.onResponse),l.onSuccess.push(null==(a=d.hooks)?void 0:a.onSuccess),l.onError.push(null==(n=d.hooks)?void 0:n.onError),l.onRetry.push(null==(s=d.hooks)?void 0:s.onRetry)}return{url:e,options:c,hooks:l}},ts=class{constructor(e){this.options=e}shouldAttemptRetry(e,t){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(t)):Promise.resolve(e<this.options.attempts)}getDelay(){return this.options.delay}},tc=class{constructor(e){this.options=e}shouldAttemptRetry(e,t){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(t)):Promise.resolve(e<this.options.attempts)}getDelay(e){return Math.min(this.options.maxDelay,this.options.baseDelay*2**e)}},tl=async e=>{let t={},r=async e=>"function"==typeof e?await e():e;if(null==e?void 0:e.auth){if("Bearer"===e.auth.type){let o=await r(e.auth.token);if(!o)return t;t.authorization=`Bearer ${o}`}else if("Basic"===e.auth.type){let o=r(e.auth.username),i=r(e.auth.password);if(!o||!i)return t;t.authorization=`Basic ${btoa(`${o}:${i}`)}`}else if("Custom"===e.auth.type){let o=r(e.auth.value);if(!o)return t;t.authorization=`${r(e.auth.prefix)} ${o}`}}return t},td=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function tu(e){if(void 0===e)return!1;let t=typeof e;return"string"===t||"number"===t||"boolean"===t||null===t||"object"===t&&(!!Array.isArray(e)||!e.buffer&&(e.constructor&&"Object"===e.constructor.name||"function"==typeof e.toJSON))}function tp(e){try{return JSON.parse(e)}catch(t){return e}}async function tf(e){let t=new Headers(null==e?void 0:e.headers);for(let[r,o]of Object.entries(await tl(e)||{}))t.set(r,o);if(!t.has("content-type")){let r=tu(null==e?void 0:e.body)?"application/json":null;r&&t.set("content-type",r)}return t}var tm=class e extends Error{constructor(t,r){super(r||JSON.stringify(t,null,2)),this.issues=t,Object.setPrototypeOf(this,e.prototype)}};async function th(e,t){let r=await e["~standard"].validate(t);if(r.issues)throw new tm(r.issues);return r.value}var tg=["get","post","put","patch","delete"],tw=async(e,t)=>{var r,o,i,a,n,s,c,l;let d,{hooks:u,url:p,options:f}=await tn(e,t),m=function(e){if(null==e?void 0:e.customFetchImpl)return e.customFetchImpl;if("undefined"!=typeof globalThis&&"function"==typeof globalThis.fetch)return globalThis.fetch;throw Error("No fetch implementation found")}(f),h=new AbortController,g=null!=(r=f.signal)?r:h.signal,w=function(e,t){let{baseURL:r,params:o,query:i}=t||{query:{},params:{},baseURL:""},a=e.startsWith("http")?e.split("/").slice(0,3).join("/"):r||"";if(e.startsWith("@")){let t=e.toString().split("@")[1].split("/")[0];tg.includes(t)&&(e=e.replace(`@${t}/`,"/"))}a.endsWith("/")||(a+="/");let[n,s]=e.replace(a,"").split("?"),c=new URLSearchParams(s);for(let[e,t]of Object.entries(i||{}))null!=t&&c.set(e,String(t));if(o)if(Array.isArray(o))for(let[e,t]of n.split("/").filter(e=>e.startsWith(":")).entries()){let r=o[e];n=n.replace(t,r)}else for(let[e,t]of Object.entries(o))n=n.replace(`:${e}`,String(t));(n=n.split("/").map(encodeURIComponent).join("/")).startsWith("/")&&(n=n.slice(1));let l=c.toString();return(l=l.length>0?`?${l}`.replace(/\+/g,"%20"):"",a.startsWith("http"))?new URL(`${n}${l}`,a):`${a}${n}${l}`}(p,f),y=function(e){if(!(null==e?void 0:e.body))return null;let t=new Headers(null==e?void 0:e.headers);if(tu(e.body)&&!t.has("content-type")){for(let[t,r]of Object.entries(null==e?void 0:e.body))r instanceof Date&&(e.body[t]=r.toISOString());return JSON.stringify(e.body)}return e.body}(f),A=await tf(f),E=function(e,t){var r;if(null==t?void 0:t.method)return t.method.toUpperCase();if(e.startsWith("@")){let o=null==(r=e.split("@")[1])?void 0:r.split("/")[0];return tg.includes(o)?o.toUpperCase():(null==t?void 0:t.body)?"POST":"GET"}return(null==t?void 0:t.body)?"POST":"GET"}(p,f),T=ti(to({},f),{url:w,headers:A,body:y,method:E,signal:g});for(let e of u.onRequest)if(e){let t=await e(T);t instanceof Object&&(T=t)}("pipeTo"in T&&"function"==typeof T.pipeTo||"function"==typeof(null==(o=null==t?void 0:t.body)?void 0:o.pipe))&&!("duplex"in T)&&(T.duplex="half");let{clearTimeout:I}=(!(null==f?void 0:f.signal)&&(null==f?void 0:f.timeout)&&(d=setTimeout(()=>null==h?void 0:h.abort(),null==f?void 0:f.timeout)),{abortTimeout:d,clearTimeout:()=>{d&&clearTimeout(d)}}),b=await m(T.url,T);I();let _={response:b,request:T};for(let e of u.onResponse)if(e){let r=await e(ti(to({},_),{response:(null==(i=null==t?void 0:t.hookOptions)?void 0:i.cloneResponse)?b.clone():b}));r instanceof Response?b=r:r instanceof Object&&(b=r.response)}if(b.ok){if("HEAD"===T.method)return{data:"",error:null};let e=function(e){let t=e.headers.get("content-type"),r=new Set(["image/svg","application/xml","application/xhtml","application/html"]);if(!t)return"json";let o=t.split(";").shift()||"";return td.test(o)?"json":r.has(o)||o.startsWith("text/")?"text":"blob"}(b),r={data:"",response:b,request:T};if("json"===e||"text"===e){let e=await b.text(),t=null!=(a=T.jsonParser)?a:tp;r.data=await t(e)}else r.data=await b[e]();for(let e of((null==T?void 0:T.output)&&T.output&&!T.disableValidation&&(r.data=await th(T.output,r.data)),u.onSuccess))e&&await e(ti(to({},r),{response:(null==(n=null==t?void 0:t.hookOptions)?void 0:n.cloneResponse)?b.clone():b}));return(null==t?void 0:t.throw)?r.data:{data:r.data,error:null}}let k=null!=(s=null==t?void 0:t.jsonParser)?s:tp,v=await b.text(),R=function(e){try{return JSON.parse(e),!0}catch(e){return!1}}(v),U=R?await k(v):null,S={response:b,responseText:v,request:T,error:ti(to({},U),{status:b.status,statusText:b.statusText})};for(let e of u.onError)e&&await e(ti(to({},S),{response:(null==(c=null==t?void 0:t.hookOptions)?void 0:c.cloneResponse)?b.clone():b}));if(null==t?void 0:t.retry){let r=function(e){if("number"==typeof e)return new ts({type:"linear",attempts:e,delay:1e3});switch(e.type){case"linear":return new ts(e);case"exponential":return new tc(e);default:throw Error("Invalid retry strategy")}}(t.retry),o=null!=(l=t.retryAttempt)?l:0;if(await r.shouldAttemptRetry(o,b)){for(let e of u.onRetry)e&&await e(_);let i=r.getDelay(o);return await new Promise(e=>setTimeout(e,i)),await tw(e,ti(to({},t),{retryAttempt:o+1}))}}if(null==t?void 0:t.throw)throw new ta(b.status,b.statusText,R?U:v);return{data:null,error:ti(to({},U),{status:b.status,statusText:b.statusText})}};function ty(e){let t=e=>new Date(new Date().getTime()+1e3*e);return{tokenType:e.token_type,accessToken:e.access_token,refreshToken:e.refresh_token,accessTokenExpiresAt:e.expires_in?t(e.expires_in):void 0,refreshTokenExpiresAt:e.refresh_token_expires_in?t(e.refresh_token_expires_in):void 0,scopes:e?.scope?"string"==typeof e.scope?e.scope.split(" "):e.scope:[],idToken:e.id_token,raw:e}}async function tA(e){let t=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",t);return eA.base64Url.encode(new Uint8Array(r),{padding:!1})}async function tE({id:e,options:t,authorizationEndpoint:r,state:o,codeVerifier:i,scopes:a,claims:n,redirectURI:s,duration:c,prompt:l,accessType:d,responseType:u,display:p,loginHint:f,hd:m,responseMode:h,additionalParams:g,scopeJoiner:w}){let y=new URL(r);y.searchParams.set("response_type",u||"code");let A=Array.isArray(t.clientId)?t.clientId[0]:t.clientId;if(y.searchParams.set("client_id",A),y.searchParams.set("state",o),a&&y.searchParams.set("scope",a.join(w||" ")),y.searchParams.set("redirect_uri",t.redirectURI||s),c&&y.searchParams.set("duration",c),p&&y.searchParams.set("display",p),f&&y.searchParams.set("login_hint",f),l&&y.searchParams.set("prompt",l),m&&y.searchParams.set("hd",m),d&&y.searchParams.set("access_type",d),h&&y.searchParams.set("response_mode",h),i){let e=await tA(i);y.searchParams.set("code_challenge_method","S256"),y.searchParams.set("code_challenge",e)}if(n){let e=n.reduce((e,t)=>(e[t]=null,e),{});y.searchParams.set("claims",JSON.stringify({id_token:{email:null,email_verified:null,...e}}))}return g&&Object.entries(g).forEach(([e,t])=>{y.searchParams.set(e,t)}),y}async function tT({refreshToken:e,options:t,tokenEndpoint:r,authentication:o,extraParams:i}){let{body:a,headers:n}=function({refreshToken:e,options:t,authentication:r,extraParams:o,resource:i}){let a=new URLSearchParams,n={"content-type":"application/x-www-form-urlencoded",accept:"application/json"};if(a.set("grant_type","refresh_token"),a.set("refresh_token",e),"basic"===r){let e=Array.isArray(t.clientId)?t.clientId[0]:t.clientId;e?n.authorization="Basic "+eA.base64.encode(`${e}:${t.clientSecret??""}`):n.authorization="Basic "+eA.base64.encode(`:${t.clientSecret??""}`)}else{let e=Array.isArray(t.clientId)?t.clientId[0]:t.clientId;a.set("client_id",e),t.clientSecret&&a.set("client_secret",t.clientSecret)}if(i)if("string"==typeof i)a.append("resource",i);else for(let e of i)a.append("resource",e);if(o)for(let[e,t]of Object.entries(o))a.set(e,t);return{body:a,headers:n}}({refreshToken:e,options:t,authentication:o,extraParams:i}),{data:s,error:c}=await tw(r,{method:"POST",body:a,headers:n});if(c)throw c;let l={accessToken:s.access_token,refreshToken:s.refresh_token,tokenType:s.token_type,scopes:s.scope?.split(" "),idToken:s.id_token};return s.expires_in&&(l.accessTokenExpiresAt=new Date(new Date().getTime()+1e3*s.expires_in)),l}async function tI({code:e,codeVerifier:t,redirectURI:r,options:o,tokenEndpoint:i,authentication:a,deviceId:n,headers:s,additionalParams:c={},resource:l}){let{body:d,headers:u}=function({code:e,codeVerifier:t,redirectURI:r,options:o,authentication:i,deviceId:a,headers:n,additionalParams:s={},resource:c}){let l=new URLSearchParams,d={"content-type":"application/x-www-form-urlencoded",accept:"application/json",...n};if(l.set("grant_type","authorization_code"),l.set("code",e),t&&l.set("code_verifier",t),o.clientKey&&l.set("client_key",o.clientKey),a&&l.set("device_id",a),l.set("redirect_uri",o.redirectURI||r),c)if("string"==typeof c)l.append("resource",c);else for(let e of c)l.append("resource",e);if("basic"===i){let e=Array.isArray(o.clientId)?o.clientId[0]:o.clientId;d.authorization=`Basic ${eA.base64.encode(`${e}:${o.clientSecret??""}`)}`}else{let e=Array.isArray(o.clientId)?o.clientId[0]:o.clientId;l.set("client_id",e),o.clientSecret&&l.set("client_secret",o.clientSecret)}for(let[e,t]of Object.entries(s))l.has(e)||l.append(e,t);return{body:l,headers:d}}({code:e,codeVerifier:t,redirectURI:r,options:o,authentication:a,deviceId:n,headers:s,additionalParams:c,resource:l}),{data:p,error:f}=await tw(i,{method:"POST",body:d,headers:u});if(f)throw f;return ty(p)}var tb=e.i(39814),t_=eq,tk=e.i(65466),tv=e.i(97554),tR=e.i(42020);function tU(e){return(0,tR.isObject)(e)}class tS{#e;#t=new WeakMap;constructor(e){if(!function(e){return e&&"object"==typeof e&&Array.isArray(e.keys)&&e.keys.every(tU)}(e))throw new tk.JWKSInvalid("JSON Web Key Set malformed");this.#e=structuredClone(e)}jwks(){return this.#e}async getKey(e,t){let{alg:r,kid:o}={...e,...t?.header},i=function(e){switch("string"==typeof e&&e.slice(0,2)){case"RS":case"PS":return"RSA";case"ES":return"EC";case"Ed":return"OKP";case"ML":return"AKP";default:throw new tk.JOSENotSupported('Unsupported "alg" value for a JSON Web Key Set')}}(r),a=this.#e.keys.filter(e=>{let t=i===e.kty;if(t&&"string"==typeof o&&(t=o===e.kid),t&&("string"==typeof e.alg||"AKP"===i)&&(t=r===e.alg),t&&"string"==typeof e.use&&(t="sig"===e.use),t&&Array.isArray(e.key_ops)&&(t=e.key_ops.includes("verify")),t)switch(r){case"ES256":t="P-256"===e.crv;break;case"ES384":t="P-384"===e.crv;break;case"ES512":t="P-521"===e.crv;break;case"Ed25519":case"EdDSA":t="Ed25519"===e.crv}return t}),{0:n,length:s}=a;if(0===s)throw new tk.JWKSNoMatchingKey;if(1!==s){let e=new tk.JWKSMultipleMatchingKeys,t=this.#t;throw e[Symbol.asyncIterator]=async function*(){for(let e of a)try{yield await tO(t,e,r)}catch{}},e}return tO(this.#t,n,r)}}async function tO(e,t,r){let o=e.get(t)||e.set(t,{}).get(t);if(void 0===o[r]){let e=await (0,tv.importJWK)({...t,ext:!0},r);if(e instanceof Uint8Array||"public"!==e.type)throw new tk.JWKSInvalid("JSON Web Key Set members must be public keys");o[r]=e}return o[r]}function tx(e){let t=new tS(e),r=async(e,r)=>t.getKey(e,r);return Object.defineProperties(r,{jwks:{value:()=>structuredClone(t.jwks()),enumerable:!1,configurable:!1,writable:!1}}),r}"undefined"!=typeof navigator&&navigator.userAgent?.startsWith?.("Mozilla/5.0 ")||(t="jose/v6.1.3");let tD=Symbol();async function tN(e,t,r,o=fetch){let i=await o(e,{method:"GET",signal:r,redirect:"manual",headers:t}).catch(e=>{if("TimeoutError"===e.name)throw new tk.JWKSTimeout;throw e});if(200!==i.status)throw new tk.JOSEError("Expected 200 OK from the JSON Web Key Set HTTP response");try{return await i.json()}catch{throw new tk.JOSEError("Failed to parse the JSON Web Key Set HTTP response as JSON")}}let tL=Symbol();class tP{#r;#o;#i;#a;#n;#s;#c;#l;#d;#u;constructor(e,r){if(!(e instanceof URL))throw TypeError("url must be an instance of URL");this.#r=new URL(e.href),this.#o="number"==typeof r?.timeoutDuration?r?.timeoutDuration:5e3,this.#i="number"==typeof r?.cooldownDuration?r?.cooldownDuration:3e4,this.#a="number"==typeof r?.cacheMaxAge?r?.cacheMaxAge:6e5,this.#c=new Headers(r?.headers),t&&!this.#c.has("User-Agent")&&this.#c.set("User-Agent",t),this.#c.has("accept")||(this.#c.set("accept","application/json"),this.#c.append("accept","application/jwk-set+json")),this.#l=r?.[tD],r?.[tL]!==void 0&&(this.#u=r?.[tL],function(e,t){return!("object"!=typeof e||null===e||!("uat"in e)||"number"!=typeof e.uat||Date.now()-e.uat>=t)&&"jwks"in e&&!!(0,tR.isObject)(e.jwks)&&!!Array.isArray(e.jwks.keys)&&!!Array.prototype.every.call(e.jwks.keys,tR.isObject)}(r?.[tL],this.#a)&&(this.#n=this.#u.uat,this.#d=tx(this.#u.jwks)))}pendingFetch(){return!!this.#s}coolingDown(){return"number"==typeof this.#n&&Date.now()<this.#n+this.#i}fresh(){return"number"==typeof this.#n&&Date.now()<this.#n+this.#a}jwks(){return this.#d?.jwks()}async getKey(e,t){this.#d&&this.fresh()||await this.reload();try{return await this.#d(e,t)}catch(r){if(r instanceof tk.JWKSNoMatchingKey&&!1===this.coolingDown())return await this.reload(),this.#d(e,t);throw r}}async reload(){this.#s&&("undefined"!=typeof WebSocketPair||"undefined"!=typeof navigator&&"Cloudflare-Workers"===navigator.userAgent||"undefined"!=typeof EdgeRuntime&&"vercel"===EdgeRuntime)&&(this.#s=void 0),this.#s||=tN(this.#r.href,this.#c,AbortSignal.timeout(this.#o),this.#l).then(e=>{this.#d=tx(e),this.#u&&(this.#u.uat=Date.now(),this.#u.jwks=e),this.#n=Date.now(),this.#s=void 0}).catch(e=>{throw this.#s=void 0,e}),await this.#s}}var tC=e.i(63370),tj=e.i(32802);function t$(e){let t,r;if("string"!=typeof e)throw new tk.JWTInvalid("JWTs must use Compact JWS serialization, JWT must be a string");let{1:o,length:i}=e.split(".");if(5===i)throw new tk.JWTInvalid("Only JWTs using Compact JWS serialization can be decoded");if(3!==i)throw new tk.JWTInvalid("Invalid JWT");if(!o)throw new tk.JWTInvalid("JWTs must contain a payload");try{t=(0,tC.decode)(o)}catch{throw new tk.JWTInvalid("Failed to base64url decode the payload")}try{r=JSON.parse(tj.decoder.decode(t))}catch{throw new tk.JWTInvalid("Failed to parse the decoded payload as JSON")}if(!(0,tR.isObject)(r))throw new tk.JWTInvalid("Invalid JWT Claims Set");return r}function tV(e){let t;if("string"==typeof e){let r=e.split(".");(3===r.length||5===r.length)&&([t]=r)}else if("object"==typeof e&&e)if("protected"in e)t=e.protected;else throw TypeError("Token does not contain a Protected Header");try{if("string"!=typeof t||!t)throw Error();let e=JSON.parse(tj.decoder.decode((0,tC.decode)(t)));if(!(0,tR.isObject)(e))throw Error();return e}catch{throw TypeError("Invalid Token or Protected Header formatting")}}let tq=async e=>{let{data:t}=await tw("https://appleid.apple.com/auth/keys");if(!t?.keys)throw new j.APIError("BAD_REQUEST",{message:"Keys not found"});let r=t.keys.find(t=>t.kid===e);if(!r)throw Error(`JWK with kid ${e} not found`);return await (0,tv.importJWK)(r,r.alg)},tM=async(e,t,r)=>{let o=`https://cognito-idp.${t}.amazonaws.com/${r}/.well-known/jwks.json`;try{let{data:t}=await tw(o);if(!t?.keys)throw new j.APIError("BAD_REQUEST",{message:"Keys not found"});let r=t.keys.find(t=>t.kid===e);if(!r)throw Error(`JWK with kid ${e} not found`);return await (0,tv.importJWK)(r,r.alg)}catch(e){throw e5.i.error("Failed to fetch Cognito public key:",e),e}},tz=(e="")=>e.split("://").map(e=>e.replace(/\/{2,}/g,"/")).join("://"),tB={apple:e=>({id:"apple",name:"Apple",async createAuthorizationURL({state:t,scopes:r,redirectURI:o}){let i=e.disableDefaultScope?[]:["email","name"];return e.scope&&i.push(...e.scope),r&&i.push(...r),await tE({id:"apple",options:e,authorizationEndpoint:"https://appleid.apple.com/auth/authorize",scopes:i,state:t,redirectURI:o,responseMode:"form_post",responseType:"code id_token"})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:o})=>tI({code:t,codeVerifier:r,redirectURI:o,options:e,tokenEndpoint:"https://appleid.apple.com/auth/token"}),async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);let{kid:o,alg:i}=tV(t);if(!o||!i)return!1;let{payload:a}=await (0,e4.jwtVerify)(t,await tq(o),{algorithms:[i],issuer:"https://appleid.apple.com",audience:e.audience&&e.audience.length?e.audience:e.appBundleIdentifier?e.appBundleIdentifier:e.clientId,maxTokenAge:"1h"});return["email_verified","is_private_email"].forEach(e=>{void 0!==a[e]&&(a[e]=!!a[e])}),(!r||a.nonce===r)&&!!a},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://appleid.apple.com/auth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.idToken)return null;let r=t$(t.idToken);if(!r)return null;let o=t.user?`${t.user.name?.firstName} ${t.user.name?.lastName}`:r.name||r.email,i="boolean"==typeof r.email_verified?r.email_verified:"true"===r.email_verified,a={...r,name:o},n=await e.mapProfileToUser?.(a);return{user:{id:r.sub,name:a.name,emailVerified:i,email:r.email,...n},data:a}},options:e}),atlassian:e=>({id:"atlassian",name:"Atlassian",async createAuthorizationURL({state:t,scopes:r,codeVerifier:o,redirectURI:i}){if(!e.clientId||!e.clientSecret)throw e5.i.error("Client Id and Secret are required for Atlassian"),new t_.t("CLIENT_ID_AND_SECRET_REQUIRED");if(!o)throw new t_.t("codeVerifier is required for Atlassian");let a=e.disableDefaultScope?[]:["read:jira-user","offline_access"];return e.scope&&a.push(...e.scope),r&&a.push(...r),tE({id:"atlassian",options:e,authorizationEndpoint:"https://auth.atlassian.com/authorize",scopes:a,state:t,codeVerifier:o,redirectURI:i,additionalParams:{audience:"api.atlassian.com"},prompt:e.prompt})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:o})=>tI({code:t,codeVerifier:r,redirectURI:o,options:e,tokenEndpoint:"https://auth.atlassian.com/oauth/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientSecret:e.clientSecret},tokenEndpoint:"https://auth.atlassian.com/oauth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.accessToken)return null;try{let{data:r}=await tw("https://api.atlassian.com/me",{headers:{Authorization:`Bearer ${t.accessToken}`}});if(!r)return null;let o=await e.mapProfileToUser?.(r);return{user:{id:r.account_id,name:r.name,email:r.email,image:r.picture,emailVerified:!1,...o},data:r}}catch(e){return e5.i.error("Failed to fetch user info from Figma:",e),null}},options:e}),cognito:e=>{if(!e.domain||!e.region||!e.userPoolId)throw e5.i.error("Domain, region and userPoolId are required for Amazon Cognito. Make sure to provide them in the options."),new t_.t("DOMAIN_AND_REGION_REQUIRED");let t=e.domain.replace(/^https?:\/\//,""),r=`https://${t}/oauth2/authorize`,o=`https://${t}/oauth2/token`,i=`https://${t}/oauth2/userinfo`;return{id:"cognito",name:"Cognito",async createAuthorizationURL({state:t,scopes:o,codeVerifier:i,redirectURI:a}){if(!e.clientId)throw e5.i.error("ClientId is required for Amazon Cognito. Make sure to provide them in the options."),new t_.t("CLIENT_ID_AND_SECRET_REQUIRED");if(e.requireClientSecret&&!e.clientSecret)throw e5.i.error("Client Secret is required when requireClientSecret is true. Make sure to provide it in the options."),new t_.t("CLIENT_SECRET_REQUIRED");let n=e.disableDefaultScope?[]:["openid","profile","email"];return e.scope&&n.push(...e.scope),o&&n.push(...o),await tE({id:"cognito",options:{...e},authorizationEndpoint:r,scopes:n,state:t,codeVerifier:i,redirectURI:a,prompt:e.prompt})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:i})=>tI({code:t,codeVerifier:r,redirectURI:i,options:e,tokenEndpoint:o}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:o}),async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);try{let{kid:o,alg:i}=tV(t);if(!o||!i)return!1;let a=await tM(o,e.region,e.userPoolId),n=`https://cognito-idp.${e.region}.amazonaws.com/${e.userPoolId}`,{payload:s}=await (0,e4.jwtVerify)(t,a,{algorithms:[i],issuer:n,audience:e.clientId,maxTokenAge:"1h"});if(r&&s.nonce!==r)return!1;return!0}catch(e){return e5.i.error("Failed to verify ID token:",e),!1}},async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(t.idToken)try{let r=t$(t.idToken);if(!r)return null;let o=r.name||r.given_name||r.username||r.email,i={...r,name:o},a=await e.mapProfileToUser?.(i);return{user:{id:r.sub,name:i.name,email:r.email,image:r.picture,emailVerified:r.email_verified,...a},data:i}}catch(e){e5.i.error("Failed to decode ID token:",e)}if(t.accessToken)try{let{data:r}=await tw(i,{headers:{Authorization:`Bearer ${t.accessToken}`}});if(r){let t=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.name||r.given_name||r.username,email:r.email,image:r.picture,emailVerified:r.email_verified,...t},data:r}}}catch(e){e5.i.error("Failed to fetch user info from Cognito:",e)}return null},options:e}},discord:e=>({id:"discord",name:"Discord",createAuthorizationURL({state:t,scopes:r,redirectURI:o}){let i=e.disableDefaultScope?[]:["identify","email"];r&&i.push(...r),e.scope&&i.push(...e.scope);let a=i.includes("bot")&&void 0!==e.permissions?`&permissions=${e.permissions}`:"";return new URL(`https://discord.com/api/oauth2/authorize?scope=${i.join("+")}&response_type=code&client_id=${e.clientId}&redirect_uri=${encodeURIComponent(e.redirectURI||o)}&state=${t}&prompt=${e.prompt||"none"}${a}`)},validateAuthorizationCode:async({code:t,redirectURI:r})=>tI({code:t,redirectURI:r,options:e,tokenEndpoint:"https://discord.com/api/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://discord.com/api/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:o}=await tw("https://discord.com/api/users/@me",{headers:{authorization:`Bearer ${t.accessToken}`}});if(o)return null;if(null===r.avatar)r.image_url=`https://cdn.discordapp.com/embed/avatars/${"0"===r.discriminator?Number(BigInt(r.id)>>BigInt(22))%6:parseInt(r.discriminator)%5}.png`;else{let e=r.avatar.startsWith("a_")?"gif":"png";r.image_url=`https://cdn.discordapp.com/avatars/${r.id}/${r.avatar}.${e}`}let i=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.global_name||r.username||"",email:r.email,emailVerified:r.verified,image:r.image_url,...i},data:r}},options:e}),facebook:e=>({id:"facebook",name:"Facebook",async createAuthorizationURL({state:t,scopes:r,redirectURI:o,loginHint:i}){let a=e.disableDefaultScope?[]:["email","public_profile"];return e.scope&&a.push(...e.scope),r&&a.push(...r),await tE({id:"facebook",options:e,authorizationEndpoint:"https://www.facebook.com/v21.0/dialog/oauth",scopes:a,state:t,redirectURI:o,loginHint:i,additionalParams:e.configId?{config_id:e.configId}:{}})},validateAuthorizationCode:async({code:t,redirectURI:r})=>tI({code:t,redirectURI:r,options:e,tokenEndpoint:"https://graph.facebook.com/oauth/access_token"}),async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);if(3===t.split(".").length)try{var o;let i,a,{payload:n}=await (0,e4.jwtVerify)(t,(o=new URL("https://limited.facebook.com/.well-known/oauth/openid/jwks/"),i=new tP(o,void 0),a=async(e,t)=>i.getKey(e,t),Object.defineProperties(a,{coolingDown:{get:()=>i.coolingDown(),enumerable:!0,configurable:!1},fresh:{get:()=>i.fresh(),enumerable:!0,configurable:!1},reload:{value:()=>i.reload(),enumerable:!0,configurable:!1,writable:!1},reloading:{get:()=>i.pendingFetch(),enumerable:!0,configurable:!1},jwks:{value:()=>i.jwks(),enumerable:!0,configurable:!1,writable:!1}}),a),{algorithms:["RS256"],audience:e.clientId,issuer:"https://www.facebook.com"});if(r&&n.nonce!==r)return!1;return!!n}catch(e){return!1}return!0},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://graph.facebook.com/v18.0/oauth/access_token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(t.idToken&&3===t.idToken.split(".").length){let r=t$(t.idToken),o={id:r.sub,name:r.name,email:r.email,picture:{data:{url:r.picture,height:100,width:100,is_silhouette:!1}}},i=await e.mapProfileToUser?.({...o,email_verified:!1});return{user:{...o,emailVerified:!1,...i},data:r}}let{data:r,error:o}=await tw("https://graph.facebook.com/me?fields="+["id","name","email","picture",...e?.fields||[]].join(","),{auth:{type:"Bearer",token:t.accessToken}});if(o)return null;let i=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.name,email:r.email,image:r.picture.data.url,emailVerified:r.email_verified,...i},data:r}},options:e}),figma:e=>({id:"figma",name:"Figma",async createAuthorizationURL({state:t,scopes:r,codeVerifier:o,redirectURI:i}){if(!e.clientId||!e.clientSecret)throw e5.i.error("Client Id and Client Secret are required for Figma. Make sure to provide them in the options."),new t_.t("CLIENT_ID_AND_SECRET_REQUIRED");if(!o)throw new t_.t("codeVerifier is required for Figma");let a=e.disableDefaultScope?[]:["file_read"];return e.scope&&a.push(...e.scope),r&&a.push(...r),await tE({id:"figma",options:e,authorizationEndpoint:"https://www.figma.com/oauth",scopes:a,state:t,codeVerifier:o,redirectURI:i})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:o})=>tI({code:t,codeVerifier:r,redirectURI:o,options:e,tokenEndpoint:"https://www.figma.com/api/oauth/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://www.figma.com/api/oauth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);try{let{data:r}=await tw("https://api.figma.com/v1/me",{headers:{Authorization:`Bearer ${t.accessToken}`}});if(!r)return e5.i.error("Failed to fetch user from Figma"),null;let o=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.handle,email:r.email,image:r.img_url,emailVerified:!!r.email,...o},data:r}}catch(e){return e5.i.error("Failed to fetch user info from Figma:",e),null}},options:e}),github:e=>({id:"github",name:"GitHub",createAuthorizationURL({state:t,scopes:r,loginHint:o,codeVerifier:i,redirectURI:a}){let n=e.disableDefaultScope?[]:["read:user","user:email"];return e.scope&&n.push(...e.scope),r&&n.push(...r),tE({id:"github",options:e,authorizationEndpoint:"https://github.com/login/oauth/authorize",scopes:n,state:t,codeVerifier:i,redirectURI:a,loginHint:o,prompt:e.prompt})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:o})=>tI({code:t,codeVerifier:r,redirectURI:o,options:e,tokenEndpoint:"https://github.com/login/oauth/access_token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://github.com/login/oauth/access_token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:o}=await tw("https://api.github.com/user",{headers:{"User-Agent":"better-auth",authorization:`Bearer ${t.accessToken}`}});if(o)return null;let{data:i}=await tw("https://api.github.com/user/emails",{headers:{Authorization:`Bearer ${t.accessToken}`,"User-Agent":"better-auth"}});!r.email&&i&&(r.email=(i.find(e=>e.primary)??i[0])?.email);let a=i?.find(e=>e.email===r.email)?.verified??!1,n=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.name||r.login,email:r.email,image:r.avatar_url,emailVerified:a,...n},data:r}},options:e}),microsoft:e=>{let t=e.tenantId||"common",r=e.authority||"https://login.microsoftonline.com",o=`${r}/${t}/oauth2/v2.0/authorize`,i=`${r}/${t}/oauth2/v2.0/token`;return{id:"microsoft",name:"Microsoft EntraID",createAuthorizationURL(t){let r=e.disableDefaultScope?[]:["openid","profile","email","User.Read","offline_access"];return e.scope&&r.push(...e.scope),t.scopes&&r.push(...t.scopes),tE({id:"microsoft",options:e,authorizationEndpoint:o,state:t.state,codeVerifier:t.codeVerifier,scopes:r,redirectURI:t.redirectURI,prompt:e.prompt,loginHint:t.loginHint})},validateAuthorizationCode:({code:t,codeVerifier:r,redirectURI:o})=>tI({code:t,codeVerifier:r,redirectURI:o,options:e,tokenEndpoint:i}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.idToken)return null;let r=t$(t.idToken),o=e.profilePhotoSize||48;await tw(`https://graph.microsoft.com/v1.0/me/photos/${o}x${o}/$value`,{headers:{Authorization:`Bearer ${t.accessToken}`},async onResponse(t){if(!e.disableProfilePhoto&&t.response.ok)try{let e=await t.response.clone().arrayBuffer();r.picture=`data:image/jpeg;base64, ${eA.base64.encode(e)}`}catch(e){e5.i.error(e&&"object"==typeof e&&"name"in e?e.name:"",e)}}});let i=await e.mapProfileToUser?.(r),a=void 0!==r.email_verified?r.email_verified:!!(r.email&&(r.verified_primary_email?.includes(r.email)||r.verified_secondary_email?.includes(r.email)));return{user:{id:r.sub,name:r.name,email:r.email,image:r.picture,emailVerified:a,...i},data:r}},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>{let r=e.disableDefaultScope?[]:["openid","profile","email","User.Read","offline_access"];return e.scope&&r.push(...e.scope),tT({refreshToken:t,options:{clientId:e.clientId,clientSecret:e.clientSecret},extraParams:{scope:r.join(" ")},tokenEndpoint:i})},options:e}},google:e=>({id:"google",name:"Google",async createAuthorizationURL({state:t,scopes:r,codeVerifier:o,redirectURI:i,loginHint:a,display:n}){if(!e.clientId||!e.clientSecret)throw e5.i.error("Client Id and Client Secret is required for Google. Make sure to provide them in the options."),new t_.t("CLIENT_ID_AND_SECRET_REQUIRED");if(!o)throw new t_.t("codeVerifier is required for Google");let s=e.disableDefaultScope?[]:["email","profile","openid"];return e.scope&&s.push(...e.scope),r&&s.push(...r),await tE({id:"google",options:e,authorizationEndpoint:"https://accounts.google.com/o/oauth2/auth",scopes:s,state:t,codeVerifier:o,redirectURI:i,prompt:e.prompt,accessType:e.accessType,display:n||e.display,loginHint:a,hd:e.hd,additionalParams:{include_granted_scopes:"true"}})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:o})=>tI({code:t,codeVerifier:r,redirectURI:o,options:e,tokenEndpoint:"https://oauth2.googleapis.com/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://www.googleapis.com/oauth2/v4/token"}),async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);let{data:o}=await tw(`https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=${t}`);return!!o&&o.aud===e.clientId&&("https://accounts.google.com"===o.iss||"accounts.google.com"===o.iss)},async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.idToken)return null;let r=t$(t.idToken),o=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.name,email:r.email,image:r.picture,emailVerified:r.email_verified,...o},data:r}},options:e}),huggingface:e=>({id:"huggingface",name:"Hugging Face",createAuthorizationURL({state:t,scopes:r,codeVerifier:o,redirectURI:i}){let a=e.disableDefaultScope?[]:["openid","profile","email"];return e.scope&&a.push(...e.scope),r&&a.push(...r),tE({id:"huggingface",options:e,authorizationEndpoint:"https://huggingface.co/oauth/authorize",scopes:a,state:t,codeVerifier:o,redirectURI:i})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:o})=>tI({code:t,codeVerifier:r,redirectURI:o,options:e,tokenEndpoint:"https://huggingface.co/oauth/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://huggingface.co/oauth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:o}=await tw("https://huggingface.co/oauth/userinfo",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(o)return null;let i=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.name||r.preferred_username,email:r.email,image:r.picture,emailVerified:r.email_verified??!1,...i},data:r}},options:e}),slack:e=>({id:"slack",name:"Slack",createAuthorizationURL({state:t,scopes:r,redirectURI:o}){let i=e.disableDefaultScope?[]:["openid","profile","email"];r&&i.push(...r),e.scope&&i.push(...e.scope);let a=new URL("https://slack.com/openid/connect/authorize");return a.searchParams.set("scope",i.join(" ")),a.searchParams.set("response_type","code"),a.searchParams.set("client_id",e.clientId),a.searchParams.set("redirect_uri",e.redirectURI||o),a.searchParams.set("state",t),a},validateAuthorizationCode:async({code:t,redirectURI:r})=>tI({code:t,redirectURI:r,options:e,tokenEndpoint:"https://slack.com/api/openid.connect.token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://slack.com/api/openid.connect.token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:o}=await tw("https://slack.com/api/openid.connect.userInfo",{headers:{authorization:`Bearer ${t.accessToken}`}});if(o)return null;let i=await e.mapProfileToUser?.(r);return{user:{id:r["https://slack.com/user_id"],name:r.name||"",email:r.email,emailVerified:r.email_verified,image:r.picture||r["https://slack.com/user_image_512"],...i},data:r}},options:e}),spotify:e=>({id:"spotify",name:"Spotify",createAuthorizationURL({state:t,scopes:r,codeVerifier:o,redirectURI:i}){let a=e.disableDefaultScope?[]:["user-read-email"];return e.scope&&a.push(...e.scope),r&&a.push(...r),tE({id:"spotify",options:e,authorizationEndpoint:"https://accounts.spotify.com/authorize",scopes:a,state:t,codeVerifier:o,redirectURI:i})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:o})=>tI({code:t,codeVerifier:r,redirectURI:o,options:e,tokenEndpoint:"https://accounts.spotify.com/api/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://accounts.spotify.com/api/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:o}=await tw("https://api.spotify.com/v1/me",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(o)return null;let i=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.display_name,email:r.email,image:r.images[0]?.url,emailVerified:!1,...i},data:r}},options:e}),twitch:e=>({id:"twitch",name:"Twitch",createAuthorizationURL({state:t,scopes:r,redirectURI:o}){let i=e.disableDefaultScope?[]:["user:read:email","openid"];return e.scope&&i.push(...e.scope),r&&i.push(...r),tE({id:"twitch",redirectURI:o,options:e,authorizationEndpoint:"https://id.twitch.tv/oauth2/authorize",scopes:i,state:t,claims:e.claims||["email","email_verified","preferred_username","picture"]})},validateAuthorizationCode:async({code:t,redirectURI:r})=>tI({code:t,redirectURI:r,options:e,tokenEndpoint:"https://id.twitch.tv/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://id.twitch.tv/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let r=t.idToken;if(!r)return e5.i.error("No idToken found in token"),null;let o=t$(r),i=await e.mapProfileToUser?.(o);return{user:{id:o.sub,name:o.preferred_username,email:o.email,image:o.picture,emailVerified:o.email_verified,...i},data:o}},options:e}),twitter:e=>({id:"twitter",name:"Twitter",createAuthorizationURL(t){let r=e.disableDefaultScope?[]:["users.read","tweet.read","offline.access","users.email"];return e.scope&&r.push(...e.scope),t.scopes&&r.push(...t.scopes),tE({id:"twitter",options:e,authorizationEndpoint:"https://x.com/i/oauth2/authorize",scopes:r,state:t.state,codeVerifier:t.codeVerifier,redirectURI:t.redirectURI})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:o})=>tI({code:t,codeVerifier:r,authentication:"basic",redirectURI:o,options:e,tokenEndpoint:"https://api.x.com/2/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},authentication:"basic",tokenEndpoint:"https://api.x.com/2/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:o}=await tw("https://api.x.com/2/users/me?user.fields=profile_image_url",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(o)return null;let{data:i,error:a}=await tw("https://api.x.com/2/users/me?user.fields=confirmed_email",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}}),n=!1;!a&&i?.data?.confirmed_email&&(r.data.email=i.data.confirmed_email,n=!0);let s=await e.mapProfileToUser?.(r);return{user:{id:r.data.id,name:r.data.name,email:r.data.email||r.data.username||null,image:r.data.profile_image_url,emailVerified:n,...s},data:r}},options:e}),dropbox:e=>({id:"dropbox",name:"Dropbox",createAuthorizationURL:async({state:t,scopes:r,codeVerifier:o,redirectURI:i})=>{let a=e.disableDefaultScope?[]:["account_info.read"];e.scope&&a.push(...e.scope),r&&a.push(...r);let n={};return e.accessType&&(n.token_access_type=e.accessType),await tE({id:"dropbox",options:e,authorizationEndpoint:"https://www.dropbox.com/oauth2/authorize",scopes:a,state:t,redirectURI:i,codeVerifier:o,additionalParams:n})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:o})=>await tI({code:t,codeVerifier:r,redirectURI:o,options:e,tokenEndpoint:"https://api.dropboxapi.com/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://api.dropbox.com/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:o}=await tw("https://api.dropboxapi.com/2/users/get_current_account",{method:"POST",headers:{Authorization:`Bearer ${t.accessToken}`}});if(o)return null;let i=await e.mapProfileToUser?.(r);return{user:{id:r.account_id,name:r.name?.display_name,email:r.email,emailVerified:r.email_verified||!1,image:r.profile_photo_url,...i},data:r}},options:e}),kick:e=>({id:"kick",name:"Kick",createAuthorizationURL({state:t,scopes:r,redirectURI:o,codeVerifier:i}){let a=e.disableDefaultScope?[]:["user:read"];return e.scope&&a.push(...e.scope),r&&a.push(...r),tE({id:"kick",redirectURI:o,options:e,authorizationEndpoint:"https://id.kick.com/oauth/authorize",scopes:a,codeVerifier:i,state:t})},validateAuthorizationCode:async({code:t,redirectURI:r,codeVerifier:o})=>tI({code:t,redirectURI:r,options:e,tokenEndpoint:"https://id.kick.com/oauth/token",codeVerifier:o}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:o}=await tw("https://api.kick.com/public/v1/users",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(o)return null;let i=r.data[0],a=await e.mapProfileToUser?.(i);return{user:{id:i.user_id,name:i.name,email:i.email,image:i.profile_picture,emailVerified:!1,...a},data:i}},options:e}),linear:e=>{let t="https://api.linear.app/oauth/token";return{id:"linear",name:"Linear",createAuthorizationURL({state:t,scopes:r,loginHint:o,redirectURI:i}){let a=e.disableDefaultScope?[]:["read"];return e.scope&&a.push(...e.scope),r&&a.push(...r),tE({id:"linear",options:e,authorizationEndpoint:"https://linear.app/oauth/authorize",scopes:a,state:t,redirectURI:i,loginHint:o})},validateAuthorizationCode:async({code:r,redirectURI:o})=>tI({code:r,redirectURI:o,options:e,tokenEndpoint:t}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async r=>tT({refreshToken:r,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:t}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:o}=await tw("https://api.linear.app/graphql",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.accessToken}`},body:JSON.stringify({query:`
							query {
								viewer {
									id
									name
									email
									avatarUrl
									active
									createdAt
									updatedAt
								}
							}
						`})});if(o||!r?.data?.viewer)return null;let i=r.data.viewer,a=await e.mapProfileToUser?.(i);return{user:{id:r.data.viewer.id,name:r.data.viewer.name,email:r.data.viewer.email,image:r.data.viewer.avatarUrl,emailVerified:!1,...a},data:i}},options:e}},linkedin:e=>{let t="https://www.linkedin.com/oauth/v2/accessToken";return{id:"linkedin",name:"Linkedin",createAuthorizationURL:async({state:t,scopes:r,redirectURI:o,loginHint:i})=>{let a=e.disableDefaultScope?[]:["profile","email","openid"];return e.scope&&a.push(...e.scope),r&&a.push(...r),await tE({id:"linkedin",options:e,authorizationEndpoint:"https://www.linkedin.com/oauth/v2/authorization",scopes:a,state:t,loginHint:i,redirectURI:o})},validateAuthorizationCode:async({code:r,redirectURI:o})=>await tI({code:r,redirectURI:o,options:e,tokenEndpoint:t}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async r=>tT({refreshToken:r,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:t}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:o}=await tw("https://api.linkedin.com/v2/userinfo",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(o)return null;let i=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.name,email:r.email,emailVerified:r.email_verified||!1,image:r.picture,...i},data:r}},options:e}},gitlab:e=>{let t,{authorizationEndpoint:r,tokenEndpoint:o,userinfoEndpoint:i}=(t=e.issuer||"https://gitlab.com",{authorizationEndpoint:tz(`${t}/oauth/authorize`),tokenEndpoint:tz(`${t}/oauth/token`),userinfoEndpoint:tz(`${t}/api/v4/user`)}),a="gitlab";return{id:a,name:"Gitlab",createAuthorizationURL:async({state:t,scopes:o,codeVerifier:i,loginHint:n,redirectURI:s})=>{let c=e.disableDefaultScope?[]:["read_user"];return e.scope&&c.push(...e.scope),o&&c.push(...o),await tE({id:a,options:e,authorizationEndpoint:r,scopes:c,state:t,redirectURI:s,codeVerifier:i,loginHint:n})},validateAuthorizationCode:async({code:t,redirectURI:r,codeVerifier:i})=>tI({code:t,redirectURI:r,options:e,codeVerifier:i,tokenEndpoint:o}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:o}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:o}=await tw(i,{headers:{authorization:`Bearer ${t.accessToken}`}});if(o||"active"!==r.state||r.locked)return null;let a=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.name??r.username,email:r.email,image:r.avatar_url,emailVerified:r.email_verified??!1,...a},data:r}},options:e}},tiktok:e=>({id:"tiktok",name:"TikTok",createAuthorizationURL({state:t,scopes:r,redirectURI:o}){let i=e.disableDefaultScope?[]:["user.info.profile"];return e.scope&&i.push(...e.scope),r&&i.push(...r),new URL(`https://www.tiktok.com/v2/auth/authorize?scope=${i.join(",")}&response_type=code&client_key=${e.clientKey}&redirect_uri=${encodeURIComponent(e.redirectURI||o)}&state=${t}`)},validateAuthorizationCode:async({code:t,redirectURI:r})=>tI({code:t,redirectURI:e.redirectURI||r,options:{clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://open.tiktokapis.com/v2/oauth/token/"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientSecret:e.clientSecret},tokenEndpoint:"https://open.tiktokapis.com/v2/oauth/token/",authentication:"post",extraParams:{client_key:e.clientKey}}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:o}=await tw("https://open.tiktokapis.com/v2/user/info/?fields=open_id,avatar_large_url,display_name,username",{headers:{authorization:`Bearer ${t.accessToken}`}});return o?null:{user:{email:r.data.user.email||r.data.user.username,id:r.data.user.open_id,name:r.data.user.display_name||r.data.user.username,image:r.data.user.avatar_large_url,emailVerified:!!r.data.user.email},data:r}},options:e}),reddit:e=>({id:"reddit",name:"Reddit",createAuthorizationURL({state:t,scopes:r,redirectURI:o}){let i=e.disableDefaultScope?[]:["identity"];return e.scope&&i.push(...e.scope),r&&i.push(...r),tE({id:"reddit",options:e,authorizationEndpoint:"https://www.reddit.com/api/v1/authorize",scopes:i,state:t,redirectURI:o,duration:e.duration})},validateAuthorizationCode:async({code:t,redirectURI:r})=>{let o=new URLSearchParams({grant_type:"authorization_code",code:t,redirect_uri:e.redirectURI||r}),{data:i,error:a}=await tw("https://www.reddit.com/api/v1/access_token",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded",accept:"text/plain","user-agent":"better-auth",Authorization:`Basic ${eA.base64.encode(`${e.clientId}:${e.clientSecret}`)}`},body:o.toString()});if(a)throw a;return ty(i)},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},authentication:"basic",tokenEndpoint:"https://www.reddit.com/api/v1/access_token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:o}=await tw("https://oauth.reddit.com/api/v1/me",{headers:{Authorization:`Bearer ${t.accessToken}`,"User-Agent":"better-auth"}});if(o)return null;let i=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.name,email:r.oauth_client_id,emailVerified:r.has_verified_email,image:r.icon_img?.split("?")[0],...i},data:r}},options:e}),roblox:e=>({id:"roblox",name:"Roblox",createAuthorizationURL({state:t,scopes:r,redirectURI:o}){let i=e.disableDefaultScope?[]:["openid","profile"];return e.scope&&i.push(...e.scope),r&&i.push(...r),new URL(`https://apis.roblox.com/oauth/v1/authorize?scope=${i.join("+")}&response_type=code&client_id=${e.clientId}&redirect_uri=${encodeURIComponent(e.redirectURI||o)}&state=${t}&prompt=${e.prompt||"select_account consent"}`)},validateAuthorizationCode:async({code:t,redirectURI:r})=>tI({code:t,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://apis.roblox.com/oauth/v1/token",authentication:"post"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://apis.roblox.com/oauth/v1/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:o}=await tw("https://apis.roblox.com/oauth/v1/userinfo",{headers:{authorization:`Bearer ${t.accessToken}`}});if(o)return null;let i=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.nickname||r.preferred_username||"",image:r.picture,email:r.preferred_username||null,emailVerified:!1,...i},data:{...r}}},options:e}),salesforce:e=>{let t=(e.environment??"production")==="sandbox",r=e.loginUrl?`https://${e.loginUrl}/services/oauth2/authorize`:t?"https://test.salesforce.com/services/oauth2/authorize":"https://login.salesforce.com/services/oauth2/authorize",o=e.loginUrl?`https://${e.loginUrl}/services/oauth2/token`:t?"https://test.salesforce.com/services/oauth2/token":"https://login.salesforce.com/services/oauth2/token",i=e.loginUrl?`https://${e.loginUrl}/services/oauth2/userinfo`:t?"https://test.salesforce.com/services/oauth2/userinfo":"https://login.salesforce.com/services/oauth2/userinfo";return{id:"salesforce",name:"Salesforce",async createAuthorizationURL({state:t,scopes:o,codeVerifier:i,redirectURI:a}){if(!e.clientId||!e.clientSecret)throw e5.i.error("Client Id and Client Secret are required for Salesforce. Make sure to provide them in the options."),new t_.t("CLIENT_ID_AND_SECRET_REQUIRED");if(!i)throw new t_.t("codeVerifier is required for Salesforce");let n=e.disableDefaultScope?[]:["openid","email","profile"];return e.scope&&n.push(...e.scope),o&&n.push(...o),tE({id:"salesforce",options:e,authorizationEndpoint:r,scopes:n,state:t,codeVerifier:i,redirectURI:e.redirectURI||a})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:i})=>tI({code:t,codeVerifier:r,redirectURI:e.redirectURI||i,options:e,tokenEndpoint:o}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientSecret:e.clientSecret},tokenEndpoint:o}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);try{let{data:r}=await tw(i,{headers:{Authorization:`Bearer ${t.accessToken}`}});if(!r)return e5.i.error("Failed to fetch user info from Salesforce"),null;let o=await e.mapProfileToUser?.(r);return{user:{id:r.user_id,name:r.name,email:r.email,image:r.photos?.picture||r.photos?.thumbnail,emailVerified:r.email_verified??!1,...o},data:r}}catch(e){return e5.i.error("Failed to fetch user info from Salesforce:",e),null}},options:e}},vk:e=>({id:"vk",name:"VK",async createAuthorizationURL({state:t,scopes:r,codeVerifier:o,redirectURI:i}){let a=e.disableDefaultScope?[]:["email","phone"];return e.scope&&a.push(...e.scope),r&&a.push(...r),tE({id:"vk",options:e,authorizationEndpoint:"https://id.vk.com/authorize",scopes:a,state:t,redirectURI:i,codeVerifier:o})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:o,deviceId:i})=>tI({code:t,codeVerifier:r,redirectURI:e.redirectURI||o,options:e,deviceId:i,tokenEndpoint:"https://id.vk.com/oauth2/auth"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://id.vk.com/oauth2/auth"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.accessToken)return null;let r=new URLSearchParams({access_token:t.accessToken,client_id:e.clientId}).toString(),{data:o,error:i}=await tw("https://id.vk.com/oauth2/user_info",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r});if(i)return null;let a=await e.mapProfileToUser?.(o);return o.user.email||a?.email?{user:{id:o.user.user_id,first_name:o.user.first_name,last_name:o.user.last_name,email:o.user.email,image:o.user.avatar,emailVerified:!!o.user.email,birthday:o.user.birthday,sex:o.user.sex,name:`${o.user.first_name} ${o.user.last_name}`,...a},data:o}:null},options:e}),zoom:e=>{let t={pkce:!0,...e};return{id:"zoom",name:"Zoom",createAuthorizationURL:async({state:e,redirectURI:r,codeVerifier:o})=>{let i=new URLSearchParams({response_type:"code",redirect_uri:t.redirectURI?t.redirectURI:r,client_id:t.clientId,state:e});if(t.pkce){let e=await tA(o);i.set("code_challenge_method","S256"),i.set("code_challenge",e)}let a=new URL("https://zoom.us/oauth/authorize");return a.search=i.toString(),a},validateAuthorizationCode:async({code:e,redirectURI:r,codeVerifier:o})=>tI({code:e,redirectURI:t.redirectURI||r,codeVerifier:o,options:t,tokenEndpoint:"https://zoom.us/oauth/token",authentication:"post"}),refreshAccessToken:t.refreshAccessToken?t.refreshAccessToken:async e=>tT({refreshToken:e,options:{clientId:t.clientId,clientKey:t.clientKey,clientSecret:t.clientSecret},tokenEndpoint:"https://zoom.us/oauth/token"}),async getUserInfo(e){if(t.getUserInfo)return t.getUserInfo(e);let{data:r,error:o}=await tw("https://api.zoom.us/v2/users/me",{headers:{authorization:`Bearer ${e.accessToken}`}});if(o)return null;let i=await t.mapProfileToUser?.(r);return{user:{id:r.id,name:r.display_name,image:r.pic_url,email:r.email,emailVerified:!!r.verified,...i},data:{...r}}}}},notion:e=>{let t="https://api.notion.com/v1/oauth/token";return{id:"notion",name:"Notion",createAuthorizationURL({state:t,scopes:r,loginHint:o,redirectURI:i}){let a=(e.disableDefaultScope,[]);return e.scope&&a.push(...e.scope),r&&a.push(...r),tE({id:"notion",options:e,authorizationEndpoint:"https://api.notion.com/v1/oauth/authorize",scopes:a,state:t,redirectURI:i,loginHint:o,additionalParams:{owner:"user"}})},validateAuthorizationCode:async({code:r,redirectURI:o})=>tI({code:r,redirectURI:o,options:e,tokenEndpoint:t,authentication:"basic"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async r=>tT({refreshToken:r,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:t}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:o}=await tw("https://api.notion.com/v1/users/me",{headers:{Authorization:`Bearer ${t.accessToken}`,"Notion-Version":"2022-06-28"}});if(o||!r)return null;let i=r.bot?.owner?.user;if(!i)return null;let a=await e.mapProfileToUser?.(i);return{user:{id:i.id,name:i.name||"Notion User",email:i.person?.email||null,image:i.avatar_url,emailVerified:!!i.person?.email,...a},data:i}},options:e}},kakao:e=>({id:"kakao",name:"Kakao",createAuthorizationURL({state:t,scopes:r,redirectURI:o}){let i=e.disableDefaultScope?[]:["account_email","profile_image","profile_nickname"];return e.scope&&i.push(...e.scope),r&&i.push(...r),tE({id:"kakao",options:e,authorizationEndpoint:"https://kauth.kakao.com/oauth/authorize",scopes:i,state:t,redirectURI:o})},validateAuthorizationCode:async({code:t,redirectURI:r})=>tI({code:t,redirectURI:r,options:e,tokenEndpoint:"https://kauth.kakao.com/oauth/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://kauth.kakao.com/oauth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:o}=await tw("https://kapi.kakao.com/v2/user/me",{headers:{Authorization:`Bearer ${t.accessToken}`}});if(o||!r)return null;let i=await e.mapProfileToUser?.(r),a=r.kakao_account||{},n=a.profile||{};return{user:{id:String(r.id),name:n.nickname||a.name||void 0,email:a.email,image:n.profile_image_url||n.thumbnail_image_url,emailVerified:!!a.is_email_valid&&!!a.is_email_verified,...i},data:r}},options:e}),naver:e=>({id:"naver",name:"Naver",createAuthorizationURL({state:t,scopes:r,redirectURI:o}){let i=e.disableDefaultScope?[]:["profile","email"];return e.scope&&i.push(...e.scope),r&&i.push(...r),tE({id:"naver",options:e,authorizationEndpoint:"https://nid.naver.com/oauth2.0/authorize",scopes:i,state:t,redirectURI:o})},validateAuthorizationCode:async({code:t,redirectURI:r})=>tI({code:t,redirectURI:r,options:e,tokenEndpoint:"https://nid.naver.com/oauth2.0/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://nid.naver.com/oauth2.0/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:o}=await tw("https://openapi.naver.com/v1/nid/me",{headers:{Authorization:`Bearer ${t.accessToken}`}});if(o||!r||"00"!==r.resultcode)return null;let i=await e.mapProfileToUser?.(r),a=r.response||{};return{user:{id:a.id,name:a.name||a.nickname,email:a.email,image:a.profile_image,emailVerified:!1,...i},data:r}},options:e}),line:e=>{let t="https://api.line.me/oauth2/v2.1/token";return{id:"line",name:"LINE",async createAuthorizationURL({state:t,scopes:r,codeVerifier:o,redirectURI:i,loginHint:a}){let n=e.disableDefaultScope?[]:["openid","profile","email"];return e.scope&&n.push(...e.scope),r&&n.push(...r),await tE({id:"line",options:e,authorizationEndpoint:"https://access.line.me/oauth2/v2.1/authorize",scopes:n,state:t,codeVerifier:o,redirectURI:i,loginHint:a})},validateAuthorizationCode:async({code:r,codeVerifier:o,redirectURI:i})=>tI({code:r,codeVerifier:o,redirectURI:i,options:e,tokenEndpoint:t}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async r=>tT({refreshToken:r,options:{clientId:e.clientId,clientSecret:e.clientSecret},tokenEndpoint:t}),async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);let o=new URLSearchParams;o.set("id_token",t),o.set("client_id",e.clientId),r&&o.set("nonce",r);let{data:i,error:a}=await tw("https://api.line.me/oauth2/v2.1/verify",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:o});return!a&&!!i&&i.aud===e.clientId&&(!r||!i.nonce||i.nonce===r)},async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let r=null;if(t.idToken)try{r=t$(t.idToken)}catch{}if(!r){let{data:e}=await tw("https://api.line.me/oauth2/v2.1/userinfo",{headers:{authorization:`Bearer ${t.accessToken}`}});r=e||null}if(!r)return null;let o=await e.mapProfileToUser?.(r),i=r.sub||r.userId,a=r.name||r.displayName,n=r.picture||r.pictureUrl||void 0;return{user:{id:i,name:a,email:r.email,image:n,emailVerified:!1,...o},data:r}},options:e}},paybin:e=>{let t=e.issuer||"https://idp.paybin.io",r=`${t}/oauth2/authorize`,o=`${t}/oauth2/token`;return{id:"paybin",name:"Paybin",async createAuthorizationURL({state:t,scopes:o,codeVerifier:i,redirectURI:a,loginHint:n}){if(!e.clientId||!e.clientSecret)throw e5.i.error("Client Id and Client Secret is required for Paybin. Make sure to provide them in the options."),new t_.t("CLIENT_ID_AND_SECRET_REQUIRED");if(!i)throw new t_.t("codeVerifier is required for Paybin");let s=e.disableDefaultScope?[]:["openid","email","profile"];return e.scope&&s.push(...e.scope),o&&s.push(...o),await tE({id:"paybin",options:e,authorizationEndpoint:r,scopes:s,state:t,codeVerifier:i,redirectURI:a,prompt:e.prompt,loginHint:n})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:i})=>tI({code:t,codeVerifier:r,redirectURI:i,options:e,tokenEndpoint:o}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:o}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.idToken)return null;let r=t$(t.idToken),o=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.name||r.preferred_username||(r.email?r.email.split("@")[0]:"User")||"User",email:r.email,image:r.picture,emailVerified:r.email_verified||!1,...o},data:r}},options:e}},paypal:e=>{let t="sandbox"===(e.environment||"sandbox"),r=t?"https://www.sandbox.paypal.com/signin/authorize":"https://www.paypal.com/signin/authorize",o=t?"https://api-m.sandbox.paypal.com/v1/oauth2/token":"https://api-m.paypal.com/v1/oauth2/token",i=t?"https://api-m.sandbox.paypal.com/v1/identity/oauth2/userinfo":"https://api-m.paypal.com/v1/identity/oauth2/userinfo";return{id:"paypal",name:"PayPal",async createAuthorizationURL({state:t,codeVerifier:o,redirectURI:i}){if(!e.clientId||!e.clientSecret)throw e5.i.error("Client Id and Client Secret is required for PayPal. Make sure to provide them in the options."),new t_.t("CLIENT_ID_AND_SECRET_REQUIRED");return await tE({id:"paypal",options:e,authorizationEndpoint:r,scopes:[],state:t,codeVerifier:o,redirectURI:i,prompt:e.prompt})},validateAuthorizationCode:async({code:t,redirectURI:r})=>{let i=eA.base64.encode(`${e.clientId}:${e.clientSecret}`);try{let e=await tw(o,{method:"POST",headers:{Authorization:`Basic ${i}`,Accept:"application/json","Accept-Language":"en_US","Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",code:t,redirect_uri:r}).toString()});if(!e.data)throw new t_.t("FAILED_TO_GET_ACCESS_TOKEN");let a=e.data;return{accessToken:a.access_token,refreshToken:a.refresh_token,accessTokenExpiresAt:a.expires_in?new Date(Date.now()+1e3*a.expires_in):void 0,idToken:a.id_token}}catch(e){throw e5.i.error("PayPal token exchange failed:",e),new t_.t("FAILED_TO_GET_ACCESS_TOKEN")}},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>{let r=eA.base64.encode(`${e.clientId}:${e.clientSecret}`);try{let e=await tw(o,{method:"POST",headers:{Authorization:`Basic ${r}`,Accept:"application/json","Accept-Language":"en_US","Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:t}).toString()});if(!e.data)throw new t_.t("FAILED_TO_REFRESH_ACCESS_TOKEN");let i=e.data;return{accessToken:i.access_token,refreshToken:i.refresh_token,accessTokenExpiresAt:i.expires_in?new Date(Date.now()+1e3*i.expires_in):void 0}}catch(e){throw e5.i.error("PayPal token refresh failed:",e),new t_.t("FAILED_TO_REFRESH_ACCESS_TOKEN")}},async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);try{return!!t$(t).sub}catch(e){return e5.i.error("Failed to verify PayPal ID token:",e),!1}},async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.accessToken)return e5.i.error("Access token is required to fetch PayPal user info"),null;try{let r=await tw(`${i}?schema=paypalv1.1`,{headers:{Authorization:`Bearer ${t.accessToken}`,Accept:"application/json"}});if(!r.data)return e5.i.error("Failed to fetch user info from PayPal"),null;let o=r.data,a=await e.mapProfileToUser?.(o);return{user:{id:o.user_id,name:o.name,email:o.email,image:o.picture,emailVerified:o.email_verified,...a},data:o}}catch(e){return e5.i.error("Failed to fetch user info from PayPal:",e),null}},options:e}},polar:e=>({id:"polar",name:"Polar",createAuthorizationURL({state:t,scopes:r,codeVerifier:o,redirectURI:i}){let a=e.disableDefaultScope?[]:["openid","profile","email"];return e.scope&&a.push(...e.scope),r&&a.push(...r),tE({id:"polar",options:e,authorizationEndpoint:"https://polar.sh/oauth2/authorize",scopes:a,state:t,codeVerifier:o,redirectURI:i,prompt:e.prompt})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:o})=>tI({code:t,codeVerifier:r,redirectURI:o,options:e,tokenEndpoint:"https://api.polar.sh/v1/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>tT({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://api.polar.sh/v1/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:o}=await tw("https://api.polar.sh/v1/oauth2/userinfo",{headers:{Authorization:`Bearer ${t.accessToken}`}});if(o)return null;let i=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.public_name||r.username,email:r.email,image:r.avatar_url,emailVerified:r.email_verified??!1,...i},data:r}},options:e}),vercel:e=>({id:"vercel",name:"Vercel",createAuthorizationURL({state:t,scopes:r,codeVerifier:o,redirectURI:i}){let a;if(!o)throw new t_.t("codeVerifier is required for Vercel");return(void 0!==e.scope||void 0!==r)&&(a=[],e.scope&&a.push(...e.scope),r&&a.push(...r)),tE({id:"vercel",options:e,authorizationEndpoint:"https://vercel.com/oauth/authorize",scopes:a,state:t,codeVerifier:o,redirectURI:i})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:o})=>tI({code:t,codeVerifier:r,redirectURI:o,options:e,tokenEndpoint:"https://api.vercel.com/login/oauth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:o}=await tw("https://api.vercel.com/login/oauth/userinfo",{headers:{Authorization:`Bearer ${t.accessToken}`}});if(o||!r)return null;let i=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.name??r.preferred_username,email:r.email,image:r.picture,emailVerified:r.email_verified??!1,...i},data:r}},options:e})},tF=Object.keys(tB),tH=Y.enum(tF).or(Y.string());function tZ(e){if(null===e||"object"!=typeof e)return!1;let t=Object.getPrototypeOf(e);return(null===t||t===Object.prototype||null===Object.getPrototypeOf(t))&&!(Symbol.iterator in e)&&(!(Symbol.toStringTag in e)||"[object Module]"===Object.prototype.toString.call(e))}function tW(e){return(...t)=>t.reduce((t,r)=>(function e(t,r,o=".",i){if(!tZ(r))return e(t,{},o,i);let a=Object.assign({},r);for(let r in t){if("__proto__"===r||"constructor"===r)continue;let n=t[r];null!=n&&(i&&i(a,r,n,o)||(Array.isArray(n)&&Array.isArray(a[r])?a[r]=[...n,...a[r]]:tZ(n)&&tZ(a[r])?a[r]=e(n,a[r],(o?`${o}.`:"")+r.toString(),i):a[r]=n))}return a})(t,r,"",e),{})}let tY=tW();function tK(e){return"-"===e||"^"===e||"$"===e||"+"===e||"."===e||"("===e||")"===e||"|"===e||"["===e||"]"===e||"{"===e||"}"===e||"*"===e||"?"===e||"\\"===e?`\\${e}`:e}function tG(e,t){if("string"!=typeof t)throw TypeError(`Sample must be a string, but ${typeof t} given`);return e.test(t)}function tQ(e,t){if("string"!=typeof e&&!Array.isArray(e))throw TypeError(`The first argument must be a single pattern string or an array of patterns, but ${typeof e} given`);if(("string"==typeof t||"boolean"==typeof t)&&(t={separator:t}),2==arguments.length&&!(void 0===t||"object"==typeof t&&null!==t&&!Array.isArray(t)))throw TypeError(`The second argument must be an options object or a string/boolean separator, but ${typeof t} given`);if("\\"===(t=t||{}).separator)throw Error("\\ is not a valid separator because it is used for escaping. Try setting the separator to `true` instead");let r=function e(t,r=!0){if(Array.isArray(t))return`(?:${t.map(t=>`^${e(t,r)}$`).join("|")})`;let o="",i="",a=".";!0===r?(o="/",i="[/\\\\]",a="[^/\\\\]"):r&&((i=function(e){let t="";for(let r=0;r<e.length;r++)t+=tK(e[r]);return t}(o=r)).length>1?(i=`(?:${i})`,a=`((?!${i}).)`):a=`[^${i}]`);let n=r?`${i}+?`:"",s=r?`${i}*?`:"",c=r?t.split(o):[t],l="";for(let e=0;e<c.length;e++){let t=c[e],o=c[e+1],i="";if(t||!(e>0)){if(r&&(i=e===c.length-1?s:"**"!==o?n:""),r&&"**"===t){i&&(l+=0===e?"":i,l+=`(?:${a}*?${i})*?`);continue}for(let e=0;e<t.length;e++){let r=t[e];"\\"===r?e<t.length-1&&(l+=tK(t[e+1]),e++):"?"===r?l+=a:"*"===r?l+=`${a}*?`:l+=tK(r)}l+=i}}return l}(e,t.separator),o=RegExp(`^${r}$`,t.flags),i=tG.bind(null,o);return i.options=t,i.pattern=e,i.regexp=o,i}tW((e,t,r)=>{if(void 0!==e[t]&&"function"==typeof r)return e[t]=r(e[t]),!0}),tW((e,t,r)=>{if(Array.isArray(e[t])&&"function"==typeof r)return e[t]=r(e[t]),!0});let tJ=eB(async e=>{if(e.request?.method==="GET"||e.request?.method==="OPTIONS"||e.request?.method==="HEAD"||!e.request)return;let t=e.request?.headers,r=e.request,{body:o,query:i,context:a}=e,n=t?.get("origin")||t?.get("referer")||"",s=o?.callbackURL||i?.callbackURL,c=o?.redirectTo,l=o?.errorCallbackURL,d=o?.newUserCallbackURL,u=Array.isArray(a.options.trustedOrigins)?a.trustedOrigins:[...a.trustedOrigins,...await a.options.trustedOrigins?.(r)||[]],p=t?.has("cookie"),f=(t,r)=>{if(t&&!u.some(e=>((e,t)=>{if(e.startsWith("/"))return!1;if(t.includes("*")){if(t.includes("://"))return tQ(t)(em(e)||e);let r=eg(e);return!!r&&tQ(t)(r)}let r=eh(e);return"http:"!==r&&"https:"!==r&&r?e.startsWith(t):t===em(e)})(t,e)||t?.startsWith("/")&&"origin"!==r&&/^\/(?!\/|\\|%2f|%5c)[\w\-.\+/@]*(?:\?[\w\-.\+/=&%@]*)?$/.test(t)))throw e.context.logger.error(`Invalid ${r}: ${t}`),e.context.logger.info(`If it's a valid URL, please add ${t} to trustedOrigins in your auth config
`,`Current list of trustedOrigins: ${u}`),new j.APIError("FORBIDDEN",{message:`Invalid ${r}`})};if(p&&!e.context.skipCSRFCheck&&!e.context.skipOriginCheck){if(!n||"null"===n)throw new j.APIError("FORBIDDEN",{message:"Missing or null Origin"});f(n,"origin")}s&&f(s,"callbackURL"),c&&f(c,"redirectURL"),l&&f(l,"errorCallbackURL"),d&&f(d,"newUserCallbackURL")}),tX=e=>eB(async t=>{if(!t.request)return;let{context:r}=t,o=e(t),i=Array.isArray(r.options.trustedOrigins)?r.trustedOrigins:[...r.trustedOrigins,...await r.options.trustedOrigins?.(t.request)||[]],a=(e,r)=>{if(e&&!i.some(t=>((e,t)=>{if(e.startsWith("/"))return!1;if(t.includes("*")){if(t.includes("://"))return tQ(t)(em(e)||e);let r=eg(e);return!!r&&tQ(t)(r)}let r=eh(e);return"http:"!==r&&"https:"!==r&&r?e.startsWith(t):t===em(e)})(e,t)||e?.startsWith("/")&&"origin"!==r&&/^\/(?!\/|\\|%2f|%5c)[\w\-.\+/@]*(?:\?[\w\-.\+/=&%@]*)?$/.test(e)))throw t.context.logger.error(`Invalid ${r}: ${e}`),t.context.logger.info(`If it's a valid URL, please add ${e} to trustedOrigins in your auth config
`,`Current list of trustedOrigins: ${i}`),new j.APIError("FORBIDDEN",{message:`Invalid ${r}`})};for(let e of Array.isArray(o)?o:[o])a(e,"callbackURL")}),t0=new Map;async function t1(e,t){if(!t.rateLimit.enabled)return;let r=new URL(e.url).pathname.replace(t.options.basePath||"/api/auth",""),o=t.rateLimit.window,i=t.rateLimit.max,a=K(e,t.options);if(!a)return;let n=a+r,s=[{pathMatcher:e=>e.startsWith("/sign-in")||e.startsWith("/sign-up")||e.startsWith("/change-password")||e.startsWith("/change-email"),window:10,max:3}].find(e=>e.pathMatcher(r));for(let e of(s&&(o=s.window,i=s.max),t.options.plugins||[]))if(e.rateLimit){let t=e.rateLimit.find(e=>e.pathMatcher(r));if(t){o=t.window,i=t.max;break}}if(t.rateLimit.customRules){let a=Object.keys(t.rateLimit.customRules).find(e=>e.includes("*")?tQ(e)(r):e===r);if(a){let r=t.rateLimit.customRules[a],n="function"==typeof r?await r(e):r;if(n&&(o=n.window,i=n.max),!1===n)return}}let c=function(e,t){let r,o;if(e.options.rateLimit?.customStorage)return e.options.rateLimit.customStorage;let i=e.rateLimit.storage;return"secondary-storage"===i?{get:async t=>{let r=await e.options.secondaryStorage?.get(t);return r?(0,G.t)(r):void 0},set:async(r,o,i)=>{let a=t?.window??e.options.rateLimit?.window??10;await e.options.secondaryStorage?.set?.(r,JSON.stringify(o),a)}}:"memory"===i?{get:async e=>t0.get(e),async set(e,t,r){t0.set(e,t)}}:(r="rateLimit",o=e.adapter,{get:async e=>{let t=(await o.findMany({model:r,where:[{field:"key",value:e}]}))[0];return"bigint"==typeof t?.lastRequest&&(t.lastRequest=Number(t.lastRequest)),t},set:async(t,i,a)=>{try{a?await o.updateMany({model:r,where:[{field:"key",value:t}],update:{count:i.count,lastRequest:i.lastRequest}}):await o.create({model:r,data:{key:t,count:i.count,lastRequest:i.lastRequest}})}catch(t){e.logger.error("Error setting rate limit",t)}}})}(t,{window:o}),l=await c.get(n),d=Date.now();if(l){var u,p,f;let e=d-l.lastRequest;if(u=i,p=o,Date.now()-l.lastRequest<1e3*p&&l.count>=u)return f=Math.ceil((l.lastRequest+1e3*o-Date.now())/1e3),new Response(JSON.stringify({message:"Too many requests. Please try again later."}),{status:429,statusText:"Too Many Requests",headers:{"X-Retry-After":f.toString()}});e>1e3*o?await c.set(n,{...l,count:1,lastRequest:d},!0):await c.set(n,{...l,count:l.count+1,lastRequest:d},!0)}else await c.set(n,{key:n,count:1,lastRequest:d})}function t2(e,t){return e&&t.options.account?.encryptOAuthTokens?(0,eu.t)({key:t.secret,data:e}):e}function t6(e,t){return t.options.account?.encryptOAuthTokens&&e?(0,eu.n)({key:t.secret,data:e}):e}let t4=eH("/list-accounts",{method:"GET",use:[eY],metadata:{openapi:{operationId:"listUserAccounts",description:"List all accounts linked to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"array",items:{type:"object",properties:{id:{type:"string"},providerId:{type:"string"},createdAt:{type:"string",format:"date-time"},updatedAt:{type:"string",format:"date-time"},accountId:{type:"string"},userId:{type:"string"},scopes:{type:"array",items:{type:"string"}}},required:["id","providerId","createdAt","updatedAt","accountId","userId","scopes"]}}}}}}}}},async e=>{let t=e.context.session,r=await e.context.internalAdapter.findAccounts(t.user.id);return e.json(r.map(e=>({id:e.id,providerId:e.providerId,createdAt:e.createdAt,updatedAt:e.updatedAt,accountId:e.accountId,userId:e.userId,scopes:e.scope?.split(",")||[]})))}),t5=eH("/link-social",{method:"POST",requireHeaders:!0,body:Y.object({callbackURL:Y.string().meta({description:"The URL to redirect to after the user has signed in"}).optional(),provider:tH,idToken:Y.object({token:Y.string(),nonce:Y.string().optional(),accessToken:Y.string().optional(),refreshToken:Y.string().optional(),scopes:Y.array(Y.string()).optional()}).optional(),requestSignUp:Y.boolean().optional(),scopes:Y.array(Y.string()).meta({description:"Additional scopes to request from the provider"}).optional(),errorCallbackURL:Y.string().meta({description:"The URL to redirect to if there is an error during the link process"}).optional(),disableRedirect:Y.boolean().meta({description:"Disable automatic redirection to the provider. Useful for handling the redirection yourself"}).optional(),additionalData:Y.record(Y.string(),Y.any()).optional()}),use:[eY],metadata:{openapi:{description:"Link a social account to the user",operationId:"linkSocialAccount",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{url:{type:"string",description:"The authorization URL to redirect the user to"},redirect:{type:"boolean",description:"Indicates if the user should be redirected to the authorization URL"},status:{type:"boolean"}},required:["redirect"]}}}}}}}},async e=>{let t=e.context.session,r=e.context.socialProviders.find(t=>t.id===e.body.provider);if(!r)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new j.APIError("NOT_FOUND",{message:eq.n.PROVIDER_NOT_FOUND});if(e.body.idToken){if(!r.verifyIdToken)throw e.context.logger.error("Provider does not support id token verification",{provider:e.body.provider}),new j.APIError("NOT_FOUND",{message:eq.n.ID_TOKEN_NOT_SUPPORTED});let{token:o,nonce:i}=e.body.idToken;if(!await r.verifyIdToken(o,i))throw e.context.logger.error("Invalid id token",{provider:e.body.provider}),new j.APIError("UNAUTHORIZED",{message:eq.n.INVALID_TOKEN});let a=await r.getUserInfo({idToken:o,accessToken:e.body.idToken.accessToken,refreshToken:e.body.idToken.refreshToken});if(!a||!a?.user)throw e.context.logger.error("Failed to get user info",{provider:e.body.provider}),new j.APIError("UNAUTHORIZED",{message:eq.n.FAILED_TO_GET_USER_INFO});let n=String(a.user.id);if(!a.user.email)throw e.context.logger.error("User email not found",{provider:e.body.provider}),new j.APIError("UNAUTHORIZED",{message:eq.n.USER_EMAIL_NOT_FOUND});if((await e.context.internalAdapter.findAccounts(t.user.id)).find(e=>e.providerId===r.id&&e.accountId===n))return e.json({url:"",status:!0,redirect:!1});if(!e.context.options.account?.accountLinking?.trustedProviders?.includes(r.id)&&!a.user.emailVerified||e.context.options.account?.accountLinking?.enabled===!1)throw new j.APIError("UNAUTHORIZED",{message:"Account not linked - linking not allowed"});if(a.user.email!==t.user.email&&e.context.options.account?.accountLinking?.allowDifferentEmails!==!0)throw new j.APIError("UNAUTHORIZED",{message:"Account not linked - different emails not allowed"});try{await e.context.internalAdapter.createAccount({userId:t.user.id,providerId:r.id,accountId:n,accessToken:e.body.idToken.accessToken,idToken:o,refreshToken:e.body.idToken.refreshToken,scope:e.body.idToken.scopes?.join(",")})}catch(e){throw new j.APIError("EXPECTATION_FAILED",{message:"Account not linked - unable to create account"})}if(e.context.options.account?.accountLinking?.updateUserInfoOnLink===!0)try{await e.context.internalAdapter.updateUser(t.user.id,{name:a.user?.name,image:a.user?.image})}catch(e){console.warn("Could not update user - "+e.toString())}return e.json({url:"",status:!0,redirect:!1})}let o=await (0,C.r)(e,{userId:t.user.id,email:t.user.email},e.body.additionalData),i=await r.createAuthorizationURL({state:o.state,codeVerifier:o.codeVerifier,redirectURI:`${e.context.baseURL}/callback/${r.id}`,scopes:e.body.scopes});return e.json({url:i.toString(),redirect:!e.body.disableRedirect})}),t3=eH("/unlink-account",{method:"POST",body:Y.object({providerId:Y.string(),accountId:Y.string().optional()}),use:[eG],metadata:{openapi:{description:"Unlink an account",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{let{providerId:t,accountId:r}=e.body,o=await e.context.internalAdapter.findAccounts(e.context.session.user.id);if(1===o.length&&!e.context.options.account?.accountLinking?.allowUnlinkingAll)throw new j.APIError("BAD_REQUEST",{message:eq.n.FAILED_TO_UNLINK_LAST_ACCOUNT});let i=o.find(e=>r?e.accountId===r&&e.providerId===t:e.providerId===t);if(!i)throw new j.APIError("BAD_REQUEST",{message:eq.n.ACCOUNT_NOT_FOUND});return await e.context.internalAdapter.deleteAccount(i.id),e.json({status:!0})}),t8=eH("/get-access-token",{method:"POST",body:Y.object({providerId:Y.string().meta({description:"The provider ID for the OAuth provider"}),accountId:Y.string().meta({description:"The account ID associated with the refresh token"}).optional(),userId:Y.string().meta({description:"The user ID associated with the account"}).optional()}),metadata:{openapi:{description:"Get a valid access token, doing a refresh if needed",responses:{200:{description:"A Valid access token",content:{"application/json":{schema:{type:"object",properties:{tokenType:{type:"string"},idToken:{type:"string"},accessToken:{type:"string"},refreshToken:{type:"string"},accessTokenExpiresAt:{type:"string",format:"date-time"},refreshTokenExpiresAt:{type:"string",format:"date-time"}}}}}},400:{description:"Invalid refresh token or provider configuration"}}}}},async e=>{let t,{providerId:r,accountId:o,userId:i}=e.body||{},a=e.request,n=await eW(e);if(a&&!n)throw e.error("UNAUTHORIZED");let s=n?.user?.id||i;if(!s)throw e.error("UNAUTHORIZED");if(!e.context.socialProviders.find(e=>e.id===r))throw new j.APIError("BAD_REQUEST",{message:`Provider ${r} is not supported.`});let c=await eL(e);if(!(t=c&&r===c.providerId&&(!o||c.id===o)?c:(await e.context.internalAdapter.findAccounts(s)).find(e=>o?e.id===o&&e.providerId===r:e.providerId===r)))throw new j.APIError("BAD_REQUEST",{message:"Account not found"});let l=e.context.socialProviders.find(e=>e.id===r);if(!l)throw new j.APIError("BAD_REQUEST",{message:`Provider ${r} not found.`});try{let r=null,o=t.accessTokenExpiresAt&&new Date(t.accessTokenExpiresAt).getTime()-Date.now()<5e3;if(t.refreshToken&&o&&l.refreshAccessToken){let o=await t2(t.refreshToken,e.context);r=await l.refreshAccessToken(o);let i=await e.context.internalAdapter.updateAccount(t.id,{accessToken:await t6(r.accessToken,e.context),accessTokenExpiresAt:r.accessTokenExpiresAt,refreshToken:await t6(r.refreshToken,e.context),refreshTokenExpiresAt:r.refreshTokenExpiresAt});e.context.options.account?.storeAccountCookie&&i&&await eN(e,i)}let i={accessToken:r?.accessToken??await t2(t.accessToken??"",e.context),accessTokenExpiresAt:r?.accessTokenExpiresAt??t.accessTokenExpiresAt??void 0,scopes:t.scope?.split(",")??[],idToken:r?.idToken??t.idToken??void 0};return e.json(i)}catch(e){throw new j.APIError("BAD_REQUEST",{message:"Failed to get a valid access token",cause:e})}}),t9=eH("/refresh-token",{method:"POST",body:Y.object({providerId:Y.string().meta({description:"The provider ID for the OAuth provider"}),accountId:Y.string().meta({description:"The account ID associated with the refresh token"}).optional(),userId:Y.string().meta({description:"The user ID associated with the account"}).optional()}),metadata:{openapi:{description:"Refresh the access token using a refresh token",responses:{200:{description:"Access token refreshed successfully",content:{"application/json":{schema:{type:"object",properties:{tokenType:{type:"string"},idToken:{type:"string"},accessToken:{type:"string"},refreshToken:{type:"string"},accessTokenExpiresAt:{type:"string",format:"date-time"},refreshTokenExpiresAt:{type:"string",format:"date-time"}}}}}},400:{description:"Invalid refresh token or provider configuration"}}}}},async e=>{let t,r,{providerId:o,accountId:i,userId:a}=e.body,n=e.request,s=await eW(e);if(n&&!s)throw e.error("UNAUTHORIZED");let c=s?.user?.id||a;if(!c)throw new j.APIError("BAD_REQUEST",{message:"Either userId or session is required"});let l=e.context.socialProviders.find(e=>e.id===o);if(!l)throw new j.APIError("BAD_REQUEST",{message:`Provider ${o} not found.`});if(!l.refreshAccessToken)throw new j.APIError("BAD_REQUEST",{message:`Provider ${o} does not support token refreshing.`});let d=await eL(e);if(!(t=d&&(!o||o===d?.providerId)?d:(await e.context.internalAdapter.findAccounts(c)).find(e=>i?e.id===i&&e.providerId===o:e.providerId===o)))throw new j.APIError("BAD_REQUEST",{message:"Account not found"});if(!(r=d&&o===d.providerId?d.refreshToken??void 0:t.refreshToken??void 0))throw new j.APIError("BAD_REQUEST",{message:"Refresh token not found"});try{let i=await t2(r,e.context),a=await l.refreshAccessToken(i);if(t.id){let r={...t||{},accessToken:await t6(a.accessToken,e.context),refreshToken:await t6(a.refreshToken,e.context),accessTokenExpiresAt:a.accessTokenExpiresAt,refreshTokenExpiresAt:a.refreshTokenExpiresAt,scope:a.scopes?.join(",")||t.scope,idToken:a.idToken||t.idToken};await e.context.internalAdapter.updateAccount(t.id,r)}return d&&o===d.providerId&&e.context.options.account?.storeAccountCookie&&await eN(e,{...d,accessToken:await t6(a.accessToken,e.context),refreshToken:await t6(a.refreshToken,e.context),accessTokenExpiresAt:a.accessTokenExpiresAt,refreshTokenExpiresAt:a.refreshTokenExpiresAt,scope:a.scopes?.join(",")||d.scope,idToken:a.idToken||d.idToken}),e.json({accessToken:a.accessToken,refreshToken:a.refreshToken,accessTokenExpiresAt:a.accessTokenExpiresAt,refreshTokenExpiresAt:a.refreshTokenExpiresAt,scope:a.scopes?.join(",")||t.scope,idToken:a.idToken||t.idToken,providerId:t.providerId,accountId:t.accountId})}catch(e){throw new j.APIError("BAD_REQUEST",{message:"Failed to refresh access token",cause:e})}}),t7=eH("/account-info",{method:"GET",use:[eY],metadata:{openapi:{description:"Get the account info provided by the provider",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object",properties:{id:{type:"string"},name:{type:"string"},email:{type:"string"},image:{type:"string"},emailVerified:{type:"boolean"}},required:["id","emailVerified"]},data:{type:"object",properties:{},additionalProperties:!0}},required:["user","data"],additionalProperties:!1}}}}}}},query:Y.optional(Y.object({accountId:Y.string().meta({description:"The provider given account id for which to get the account info"}).optional()}))},async e=>{let t,r=e.query?.accountId;if(r){let o=await e.context.internalAdapter.findAccount(r);o&&(t=o)}else if(e.context.options.account?.storeAccountCookie){let r=await eL(e);r&&(t=r)}if(!t||t.userId!==e.context.session.user.id)throw new j.APIError("BAD_REQUEST",{message:"Account not found"});let o=e.context.socialProviders.find(e=>e.id===t.providerId);if(!o)throw new j.APIError("INTERNAL_SERVER_ERROR",{message:`Provider account provider is ${t.providerId} but it is not configured`});let i=await t8({...e,method:"POST",body:{accountId:t.id,providerId:t.providerId},returnHeaders:!1,returnStatus:!1});if(!i.accessToken)throw new j.APIError("BAD_REQUEST",{message:"Access token not found"});let a=await o.getUserInfo({...i,accessToken:i.accessToken});return e.json(a)});async function re(e,{userInfo:t,account:r,callbackURL:o,disableSignUp:i,overrideUserInfo:a}){let n=await e.context.internalAdapter.findOAuthUser(t.email.toLowerCase(),r.accountId,r.providerId).catch(t=>{et.logger.error("Better auth was unable to query your database.\nError: ",t);let r=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;throw e.redirect(`${r}?error=internal_server_error`)}),s=n?.user,c=!s;if(n){let o=n.accounts.find(e=>e.providerId===r.providerId&&e.accountId===r.accountId);if(o){if(e.context.options.account?.updateAccountOnSignIn!==!1){let t=Object.fromEntries(Object.entries({idToken:r.idToken,accessToken:await t6(r.accessToken,e.context),refreshToken:await t6(r.refreshToken,e.context),accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scope}).filter(([e,t])=>void 0!==t));e.context.options.account?.storeAccountCookie&&await eN(e,t),Object.keys(t).length>0&&await e.context.internalAdapter.updateAccount(o.id,t)}t.emailVerified&&!n.user.emailVerified&&t.email.toLowerCase()===n.user.email&&await e.context.internalAdapter.updateUser(n.user.id,{emailVerified:!0})}else{if(!e.context.options.account?.accountLinking?.trustedProviders?.includes(r.providerId)&&!t.emailVerified||e.context.options.account?.accountLinking?.enabled===!1)return(0,Z.d)()&&et.logger.warn(`User already exist but account isn't linked to ${r.providerId}. To read more about how account linking works in Better Auth see https://www.better-auth.com/docs/concepts/users-accounts#account-linking.`),{error:"account not linked",data:null};try{await e.context.internalAdapter.linkAccount({providerId:r.providerId,accountId:t.id.toString(),userId:n.user.id,accessToken:await t6(r.accessToken,e.context),refreshToken:await t6(r.refreshToken,e.context),idToken:r.idToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scope})}catch(e){return et.logger.error("Unable to link account",e),{error:"unable to link account",data:null}}t.emailVerified&&!n.user.emailVerified&&t.email.toLowerCase()===n.user.email&&await e.context.internalAdapter.updateUser(n.user.id,{emailVerified:!0})}if(a){let{id:r,...o}=t;s=await e.context.internalAdapter.updateUser(n.user.id,{...o,email:t.email.toLowerCase(),emailVerified:t.email.toLowerCase()===n.user.email&&n.user.emailVerified||t.emailVerified})}}else{if(i)return{error:"signup disabled",data:null,isRegister:!1};try{let{id:i,...a}=t,n={accessToken:await t6(r.accessToken,e.context),refreshToken:await t6(r.refreshToken,e.context),idToken:r.idToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scope,providerId:r.providerId,accountId:t.id.toString()},{user:c,account:l}=await e.context.internalAdapter.createOAuthUser({...a,email:t.email.toLowerCase()},n);if(s=c,e.context.options.account?.storeAccountCookie&&await eN(e,l),!t.emailVerified&&s&&e.context.options.emailVerification?.sendOnSignUp){let t=await ro(e.context.secret,s.email,void 0,e.context.options.emailVerification?.expiresIn),r=`${e.context.baseURL}/verify-email?token=${t}&callbackURL=${o}`;await e.context.options.emailVerification?.sendVerificationEmail?.({user:s,url:r,token:t},e.request)}}catch(e){if(et.logger.error(e),e instanceof j.APIError)return{error:e.message,data:null,isRegister:!1};return{error:"unable to create user",data:null,isRegister:!1}}}if(!s)return{error:"unable to create user",data:null,isRegister:!1};let l=await e.context.internalAdapter.createSession(s.id);return l?{data:{session:l,user:s},error:null,isRegister:c}:{error:"unable to create session",data:null,isRegister:!1}}let rt=Y.object({code:Y.string().optional(),error:Y.string().optional(),device_id:Y.string().optional(),error_description:Y.string().optional(),state:Y.string().optional(),user:Y.string().optional()}),rr=eH("/callback/:id",{method:["GET","POST"],operationId:"handleOAuthCallback",body:rt.optional(),query:rt.optional(),metadata:{...C.n,allowedMediaTypes:["application/x-www-form-urlencoded","application/json"]}},async e=>{let t,r,o,i=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;if("POST"===e.method){let t=e.body?rt.parse(e.body):{},r=e.query?rt.parse(e.query):{},o=rt.parse({...t,...r}),i=new URLSearchParams;for(let[e,t]of Object.entries(o))null!=t&&i.set(e,String(t));let a=`${e.context.baseURL}/callback/${e.params.id}?${i.toString()}`;throw e.redirect(a)}try{if("GET"===e.method)t=rt.parse(e.query);else if("POST"===e.method)t=rt.parse(e.body);else throw Error("Unsupported method")}catch(t){throw e.context.logger.error("INVALID_CALLBACK_REQUEST",t),e.redirect(`${i}?error=invalid_callback_request`)}let{code:a,error:n,state:s,error_description:c,device_id:l}=t;if(!s){e.context.logger.error("State not found",n);let t=`${i}${i.includes("?")?"&":"?"}state=state_not_found`;throw e.redirect(t)}let{codeVerifier:d,callbackURL:u,link:p,errorURL:f,newUserURL:m,requestSignUp:h}=await (0,C.i)(e);function g(t,r){let o=f??i,a=new URLSearchParams({error:t});r&&a.set("error_description",r);let n=`${o}${o.includes("?")?"&":"?"}${a.toString()}`;throw e.redirect(n)}if(n&&g(n,c),!a)throw e.context.logger.error("Code not found"),g("no_code");let w=e.context.socialProviders.find(t=>t.id===e.params.id);if(!w)throw e.context.logger.error("Oauth provider with id",e.params.id,"not found"),g("oauth_provider_not_found");try{r=await w.validateAuthorizationCode({code:a,codeVerifier:d,deviceId:l,redirectURI:`${e.context.baseURL}/callback/${w.id}`})}catch(t){throw e.context.logger.error("",t),g("invalid_code")}let y=await w.getUserInfo({...r,user:e.body?.user?(0,G.t)(e.body.user):void 0}).then(e=>e?.user);if(!y)return e.context.logger.error("Unable to get user info"),g("unable_to_get_user_info");if(!u)throw e.context.logger.error("No callback URL found"),g("no_callback_url");if(p){let t;if(!e.context.options.account?.accountLinking?.trustedProviders?.includes(w.id)&&!y.emailVerified||e.context.options.account?.accountLinking?.enabled===!1)return e.context.logger.error("Unable to link account - untrusted provider"),g("unable_to_link_account");if(y.email!==p.email&&e.context.options.account?.accountLinking?.allowDifferentEmails!==!0)return g("email_doesn't_match");let o=await e.context.internalAdapter.findAccount(String(y.id));if(o){if(o.userId.toString()!==p.userId.toString())return g("account_already_linked_to_different_user");let t=Object.fromEntries(Object.entries({accessToken:await t6(r.accessToken,e.context),refreshToken:await t6(r.refreshToken,e.context),idToken:r.idToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scopes?.join(",")}).filter(([e,t])=>void 0!==t));await e.context.internalAdapter.updateAccount(o.id,t)}else if(!await e.context.internalAdapter.createAccount({userId:p.userId,providerId:w.id,accountId:String(y.id),...r,accessToken:await t6(r.accessToken,e.context),refreshToken:await t6(r.refreshToken,e.context),scope:r.scopes?.join(",")}))return g("unable_to_link_account");try{t=u.toString()}catch{t=u}throw e.redirect(t)}if(!y.email)return e.context.logger.error("Provider did not return email. This could be due to misconfiguration in the provider settings."),g("email_not_found");let A={providerId:w.id,accountId:String(y.id),...r,scope:r.scopes?.join(",")},E=await re(e,{userInfo:{...y,id:String(y.id),email:y.email,name:y.name||y.email},account:A,callbackURL:u,disableSignUp:w.disableImplicitSignUp&&!h||w.options?.disableSignUp,overrideUserInfo:w.options?.overrideUserInfoOnSignIn});if(E.error)return e.context.logger.error(E.error.split(" ").join("_")),g(E.error.split(" ").join("_"));let{session:T,user:I}=E.data;await e$(e,{session:T,user:I});try{o=(E.isRegister&&m||u).toString()}catch{o=E.isRegister&&m||u}throw e.redirect(o)});async function ro(e,t,r,o=3600,i){return await (0,eu.o)({email:t.toLowerCase(),updateTo:r,...i},e,o)}async function ri(e,t){if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new j.APIError("BAD_REQUEST",{message:"Verification email isn't enabled"});let r=await ro(e.context.secret,t.email,void 0,e.context.options.emailVerification?.expiresIn),o=e.body.callbackURL?encodeURIComponent(e.body.callbackURL):encodeURIComponent("/"),i=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${o}`;await e.context.options.emailVerification.sendVerificationEmail({user:t,url:i,token:r},e.request)}let ra=eH("/send-verification-email",{method:"POST",operationId:"sendVerificationEmail",body:Y.object({email:Y.email().meta({description:"The email to send the verification email to"}),callbackURL:Y.string().meta({description:"The URL to use for email verification callback"}).optional()}),metadata:{openapi:{operationId:"sendVerificationEmail",description:"Send a verification email to the user",requestBody:{content:{"application/json":{schema:{type:"object",properties:{email:{type:"string",description:"The email to send the verification email to",example:"user@example.com"},callbackURL:{type:"string",description:"The URL to use for email verification callback",example:"https://example.com/callback",nullable:!0}},required:["email"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if the email was sent successfully",example:!0}}}}}},400:{description:"Bad Request",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",description:"Error message",example:"Verification email isn't enabled"}}}}}}}}}},async e=>{if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new j.APIError("BAD_REQUEST",{message:"Verification email isn't enabled"});let{email:t}=e.body,r=await eW(e);if(!r){let r=await e.context.internalAdapter.findUserByEmail(t);return r?await ri(e,r.user):await ro(e.context.secret,t,void 0,e.context.options.emailVerification?.expiresIn),e.json({status:!0})}if(r?.user.emailVerified)throw new j.APIError("BAD_REQUEST",{message:"You can only send a verification email to an unverified email"});if(r?.user.email!==t)throw new j.APIError("BAD_REQUEST",{message:"You can only send a verification email to your own email"});return await ri(e,r.user),e.json({status:!0})}),rn=eH("/verify-email",{method:"GET",operationId:"verifyEmail",query:Y.object({token:Y.string().meta({description:"The token to verify the email"}),callbackURL:Y.string().meta({description:"The URL to redirect to after email verification"}).optional()}),use:[tX(e=>e.query.callbackURL)],metadata:{openapi:{description:"Verify the email of the user",parameters:[{name:"token",in:"query",description:"The token to verify the email",required:!0,schema:{type:"string"}},{name:"callbackURL",in:"query",description:"The URL to redirect to after email verification",required:!1,schema:{type:"string"}}],responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object",$ref:"#/components/schemas/User"},status:{type:"boolean",description:"Indicates if the email was verified successfully"}},required:["user","status"]}}}}}}}},async e=>{let t;function r(t){if(e.query.callbackURL){if(e.query.callbackURL.includes("?"))throw e.redirect(`${e.query.callbackURL}&error=${t}`);throw e.redirect(`${e.query.callbackURL}?error=${t}`)}throw new j.APIError("UNAUTHORIZED",{message:t})}let{token:o}=e.query;try{t=await (0,e4.jwtVerify)(o,new TextEncoder().encode(e.context.secret),{algorithms:["HS256"]})}catch(e){if(e instanceof tk.JWTExpired)return r("token_expired");return r("invalid_token")}let i=Y.object({email:Y.email(),updateTo:Y.string().optional(),requestType:Y.string().optional()}).parse(t.payload),a=await e.context.internalAdapter.findUserByEmail(i.email);if(!a)return r("user_not_found");if(i.updateTo){let t=await eW(e);if(t&&t.user.email!==i.email)return r("unauthorized");if("change-email-confirmation"===i.requestType){let t=await ro(e.context.secret,i.email,i.updateTo,e.context.options.emailVerification?.expiresIn,{requestType:"change-email-verification"}),r=e.query.callbackURL?encodeURIComponent(e.query.callbackURL):encodeURIComponent("/"),o=`${e.context.baseURL}/verify-email?token=${t}&callbackURL=${r}`;if(await e.context.options.emailVerification?.sendVerificationEmail?.({user:{...a.user,email:i.updateTo},url:o,token:t},e.request),e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0})}if(!t){let r=await e.context.internalAdapter.createSession(a.user.id);if(!r)throw new j.APIError("INTERNAL_SERVER_ERROR",{message:"Failed to create session"});t={session:r,user:a.user}}if("change-email-verification"===i.requestType){let r=await e.context.internalAdapter.updateUserByEmail(i.email,{email:i.updateTo,emailVerified:!0});if(await e$(e,{session:t.session,user:{...t.user,email:i.updateTo,emailVerified:!0}}),e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0,user:r})}let o=await e.context.internalAdapter.updateUserByEmail(i.email,{email:i.updateTo,emailVerified:!1}),n=await ro(e.context.secret,i.updateTo),s=e.query.callbackURL?encodeURIComponent(e.query.callbackURL):encodeURIComponent("/");if(await e.context.options.emailVerification?.sendVerificationEmail?.({user:o,url:`${e.context.baseURL}/verify-email?token=${n}&callbackURL=${s}`,token:n},e.request),await e$(e,{session:t.session,user:{...t.user,email:i.updateTo,emailVerified:!1}}),e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0,user:{id:o.id,email:o.email,name:o.name,image:o.image,emailVerified:o.emailVerified,createdAt:o.createdAt,updatedAt:o.updatedAt}})}if(a.user.emailVerified){if(e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0,user:null})}e.context.options.emailVerification?.onEmailVerification&&await e.context.options.emailVerification.onEmailVerification(a.user,e.request);let n=await e.context.internalAdapter.updateUserByEmail(i.email,{emailVerified:!0});if(e.context.options.emailVerification?.afterEmailVerification&&await e.context.options.emailVerification.afterEmailVerification(n,e.request),e.context.options.emailVerification?.autoSignInAfterVerification){let t=await eW(e);if(t&&t.user.email===i.email)await e$(e,{session:t.session,user:{...t.user,emailVerified:!0}});else{let t=await e.context.internalAdapter.createSession(a.user.id);if(!t)throw new j.APIError("INTERNAL_SERVER_ERROR",{message:"Failed to create session"});await e$(e,{session:t,user:{...a.user,emailVerified:!0}})}}if(e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0,user:null})});function rs(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/&(?!amp;|lt;|gt;|quot;|#39;|#x[0-9a-fA-F]+;|#[0-9]+;)/g,"&amp;")}let rc=eH("/error",{method:"GET",metadata:{...C.n,openapi:{description:"Displays an error page",responses:{200:{description:"Success",content:{"text/html":{schema:{type:"string",description:"The HTML content of the error page"}}}}}}}},async e=>{let t=new URL(e.request?.url||""),r=t.searchParams.get("error")||"UNKNOWN",o=t.searchParams.get("error_description")||null,i=/^[\'A-Za-z0-9_-]+$/.test(r||"")?r:"UNKNOWN",a=o?rs(o):null,n=new URLSearchParams;n.set("error",i),o&&n.set("error_description",o);let s=e.context.options,c=s.onAPIError?.errorURL;return c?new Response(null,{status:302,headers:{Location:`${c}${c.includes("?")?"&":"?"}${n.toString()}`}}):ey.f&&!s.onAPIError?.customizeDefaultErrorPage?new Response(null,{status:302,headers:{Location:`/?${n.toString()}`}}):new Response(((e,t="Unknown",r=null)=>{let o=e.onAPIError?.customizeDefaultErrorPage;return`<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Error</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: ${o?.font?.defaultFamily||"-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif"};
        background: ${o?.colors?.background||"var(--background)"};
        color: var(--foreground);
        margin: 0;
      }
      :root,
      :host {
        --spacing: 0.25rem;
        --container-md: 28rem;
        --text-sm: ${o?.size?.textSm||"0.875rem"};
        --text-sm--line-height: calc(1.25 / 0.875);
        --text-2xl: ${o?.size?.text2xl||"1.5rem"};
        --text-2xl--line-height: calc(2 / 1.5);
        --text-4xl: ${o?.size?.text4xl||"2.25rem"};
        --text-4xl--line-height: calc(2.5 / 2.25);
        --text-6xl: ${o?.size?.text6xl||"3rem"};
        --text-6xl--line-height: 1;
        --font-weight-medium: 500;
        --font-weight-semibold: 600;
        --font-weight-bold: 700;
        --default-transition-duration: 150ms;
        --default-transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        --radius: ${o?.size?.radiusSm||"0.625rem"};
        --default-mono-font-family: ${o?.font?.monoFamily||"var(--font-geist-mono)"};
        --primary: ${o?.colors?.primary||"black"};
        --primary-foreground: ${o?.colors?.primaryForeground||"white"};
        --background: ${o?.colors?.background||"white"};
        --foreground: ${o?.colors?.foreground||"oklch(0.271 0 0)"};
        --border: ${o?.colors?.border||"oklch(0.89 0 0)"};
        --destructive: ${o?.colors?.destructive||"oklch(0.55 0.15 25.723)"};
        --muted-foreground: ${o?.colors?.mutedForeground||"oklch(0.545 0 0)"};
        --corner-border: ${o?.colors?.cornerBorder||"#404040"};
      }

      button, .btn {
        cursor: pointer;
        background: none;
        border: none;
        color: inherit;
        font: inherit;
        transition: all var(--default-transition-duration)
          var(--default-transition-timing-function);
      }
      button:hover, .btn:hover {
        opacity: 0.8;
      }

      @media (prefers-color-scheme: dark) {
        :root,
        :host {
          --primary: ${o?.colors?.primary||"white"};
          --primary-foreground: ${o?.colors?.primaryForeground||"black"};
          --background: ${o?.colors?.background||"oklch(0.15 0 0)"};
          --foreground: ${o?.colors?.foreground||"oklch(0.98 0 0)"};
          --border: ${o?.colors?.border||"oklch(0.27 0 0)"};
          --destructive: ${o?.colors?.destructive||"oklch(0.65 0.15 25.723)"};
          --muted-foreground: ${o?.colors?.mutedForeground||"oklch(0.65 0 0)"};
          --corner-border: ${o?.colors?.cornerBorder||"#a0a0a0"};
        }
      }
      @media (max-width: 640px) {
        :root, :host {
          --text-6xl: 2.5rem;
          --text-2xl: 1.25rem;
          --text-sm: 0.8125rem;
        }
      }
      @media (max-width: 480px) {
        :root, :host {
          --text-6xl: 2rem;
          --text-2xl: 1.125rem;
        }
      }
    </style>
  </head>
  <body style="width: 100vw; min-height: 100vh; overflow-x: hidden; overflow-y: auto;">
    <div
        style="
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            position: relative;
            width: 100%;
            min-height: 100vh;
            padding: 1rem;
        "
        >
${o?.disableBackgroundGrid?"":`
      <div
        style="
          position: absolute;
          inset: 0;
          background-image: linear-gradient(to right, ${o?.colors?.gridColor||"var(--border)"} 1px, transparent 1px),
            linear-gradient(to bottom, ${o?.colors?.gridColor||"var(--border)"} 1px, transparent 1px);
          background-size: 40px 40px;
          opacity: 0.6;
          pointer-events: none;
          width: 100vw;
          height: 100vh;
        "
      ></div>
      <div
        style="
          position: absolute;
          inset: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          background: ${o?.colors?.background||"var(--background)"};
          mask-image: radial-gradient(ellipse at center, transparent 20%, black);
          -webkit-mask-image: radial-gradient(ellipse at center, transparent 20%, black);
          pointer-events: none;
        "
      ></div>
`}

<div
  style="
    position: relative;
    z-index: 10;
    border: 2px solid var(--border);
    background: ${o?.colors?.cardBackground||"var(--background)"};
    padding: 1.5rem;
    max-width: 42rem;
    width: 100%;
  "
>
    ${o?.disableCornerDecorations?"":`
        <!-- Corner decorations -->
        <div
          style="
            position: absolute;
            top: -2px;
            left: -2px;
            width: 2rem;
            height: 2rem;
            border-top: 4px solid var(--corner-border);
            border-left: 4px solid var(--corner-border);
          "
        ></div>
        <div
          style="
            position: absolute;
            top: -2px;
            right: -2px;
            width: 2rem;
            height: 2rem;
            border-top: 4px solid var(--corner-border);
            border-right: 4px solid var(--corner-border);
          "
        ></div>
  
        <div
          style="
            position: absolute;
            bottom: -2px;
            left: -2px;
            width: 2rem;
            height: 2rem;
            border-bottom: 4px solid var(--corner-border);
            border-left: 4px solid var(--corner-border);
          "
        ></div>
        <div
          style="
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 2rem;
            height: 2rem;
            border-bottom: 4px solid var(--corner-border);
            border-right: 4px solid var(--corner-border);
          "
        ></div>`}

        <div style="text-align: center; margin-bottom: 1.5rem;">
          <div style="margin-bottom: 1.5rem;">
            <div
              style="
                display: inline-block;
                border: 2px solid ${o?.disableTitleBorder?"transparent":o?.colors?.titleBorder||"var(--destructive)"};
                padding: 0.375rem 1rem;
              "
            >
              <h1
                style="
                  font-size: var(--text-6xl);
                  font-weight: var(--font-weight-semibold);
                  color: ${o?.colors?.titleColor||"var(--foreground)"};
                  letter-spacing: -0.02em;
                  margin: 0;
                "
              >
                ERROR
              </h1>
            </div>
            <div
              style="
                height: 2px;
                background-color: var(--border);
                width: calc(100% + 3rem);
                margin-left: -1.5rem;
                margin-top: 1.5rem;
              "
            ></div>
          </div>

          <h2
            style="
              font-size: var(--text-2xl);
              font-weight: var(--font-weight-semibold);
              color: var(--foreground);
              margin: 0 0 1rem;
            "
          >
            Something went wrong
          </h2>

          <div
            style="
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                border: 2px solid var(--border);
                background-color: var(--muted);
                padding: 0.375rem 0.75rem;
                margin: 0 0 1rem;
                flex-wrap: wrap;
                justify-content: center;
            "
            >
            <span
                style="
                font-size: 0.75rem;
                color: var(--muted-foreground);
                font-weight: var(--font-weight-semibold);
                "
            >
                CODE:
            </span>
            <span
                style="
                font-size: var(--text-sm);
                font-family: var(--default-mono-font-family, monospace);
                color: var(--foreground);
                word-break: break-all;
                "
            >
                ${rs(t)}
            </span>
            </div>

          <p
            style="
              color: var(--muted-foreground);
              max-width: 28rem;
              margin: 0 auto;
              font-size: var(--text-sm);
              line-height: 1.5;
              text-wrap: pretty;
            "
          >
            ${!r?`We encountered an unexpected error. Please try again or return to the home page. If you're a developer, you can find more information about the error <a href='https://better-auth.com/docs/errors/${encodeURIComponent(t)}' target='_blank' rel="noopener noreferrer" style='color: var(--foreground); text-decoration: underline;'>here</a>.`:r}
          </p>
        </div>

        <div
          style="
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            justify-content: center;
            flex-wrap: wrap;
          "
        >
          <a
            href="/"
            style="
              text-decoration: none;
            "
          >
            <div
              style="
                border: 2px solid var(--border);
                background: var(--primary);
                color: var(--primary-foreground);
                padding: 0.5rem 1rem;
                border-radius: 0;
                white-space: nowrap;
              "
              class="btn"
            >
              Go Home
            </div>
          </a>
          <a
            href="https://better-auth.com/docs/errors/${encodeURIComponent(t)}?askai=${encodeURIComponent(`What does the error code ${t} mean?`)}"
            target="_blank"
            rel="noopener noreferrer"
            style="
              text-decoration: none;
            "
          >
            <div
              style="
                border: 2px solid var(--border);
                background: transparent;
                color: var(--foreground);
                padding: 0.5rem 1rem;
                border-radius: 0;
                white-space: nowrap;
              "
              class="btn"
            >
              Ask AI
            </div>
          </a>
        </div>
      </div>
    </div>
  </body>
</html>`})(e.context.options,i,a),{headers:{"Content-Type":"text/html"}})}),rl=eH("/ok",{method:"GET",metadata:{...C.n,openapi:{description:"Check if the API is working",responses:{200:{description:"API is working",content:{"application/json":{schema:{type:"object",properties:{ok:{type:"boolean",description:"Indicates if the API is working"}},required:["ok"]}}}}}}}},async e=>e.json({ok:!0}));function rd(e,t,r){let o=t?new URL(t,e.baseURL):new URL(`${e.baseURL}/error`);return r&&Object.entries(r).forEach(([e,t])=>o.searchParams.set(e,t)),o.href}let ru=eH("/request-password-reset",{method:"POST",body:Y.object({email:Y.email().meta({description:"The email address of the user to send a password reset email to"}),redirectTo:Y.string().meta({description:"The URL to redirect the user to reset their password. If the token isn't valid or expired, it'll be redirected with a query parameter `?error=INVALID_TOKEN`. If the token is valid, it'll be redirected with a query parameter `?token=VALID_TOKEN"}).optional()}),metadata:{openapi:{operationId:"requestPasswordReset",description:"Send a password reset email to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"},message:{type:"string"}}}}}}}}}},async e=>{if(!e.context.options.emailAndPassword?.sendResetPassword)throw e.context.logger.error("Reset password isn't enabled.Please pass an emailAndPassword.sendResetPassword function in your auth config!"),new j.APIError("BAD_REQUEST",{message:"Reset password isn't enabled"});let{email:t,redirectTo:r}=e.body,o=await e.context.internalAdapter.findUserByEmail(t,{includeAccounts:!0});if(!o)return(0,C.t)(24),await e.context.internalAdapter.findVerificationValue("dummy-verification-token"),e.context.logger.error("Reset Password: User not found",{email:t}),e.json({status:!0,message:"If this email exists in our system, check your email for the reset link"});let i=$(e.context.options.emailAndPassword.resetPasswordTokenExpiresIn||3600,"sec"),a=(0,C.t)(24);await e.context.internalAdapter.createVerificationValue({value:o.user.id,identifier:`reset-password:${a}`,expiresAt:i});let n=r?encodeURIComponent(r):"",s=`${e.context.baseURL}/reset-password/${a}?callbackURL=${n}`;return await e.context.options.emailAndPassword.sendResetPassword({user:o.user,url:s,token:a},e.request).catch(t=>{e.context.logger.error("Failed to send reset password email",t)}),e.json({status:!0,message:"If this email exists in our system, check your email for the reset link"})}),rp=eH("/reset-password/:token",{method:"GET",operationId:"forgetPasswordCallback",query:Y.object({callbackURL:Y.string().meta({description:"The URL to redirect the user to reset their password"})}),use:[tX(e=>e.query.callbackURL)],metadata:{openapi:{operationId:"resetPasswordCallback",description:"Redirects the user to the callback URL with the token",parameters:[{name:"token",in:"path",required:!0,description:"The token to reset the password",schema:{type:"string"}},{name:"callbackURL",in:"query",required:!0,description:"The URL to redirect the user to reset their password",schema:{type:"string"}}],responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string"}}}}}}}}}},async e=>{var t,r;let o,{token:i}=e.params,{callbackURL:a}=e.query;if(!i||!a)throw e.redirect(rd(e.context,a,{error:"INVALID_TOKEN"}));let n=await e.context.internalAdapter.findVerificationValue(`reset-password:${i}`);if(!n||n.expiresAt<new Date)throw e.redirect(rd(e.context,a,{error:"INVALID_TOKEN"}));throw e.redirect((t=e.context,r={token:i},o=new URL(a,t.baseURL),r&&Object.entries(r).forEach(([e,t])=>o.searchParams.set(e,t)),o.href))}),rf=eH("/reset-password",{method:"POST",operationId:"resetPassword",query:Y.object({token:Y.string().optional()}).optional(),body:Y.object({newPassword:Y.string().meta({description:"The new password to set"}),token:Y.string().meta({description:"The token to reset the password"}).optional()}),metadata:{openapi:{operationId:"resetPassword",description:"Reset the password for a user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{let t=e.body.token||e.query?.token;if(!t)throw new j.APIError("BAD_REQUEST",{message:eq.n.INVALID_TOKEN});let{newPassword:r}=e.body,o=e.context.password?.config.minPasswordLength,i=e.context.password?.config.maxPasswordLength;if(r.length<o)throw new j.APIError("BAD_REQUEST",{message:eq.n.PASSWORD_TOO_SHORT});if(r.length>i)throw new j.APIError("BAD_REQUEST",{message:eq.n.PASSWORD_TOO_LONG});let a=`reset-password:${t}`,n=await e.context.internalAdapter.findVerificationValue(a);if(!n||n.expiresAt<new Date)throw new j.APIError("BAD_REQUEST",{message:eq.n.INVALID_TOKEN});let s=n.value,c=await e.context.password.hash(r);if((await e.context.internalAdapter.findAccounts(s)).find(e=>"credential"===e.providerId)?await e.context.internalAdapter.updatePassword(s,c):await e.context.internalAdapter.createAccount({userId:s,providerId:"credential",password:c,accountId:s}),await e.context.internalAdapter.deleteVerificationValue(n.id),e.context.options.emailAndPassword?.onPasswordReset){let t=await e.context.internalAdapter.findUserById(s);t&&await e.context.options.emailAndPassword.onPasswordReset({user:t},e.request)}return e.context.options.emailAndPassword?.revokeSessionsOnPasswordReset&&await e.context.internalAdapter.deleteSessions(s),e.json({status:!0})}),rm=Y.object({callbackURL:Y.string().meta({description:"Callback URL to redirect to after the user has signed in"}).optional(),newUserCallbackURL:Y.string().optional(),errorCallbackURL:Y.string().meta({description:"Callback URL to redirect to if an error happens"}).optional(),provider:tH,disableRedirect:Y.boolean().meta({description:"Disable automatic redirection to the provider. Useful for handling the redirection yourself"}).optional(),idToken:Y.optional(Y.object({token:Y.string().meta({description:"ID token from the provider"}),nonce:Y.string().meta({description:"Nonce used to generate the token"}).optional(),accessToken:Y.string().meta({description:"Access token from the provider"}).optional(),refreshToken:Y.string().meta({description:"Refresh token from the provider"}).optional(),expiresAt:Y.number().meta({description:"Expiry date of the token"}).optional()})),scopes:Y.array(Y.string()).meta({description:"Array of scopes to request from the provider. This will override the default scopes passed."}).optional(),requestSignUp:Y.boolean().meta({description:"Explicitly request sign-up. Useful when disableImplicitSignUp is true for this provider"}).optional(),loginHint:Y.string().meta({description:"The login hint to use for the authorization code request"}).optional(),additionalData:Y.record(Y.string(),Y.any()).optional().meta({description:"Additional data to be passed through the OAuth flow"})}),rh=eH("/sign-out",{method:"POST",operationId:"signOut",requireHeaders:!0,metadata:{openapi:{operationId:"signOut",description:"Sign out the current user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async e=>{let t=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(t)try{await e.context.internalAdapter.deleteSession(t)}catch(t){e.context.logger.error("Failed to delete session from database",t)}return eV(e),e.json({success:!0})}),rg=eH("/change-password",{method:"POST",operationId:"changePassword",body:Y.object({newPassword:Y.string().meta({description:"The new password to set"}),currentPassword:Y.string().meta({description:"The current password is required"}),revokeOtherSessions:Y.boolean().meta({description:"Must be a boolean value"}).optional()}),use:[eK],metadata:{openapi:{operationId:"changePassword",description:"Change the password of the user",responses:{200:{description:"Password successfully changed",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string",nullable:!0,description:"New session token if other sessions were revoked"},user:{type:"object",properties:{id:{type:"string",description:"The unique identifier of the user"},email:{type:"string",format:"email",description:"The email address of the user"},name:{type:"string",description:"The name of the user"},image:{type:"string",format:"uri",nullable:!0,description:"The profile image URL of the user"},emailVerified:{type:"boolean",description:"Whether the email has been verified"},createdAt:{type:"string",format:"date-time",description:"When the user was created"},updatedAt:{type:"string",format:"date-time",description:"When the user was last updated"}},required:["id","email","name","emailVerified","createdAt","updatedAt"]}},required:["user"]}}}}}}}},async e=>{let{newPassword:t,currentPassword:r,revokeOtherSessions:o}=e.body,i=e.context.session,a=e.context.password.config.minPasswordLength;if(t.length<a)throw e.context.logger.error("Password is too short"),new j.APIError("BAD_REQUEST",{message:eq.n.PASSWORD_TOO_SHORT});let n=e.context.password.config.maxPasswordLength;if(t.length>n)throw e.context.logger.error("Password is too long"),new j.APIError("BAD_REQUEST",{message:eq.n.PASSWORD_TOO_LONG});let s=(await e.context.internalAdapter.findAccounts(i.user.id)).find(e=>"credential"===e.providerId&&e.password);if(!s||!s.password)throw new j.APIError("BAD_REQUEST",{message:eq.n.CREDENTIAL_ACCOUNT_NOT_FOUND});let c=await e.context.password.hash(t);if(!await e.context.password.verify({hash:s.password,password:r}))throw new j.APIError("BAD_REQUEST",{message:eq.n.INVALID_PASSWORD});await e.context.internalAdapter.updateAccount(s.id,{password:c});let l=null;if(o){await e.context.internalAdapter.deleteSessions(i.user.id);let t=await e.context.internalAdapter.createSession(i.user.id);if(!t)throw new j.APIError("INTERNAL_SERVER_ERROR",{message:eq.n.FAILED_TO_GET_SESSION});await e$(e,{session:t,user:i.user}),l=t.token}return e.json({token:l,user:{id:i.user.id,email:i.user.email,name:i.user.name,image:i.user.image,emailVerified:i.user.emailVerified,createdAt:i.user.createdAt,updatedAt:i.user.updatedAt}})}),rw=eH("/set-password",{method:"POST",body:Y.object({newPassword:Y.string().meta({description:"The new password to set is required"})}),metadata:{SERVER_ONLY:!0},use:[eK]},async e=>{let{newPassword:t}=e.body,r=e.context.session,o=e.context.password.config.minPasswordLength;if(t.length<o)throw e.context.logger.error("Password is too short"),new j.APIError("BAD_REQUEST",{message:eq.n.PASSWORD_TOO_SHORT});let i=e.context.password.config.maxPasswordLength;if(t.length>i)throw e.context.logger.error("Password is too long"),new j.APIError("BAD_REQUEST",{message:eq.n.PASSWORD_TOO_LONG});let a=(await e.context.internalAdapter.findAccounts(r.user.id)).find(e=>"credential"===e.providerId&&e.password),n=await e.context.password.hash(t);if(!a)return await e.context.internalAdapter.linkAccount({userId:r.user.id,providerId:"credential",accountId:r.user.id,password:n}),e.json({status:!0});throw new j.APIError("BAD_REQUEST",{message:"user already has a password"})}),ry=eH("/delete-user",{method:"POST",use:[eK],body:Y.object({callbackURL:Y.string().meta({description:"The callback URL to redirect to after the user is deleted"}).optional(),password:Y.string().meta({description:"The password of the user is required to delete the user"}).optional(),token:Y.string().meta({description:"The token to delete the user is required"}).optional()}),metadata:{openapi:{operationId:"deleteUser",description:"Delete the user",requestBody:{content:{"application/json":{schema:{type:"object",properties:{callbackURL:{type:"string",description:"The callback URL to redirect to after the user is deleted"},password:{type:"string",description:"The user's password. Required if session is not fresh"},token:{type:"string",description:"The deletion verification token"}}}}}},responses:{200:{description:"User deletion processed successfully",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean",description:"Indicates if the operation was successful"},message:{type:"string",enum:["User deleted","Verification email sent"],description:"Status message of the deletion process"}},required:["success","message"]}}}}}}}},async e=>{if(!e.context.options.user?.deleteUser?.enabled)throw e.context.logger.error("Delete user is disabled. Enable it in the options"),new j.APIError("NOT_FOUND");let t=e.context.session;if(e.body.password){let r=(await e.context.internalAdapter.findAccounts(t.user.id)).find(e=>"credential"===e.providerId&&e.password);if(!r||!r.password)throw new j.APIError("BAD_REQUEST",{message:eq.n.CREDENTIAL_ACCOUNT_NOT_FOUND});if(!await e.context.password.verify({hash:r.password,password:e.body.password}))throw new j.APIError("BAD_REQUEST",{message:eq.n.INVALID_PASSWORD})}if(e.body.token)return await rA({...e,query:{token:e.body.token}}),e.json({success:!0,message:"User deleted"});if(e.context.options.user.deleteUser?.sendDeleteAccountVerification){let r=(0,eu.r)(32,"0-9","a-z");await e.context.internalAdapter.createVerificationValue({value:t.user.id,identifier:`delete-account-${r}`,expiresAt:new Date(Date.now()+1e3*(e.context.options.user.deleteUser?.deleteTokenExpiresIn||86400))});let o=`${e.context.baseURL}/delete-user/callback?token=${r}&callbackURL=${e.body.callbackURL||"/"}`;return await e.context.options.user.deleteUser.sendDeleteAccountVerification({user:t.user,url:o,token:r},e.request),e.json({success:!0,message:"Verification email sent"})}if(!e.body.password&&0!==e.context.sessionConfig.freshAge){let r=new Date(t.session.createdAt).getTime(),o=1e3*e.context.sessionConfig.freshAge;if(Date.now()-r>1e3*o)throw new j.APIError("BAD_REQUEST",{message:eq.n.SESSION_EXPIRED})}let r=e.context.options.user.deleteUser?.beforeDelete;r&&await r(t.user,e.request),await e.context.internalAdapter.deleteUser(t.user.id),await e.context.internalAdapter.deleteSessions(t.user.id),eV(e);let o=e.context.options.user.deleteUser?.afterDelete;return o&&await o(t.user,e.request),e.json({success:!0,message:"User deleted"})}),rA=eH("/delete-user/callback",{method:"GET",query:Y.object({token:Y.string().meta({description:"The token to verify the deletion request"}),callbackURL:Y.string().meta({description:"The URL to redirect to after deletion"}).optional()}),use:[tX(e=>e.query.callbackURL)],metadata:{openapi:{description:"Callback to complete user deletion with verification token",responses:{200:{description:"User successfully deleted",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean",description:"Indicates if the deletion was successful"},message:{type:"string",enum:["User deleted"],description:"Confirmation message"}},required:["success","message"]}}}}}}}},async e=>{if(!e.context.options.user?.deleteUser?.enabled)throw e.context.logger.error("Delete user is disabled. Enable it in the options"),new j.APIError("NOT_FOUND");let t=await eW(e);if(!t)throw new j.APIError("NOT_FOUND",{message:eq.n.FAILED_TO_GET_USER_INFO});let r=await e.context.internalAdapter.findVerificationValue(`delete-account-${e.query.token}`);if(!r||r.expiresAt<new Date||r.value!==t.user.id)throw new j.APIError("NOT_FOUND",{message:eq.n.INVALID_TOKEN});let o=e.context.options.user.deleteUser?.beforeDelete;o&&await o(t.user,e.request),await e.context.internalAdapter.deleteUser(t.user.id),await e.context.internalAdapter.deleteSessions(t.user.id),await e.context.internalAdapter.deleteAccounts(t.user.id),await e.context.internalAdapter.deleteVerificationValue(r.id),eV(e);let i=e.context.options.user.deleteUser?.afterDelete;if(i&&await i(t.user,e.request),e.query.callbackURL)throw e.redirect(e.query.callbackURL||"/");return e.json({success:!0,message:"User deleted"})}),rE=eH("/change-email",{method:"POST",body:Y.object({newEmail:Y.email().meta({description:"The new email address to set must be a valid email address"}),callbackURL:Y.string().meta({description:"The URL to redirect to after email verification"}).optional()}),use:[eK],metadata:{openapi:{operationId:"changeEmail",responses:{200:{description:"Email change request processed successfully",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object",$ref:"#/components/schemas/User"},status:{type:"boolean",description:"Indicates if the request was successful"},message:{type:"string",enum:["Email updated","Verification email sent"],description:"Status message of the email change process",nullable:!0}},required:["status"]}}}},422:{description:"Unprocessable Entity. Email already exists",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}}}}}}},async e=>{if(!e.context.options.user?.changeEmail?.enabled)throw e.context.logger.error("Change email is disabled."),new j.APIError("BAD_REQUEST",{message:"Change email is disabled"});let t=e.body.newEmail.toLowerCase();if(t===e.context.session.user.email)throw e.context.logger.error("Email is the same"),new j.APIError("BAD_REQUEST",{message:"Email is the same"});if(await e.context.internalAdapter.findUserByEmail(t))throw e.context.logger.error("Email already exists"),new j.APIError("UNPROCESSABLE_ENTITY",{message:eq.n.USER_ALREADY_EXISTS_USE_ANOTHER_EMAIL});if(!0!==e.context.session.user.emailVerified&&e.context.options.user.changeEmail.updateEmailWithoutVerification){if(await e.context.internalAdapter.updateUserByEmail(e.context.session.user.email,{email:t}),await e$(e,{session:e.context.session.session,user:{...e.context.session.user,email:t}}),e.context.options.emailVerification?.sendVerificationEmail){let r=await ro(e.context.secret,t,void 0,e.context.options.emailVerification?.expiresIn),o=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${e.body.callbackURL||"/"}`;await e.context.options.emailVerification.sendVerificationEmail({user:{...e.context.session.user,email:t},url:o,token:r},e.request)}return e.json({status:!0})}if(e.context.session.user.emailVerified&&(e.context.options.user.changeEmail.sendChangeEmailConfirmation||e.context.options.user.changeEmail.sendChangeEmailVerification)){let r=await ro(e.context.secret,e.context.session.user.email,t,e.context.options.emailVerification?.expiresIn,{requestType:"change-email-confirmation"}),o=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${e.body.callbackURL||"/"}`,i=e.context.options.user.changeEmail.sendChangeEmailConfirmation||e.context.options.user.changeEmail.sendChangeEmailVerification;return i&&await i({user:e.context.session.user,newEmail:t,url:o,token:r},e.request),e.json({status:!0})}if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new j.APIError("BAD_REQUEST",{message:"Verification email isn't enabled"});let r=await ro(e.context.secret,e.context.session.user.email,t,e.context.options.emailVerification?.expiresIn,{requestType:"change-email-verification"}),o=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${e.body.callbackURL||"/"}`;return await e.context.options.emailVerification.sendVerificationEmail({user:{...e.context.session.user,email:t},url:o,token:r},e.request),e.json({status:!0})}),rT=tW((e,t,r)=>{if(Array.isArray(e[t])&&Array.isArray(r))return e[t]=r,!0});async function rI(e,t){let r={};for(let o of t)if(o.matcher(e)){let t=await o.handler({...e,returnHeaders:!1}).catch(t=>{throw t instanceof j.APIError&&(0,e6.a)(e.context.logger.level,"debug")&&(t.stack=t.errorStack),t});if(t&&"object"==typeof t){if("context"in t&&"object"==typeof t.context){let{headers:e,...o}=t.context;e instanceof Headers&&(r.headers?e.forEach((e,t)=>{r.headers?.set(t,e)}):r.headers=e),r=rT(o,r);continue}return t}}return{context:r}}async function rb(e,t){for(let r of t)if(r.matcher(e)){let t=await r.handler(e).catch(t=>{if(t instanceof j.APIError)return(0,e6.a)(e.context.logger.level,"debug")&&(t.stack=t.errorStack),{response:t,headers:t.headers?new Headers(t.headers):null};throw t});t.headers&&t.headers.forEach((t,r)=>{e.context.responseHeaders?"set-cookie"===r.toLowerCase()?e.context.responseHeaders.append(r,t):e.context.responseHeaders.set(r,t):e.context.responseHeaders=new Headers({[r]:t})}),t.response&&(e.context.returned=t.response)}return{response:e.context.returned,headers:e.context.responseHeaders}}function r_(e,t){let r=t.plugins?.reduce((e,t)=>({...e,...t.endpoints}),{})??{},o=t.plugins?.map(t=>t.middlewares?.map(t=>{let r=async r=>{let o=await e;return t.middleware({...r,context:{...o,...r.context}})};return r.options=t.middleware.options,{path:t.path,middleware:r}})).filter(e=>void 0!==e).flat()||[];return{api:function(e,t){let r={};for(let[o,i]of Object.entries(e))r[o]=async e=>{let r=async()=>{let r=await t,o={...e,context:{...r,returned:void 0,responseHeaders:void 0,session:null},path:i.path,headers:e?.headers?new Headers(e?.headers):void 0};return(0,e1.f)(o,async()=>{let{beforeHooks:t,afterHooks:a}=function(e){let t=e.options.plugins||[],r=[],o=[];e.options.hooks?.before&&r.push({matcher:()=>!0,handler:e.options.hooks.before}),e.options.hooks?.after&&o.push({matcher:()=>!0,handler:e.options.hooks.after});let i=t.map(e=>{if(e.hooks?.before)return e.hooks.before}).filter(e=>void 0!==e).flat(),a=t.map(e=>{if(e.hooks?.after)return e.hooks.after}).filter(e=>void 0!==e).flat();return i.length&&r.push(...i),a.length&&o.push(...a),{beforeHooks:r,afterHooks:o}}(r),n=await rI(o,t);if("context"in n&&n.context&&"object"==typeof n.context){let{headers:e,...t}=n.context;e&&e.forEach((e,t)=>{o.headers.set(t,e)}),o=rT(t,o)}else if(n)return e?.asResponse?(0,j.toResponse)(n,{headers:e?.headers}):e?.returnHeaders?{headers:e?.headers,response:n}:n;o.asResponse=!1,o.returnHeaders=!0,o.returnStatus=!0;let s=await (0,e1.f)(o,()=>i(o)).catch(e=>{if(e instanceof j.APIError)return{response:e,status:e.statusCode,headers:e.headers?new Headers(e.headers):null};throw e});if(s&&s instanceof Response)return s;o.context.returned=s.response,o.context.responseHeaders=s.headers;let c=await rb(o,a);if(c.response&&(s.response=c.response),s.response instanceof j.APIError&&(0,e6.a)(r.logger.level,"debug")&&(s.response.stack=s.response.errorStack),s.response instanceof j.APIError&&!e?.asResponse)throw s.response;return e?.asResponse?(0,j.toResponse)(s.response,{headers:s.headers,status:s.status}):e?.returnHeaders?e?.returnStatus?{headers:s.headers,response:s.response,status:s.status}:{headers:s.headers,response:s.response}:e?.returnStatus?{response:s.response,status:s.status}:s.response})};return await (0,e0.c)()?r():(0,e2.l)(new WeakMap,r)},r[o].path=i.path,r[o].options=i.options;return r}({signInSocial:eH("/sign-in/social",{method:"POST",operationId:"socialSignIn",body:rm,metadata:{$Infer:{body:{},returned:{}},openapi:{description:"Sign in with a social provider",operationId:"socialSignIn",responses:{200:{description:"Success - Returns either session details or redirect URL",content:{"application/json":{schema:{type:"object",description:"Session response when idToken is provided",properties:{token:{type:"string"},user:{type:"object",$ref:"#/components/schemas/User"},url:{type:"string"},redirect:{type:"boolean",enum:[!1]}},required:["redirect","token","user"]}}}}}}}},async e=>{let t=e.context.socialProviders.find(t=>t.id===e.body.provider);if(!t)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new j.APIError("NOT_FOUND",{message:eq.n.PROVIDER_NOT_FOUND});if(e.body.idToken){if(!t.verifyIdToken)throw e.context.logger.error("Provider does not support id token verification",{provider:e.body.provider}),new j.APIError("NOT_FOUND",{message:eq.n.ID_TOKEN_NOT_SUPPORTED});let{token:r,nonce:o}=e.body.idToken;if(!await t.verifyIdToken(r,o))throw e.context.logger.error("Invalid id token",{provider:e.body.provider}),new j.APIError("UNAUTHORIZED",{message:eq.n.INVALID_TOKEN});let i=await t.getUserInfo({idToken:r,accessToken:e.body.idToken.accessToken,refreshToken:e.body.idToken.refreshToken});if(!i||!i?.user)throw e.context.logger.error("Failed to get user info",{provider:e.body.provider}),new j.APIError("UNAUTHORIZED",{message:eq.n.FAILED_TO_GET_USER_INFO});if(!i.user.email)throw e.context.logger.error("User email not found",{provider:e.body.provider}),new j.APIError("UNAUTHORIZED",{message:eq.n.USER_EMAIL_NOT_FOUND});let a=await re(e,{userInfo:{...i.user,email:i.user.email,id:String(i.user.id),name:i.user.name||"",image:i.user.image,emailVerified:i.user.emailVerified||!1},account:{providerId:t.id,accountId:String(i.user.id),accessToken:e.body.idToken.accessToken},callbackURL:e.body.callbackURL,disableSignUp:t.disableImplicitSignUp&&!e.body.requestSignUp||t.disableSignUp});if(a.error)throw new j.APIError("UNAUTHORIZED",{message:a.error});return await e$(e,a.data),e.json({redirect:!1,token:a.data.session.token,url:void 0,user:z(e.context.options,a.data.user)})}let{codeVerifier:r,state:o}=await (0,C.r)(e,void 0,e.body.additionalData),i=await t.createAuthorizationURL({state:o,codeVerifier:r,redirectURI:`${e.context.baseURL}/callback/${t.id}`,scopes:e.body.scopes,loginHint:e.body.loginHint});return e.json({url:i.toString(),redirect:!e.body.disableRedirect})}),callbackOAuth:rr,getSession:eZ(),signOut:rh,signUpEmail:eH("/sign-up/email",{method:"POST",operationId:"signUpWithEmailAndPassword",body:Y.record(Y.string(),Y.any()),metadata:{$Infer:{body:{},returned:{}},openapi:{operationId:"signUpWithEmailAndPassword",description:"Sign up a user using email and password",requestBody:{content:{"application/json":{schema:{type:"object",properties:{name:{type:"string",description:"The name of the user"},email:{type:"string",description:"The email of the user"},password:{type:"string",description:"The password of the user"},image:{type:"string",description:"The profile image URL of the user"},callbackURL:{type:"string",description:"The URL to use for email verification callback"},rememberMe:{type:"boolean",description:"If this is false, the session will not be remembered. Default is `true`."}},required:["name","email","password"]}}}},responses:{200:{description:"Successfully created user",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string",nullable:!0,description:"Authentication token for the session"},user:{type:"object",properties:{id:{type:"string",description:"The unique identifier of the user"},email:{type:"string",format:"email",description:"The email address of the user"},name:{type:"string",description:"The name of the user"},image:{type:"string",format:"uri",nullable:!0,description:"The profile image URL of the user"},emailVerified:{type:"boolean",description:"Whether the email has been verified"},createdAt:{type:"string",format:"date-time",description:"When the user was created"},updatedAt:{type:"string",format:"date-time",description:"When the user was last updated"}},required:["id","email","name","emailVerified","createdAt","updatedAt"]}},required:["user"]}}}},422:{description:"Unprocessable Entity. User already exists or failed to create user.",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}}}}}}},async e=>(0,X.i)(e.context.adapter,async()=>{let t;if(!e.context.options.emailAndPassword?.enabled||e.context.options.emailAndPassword?.disableSignUp)throw new j.APIError("BAD_REQUEST",{message:"Email and password sign up is not enabled"});let r=e.body,{name:o,email:i,password:a,image:n,callbackURL:s,rememberMe:c,...l}=r;if(!Y.email().safeParse(i).success)throw new j.APIError("BAD_REQUEST",{message:eq.n.INVALID_EMAIL});let d=e.context.password.config.minPasswordLength;if(a.length<d)throw e.context.logger.error("Password is too short"),new j.APIError("BAD_REQUEST",{message:eq.n.PASSWORD_TOO_SHORT});let u=e.context.password.config.maxPasswordLength;if(a.length>u)throw e.context.logger.error("Password is too long"),new j.APIError("BAD_REQUEST",{message:eq.n.PASSWORD_TOO_LONG});if((await e.context.internalAdapter.findUserByEmail(i))?.user)throw e.context.logger.info(`Sign-up attempt for existing email: ${i}`),new j.APIError("UNPROCESSABLE_ENTITY",{message:eq.n.USER_ALREADY_EXISTS_USE_ANOTHER_EMAIL});let p=await e.context.password.hash(a);try{let r=H(e.context.options,l,"create");if(!(t=await e.context.internalAdapter.createUser({email:i.toLowerCase(),name:o,image:n,...r,emailVerified:!1})))throw new j.APIError("BAD_REQUEST",{message:eq.n.FAILED_TO_CREATE_USER})}catch(t){if((0,Z.d)()&&e.context.logger.error("Failed to create user",t),t instanceof j.APIError)throw t;throw e.context.logger?.error("Failed to create user",t),new j.APIError("UNPROCESSABLE_ENTITY",{message:eq.n.FAILED_TO_CREATE_USER,details:t})}if(!t)throw new j.APIError("UNPROCESSABLE_ENTITY",{message:eq.n.FAILED_TO_CREATE_USER});if(await e.context.internalAdapter.linkAccount({userId:t.id,providerId:"credential",accountId:t.id,password:p}),e.context.options.emailVerification?.sendOnSignUp||e.context.options.emailAndPassword.requireEmailVerification){let o=await ro(e.context.secret,t.email,void 0,e.context.options.emailVerification?.expiresIn),i=r.callbackURL?encodeURIComponent(r.callbackURL):encodeURIComponent("/"),a=`${e.context.baseURL}/verify-email?token=${o}&callbackURL=${i}`,n=e.request?[{user:t,url:a,token:o},e.request]:[{user:t,url:a,token:o}];await e.context.options.emailVerification?.sendVerificationEmail?.(...n)}if(!1===e.context.options.emailAndPassword.autoSignIn||e.context.options.emailAndPassword.requireEmailVerification)return e.json({token:null,user:z(e.context.options,t)});let f=await e.context.internalAdapter.createSession(t.id,!1===c);if(!f)throw new j.APIError("BAD_REQUEST",{message:eq.n.FAILED_TO_CREATE_SESSION});return await e$(e,{session:f,user:t},!1===c),e.json({token:f.token,user:z(e.context.options,t)})})),signInEmail:eH("/sign-in/email",{method:"POST",operationId:"signInEmail",body:Y.object({email:Y.string().meta({description:"Email of the user"}),password:Y.string().meta({description:"Password of the user"}),callbackURL:Y.string().meta({description:"Callback URL to use as a redirect for email verification"}).optional(),rememberMe:Y.boolean().meta({description:"If this is false, the session will not be remembered. Default is `true`."}).default(!0).optional()}),metadata:{$Infer:{body:{},returned:{}},openapi:{operationId:"signInEmail",description:"Sign in with email and password",responses:{200:{description:"Success - Returns either session details or redirect URL",content:{"application/json":{schema:{type:"object",description:"Session response when idToken is provided",properties:{redirect:{type:"boolean",enum:[!1]},token:{type:"string",description:"Session token"},url:{type:"string",nullable:!0},user:{type:"object",$ref:"#/components/schemas/User"}},required:["redirect","token","user"]}}}}}}}},async e=>{if(!e.context.options?.emailAndPassword?.enabled)throw e.context.logger.error("Email and password is not enabled. Make sure to enable it in the options on you `auth.ts` file. Check `https://better-auth.com/docs/authentication/email-password` for more!"),new j.APIError("BAD_REQUEST",{message:"Email and password is not enabled"});let{email:t,password:r}=e.body;if(!Y.email().safeParse(t).success)throw new j.APIError("BAD_REQUEST",{message:eq.n.INVALID_EMAIL});let o=await e.context.internalAdapter.findUserByEmail(t,{includeAccounts:!0});if(!o)throw await e.context.password.hash(r),e.context.logger.error("User not found",{email:t}),new j.APIError("UNAUTHORIZED",{message:eq.n.INVALID_EMAIL_OR_PASSWORD});let i=o.accounts.find(e=>"credential"===e.providerId);if(!i)throw await e.context.password.hash(r),e.context.logger.error("Credential account not found",{email:t}),new j.APIError("UNAUTHORIZED",{message:eq.n.INVALID_EMAIL_OR_PASSWORD});let a=i?.password;if(!a)throw await e.context.password.hash(r),e.context.logger.error("Password not found",{email:t}),new j.APIError("UNAUTHORIZED",{message:eq.n.INVALID_EMAIL_OR_PASSWORD});if(!await e.context.password.verify({hash:a,password:r}))throw e.context.logger.error("Invalid password"),new j.APIError("UNAUTHORIZED",{message:eq.n.INVALID_EMAIL_OR_PASSWORD});if(e.context.options?.emailAndPassword?.requireEmailVerification&&!o.user.emailVerified){if(!e.context.options?.emailVerification?.sendVerificationEmail)throw new j.APIError("FORBIDDEN",{message:eq.n.EMAIL_NOT_VERIFIED});if(e.context.options?.emailVerification?.sendOnSignIn){let t=await ro(e.context.secret,o.user.email,void 0,e.context.options.emailVerification?.expiresIn),r=e.body.callbackURL?encodeURIComponent(e.body.callbackURL):encodeURIComponent("/"),i=`${e.context.baseURL}/verify-email?token=${t}&callbackURL=${r}`;await e.context.options.emailVerification.sendVerificationEmail({user:o.user,url:i,token:t},e.request)}throw new j.APIError("FORBIDDEN",{message:eq.n.EMAIL_NOT_VERIFIED})}let n=await e.context.internalAdapter.createSession(o.user.id,!1===e.body.rememberMe);if(!n)throw e.context.logger.error("Failed to create session"),new j.APIError("UNAUTHORIZED",{message:eq.n.FAILED_TO_CREATE_SESSION});return await e$(e,{session:n,user:o.user},!1===e.body.rememberMe),e.json({redirect:!!e.body.callbackURL,token:n.token,url:e.body.callbackURL,user:z(e.context.options,o.user)})}),resetPassword:rf,verifyEmail:rn,sendVerificationEmail:ra,changeEmail:rE,changePassword:rg,setPassword:rw,updateUser:eH("/update-user",{method:"POST",operationId:"updateUser",body:Y.record(Y.string().meta({description:"Field name must be a string"}),Y.any()),use:[eY],metadata:{$Infer:{body:{}},openapi:{operationId:"updateUser",description:"Update the current user",requestBody:{content:{"application/json":{schema:{type:"object",properties:{name:{type:"string",description:"The name of the user"},image:{type:"string",description:"The image of the user",nullable:!0}}}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object",$ref:"#/components/schemas/User"}}}}}}}}}},async e=>{let t=e.body;if(t.email)throw new j.APIError("BAD_REQUEST",{message:eq.n.EMAIL_CAN_NOT_BE_UPDATED});let{name:r,image:o,...i}=t,a=e.context.session,n=H(e.context.options,i,"update");if(void 0===o&&void 0===r&&0===Object.keys(n).length)throw new j.APIError("BAD_REQUEST",{message:"No fields to update"});let s=await e.context.internalAdapter.updateUser(a.user.id,{name:r,image:o,...n});return await e$(e,{session:a.session,user:s}),e.json({status:!0})}),deleteUser:ry,requestPasswordReset:ru,requestPasswordResetCallback:rp,listSessions:eH("/list-sessions",{method:"GET",operationId:"listUserSessions",use:[eY],requireHeaders:!0,metadata:{openapi:{operationId:"listUserSessions",description:"List all active sessions for the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"array",items:{$ref:"#/components/schemas/Session"}}}}}}}}},async e=>{try{let t=(await e.context.internalAdapter.listSessions(e.context.session.user.id)).filter(e=>e.expiresAt>new Date);return e.json(t)}catch(t){throw e.context.logger.error(t),e.error("INTERNAL_SERVER_ERROR")}}),revokeSession:eQ,revokeSessions:eJ,revokeOtherSessions:eX,linkSocialAccount:t5,listUserAccounts:t4,deleteUserCallback:rA,unlinkAccount:t3,refreshToken:t9,getAccessToken:t8,accountInfo:t7,...r,ok:rl,error:rc},e),middlewares:o}}async function rk(e,t){let r=(await t.context.internalAdapter.findAccounts(e))?.find(e=>"credential"===e.providerId),o=r?.password;if(!r||!o||!t.body.password)throw new j.APIError("BAD_REQUEST",{message:"No password credential found"});if(!await t.context.password.verify({hash:o,password:t.body.password}))throw new j.APIError("BAD_REQUEST",{message:"Invalid password"});return!0}var rv=Q,ee=Z,ew=Z,ey=Z,W=Z,eq=eq,rR=Z,ew=Z,rU=Z,rS=Z,W=Z,rO=e.i(82318),rx=e.i(39127);async function rD(){if(r)return r;try{let e="undefined"!=typeof process&&"function"==typeof process.cwd?process.cwd():"";if(!e)return;let[{default:t},{default:o}]=await Promise.all([Function("mm","return import(mm)")("fs/promises"),Function("mm","return import(mm)")("path")]),i=await t.readFile(o.join(e,"package.json"),"utf-8");return r=JSON.parse(i)}catch{}}async function rN(e){if(r)return r.dependencies?.[e]||r.devDependencies?.[e]||r.peerDependencies?.[e];try{let t="undefined"!=typeof process&&"function"==typeof process.cwd?process.cwd():"";if(!t)throw Error("no-cwd");let[{default:r},{default:o}]=await Promise.all([Function("mm","return import(mm)")("fs/promises"),Function("mm","return import(mm)")("path")]),i=o.join(t,"node_modules",e,"package.json"),a=await r.readFile(i,"utf-8");return JSON.parse(a).version||await rL(e)||void 0}catch{}return await rL(e)}async function rL(e){let t=await rD();if(t)return({...t.dependencies,...t.devDependencies,...t.peerDependencies})[e]}async function rP(){return(await rD())?.name}let rC={pg:"postgresql",mysql:"mysql",mariadb:"mariadb",sqlite3:"sqlite","better-sqlite3":"sqlite","@prisma/client":"prisma",mongoose:"mongodb",mongodb:"mongodb","drizzle-orm":"drizzle"};async function rj(){for(let[e,t]of Object.entries(rC)){let r=await rN(e);if(r)return{name:t,version:r}}}let r$={next:"next",nuxt:"nuxt","@remix-run/server-runtime":"remix",astro:"astro","@sveltejs/kit":"sveltekit","solid-start":"solid-start","tanstack-start":"tanstack-start",hono:"hono",express:"express",elysia:"elysia",expo:"expo"};async function rV(){for(let[e,t]of Object.entries(r$)){let r=await rN(e);if(r)return{name:t,version:r}}}function rq(){let e=(...e)=>e.some(e=>!!ew.c[e]);return e("CF_PAGES","CF_PAGES_URL","CF_ACCOUNT_ID")||"undefined"!=typeof navigator&&"Cloudflare-Workers"===navigator.userAgent?"cloudflare":e("VERCEL","VERCEL_URL","VERCEL_ENV")?"vercel":e("NETLIFY","NETLIFY_URL")?"netlify":e("RENDER","RENDER_URL","RENDER_INTERNAL_HOSTNAME","RENDER_SERVICE_ID")?"render":e("AWS_LAMBDA_FUNCTION_NAME","AWS_EXECUTION_ENV","LAMBDA_TASK_ROOT")?"aws":e("GOOGLE_CLOUD_FUNCTION_NAME","GOOGLE_CLOUD_PROJECT","GCP_PROJECT","K_SERVICE")?"gcp":e("AZURE_FUNCTION_NAME","FUNCTIONS_WORKER_RUNTIME","WEBSITE_INSTANCE_ID","WEBSITE_SITE_NAME")?"azure":e("DENO_DEPLOYMENT_ID","DENO_REGION")?"deno-deploy":e("FLY_APP_NAME","FLY_REGION","FLY_ALLOC_ID")?"fly-io":e("RAILWAY_STATIC_URL","RAILWAY_ENVIRONMENT_NAME")?"railway":e("DYNO","HEROKU_APP_NAME")?"heroku":e("DO_DEPLOYMENT_ID","DO_APP_NAME","DIGITALOCEAN")?"digitalocean":e("KOYEB","KOYEB_DEPLOYMENT_ID","KOYEB_APP_NAME")?"koyeb":null}async function rM(){try{if("cloudflare"===rq())return"cloudflare";let e=await Function("mm","return import(mm)")("os"),t=e.cpus();return{deploymentVendor:rq(),systemPlatform:e.platform(),systemRelease:e.release(),systemArchitecture:e.arch(),cpuCount:t.length,cpuModel:t.length?t[0].model:null,cpuSpeed:t.length?t[0].speed:null,memory:e.totalmem(),isWSL:await rH(),isDocker:await rF(),isTTY:"undefined"!=typeof process&&process.stdout?process.stdout.isTTY:null}}catch(e){return{systemPlatform:null,systemRelease:null,systemArchitecture:null,cpuCount:null,cpuModel:null,cpuSpeed:null,memory:null,isWSL:null,isDocker:null,isTTY:null}}}async function rz(){if("cloudflare"===rq())return!1;try{return(await Function("mm","return import(mm)")("fs")).statSync("/.dockerenv"),!0}catch{return!1}}async function rB(){if("cloudflare"===rq())return!1;try{return(await Function("mm","return import(mm)")("fs")).readFileSync("/proc/self/cgroup","utf8").includes("docker")}catch{return!1}}async function rF(){return"cloudflare"!==rq()&&(void 0===o&&(o=await rz()||await rB()),o)}async function rH(){try{if("cloudflare"===rq()||"undefined"==typeof process||process?.platform!=="linux")return!1;let e=await Function("mm","return import(mm)")("fs");if((await Function("mm","return import(mm)")("os")).release().toLowerCase().includes("microsoft")){if(await rW())return!1;return!0}return!!e.readFileSync("/proc/version","utf8").toLowerCase().includes("microsoft")&&!await rW()}catch{return!1}}let rZ=async()=>{if("cloudflare"===rq())return!1;try{return(await Function("mm","return import(mm)")("fs")).statSync("/run/.containerenv"),!0}catch{return!1}};async function rW(){return void 0===i&&(i=await rZ()||await rF()),i}async function rY(e){let t=await (0,rO.createHash)("SHA-256").digest(e);return eA.base64.encode(t)}let rK=null;async function rG(e){if(rK)return rK;let t=await rP();return t?rK=await rY(e?e+t:t):e?rK=await rY(e):rK=(0,rx.createRandomStringGenerator)("a-z","A-Z","0-9")(32)}async function rQ(e,t){let r,o=e.telemetry?.debug||(0,rU.l)("BETTER_AUTH_TELEMETRY_DEBUG",!1),i=rR.s.BETTER_AUTH_TELEMETRY_ENDPOINT,a=async e=>{t?.customTrack?await t.customTrack(e).catch(et.logger.error):o?et.logger.info("telemetry event",JSON.stringify(e,null,2)):await tw(i,{method:"POST",body:e}).catch(et.logger.error)},n=async()=>{let r=e.telemetry?.enabled!==void 0&&e.telemetry.enabled;return((0,rU.l)("BETTER_AUTH_TELEMETRY",!1)||r)&&(t?.skipTestCheck||!(0,W.p)())},s=await n();s&&(r=await rG(e.baseURL),a({type:"init",payload:{config:{database:t?.database,adapter:t?.adapter,emailVerification:{sendVerificationEmail:!!e.emailVerification?.sendVerificationEmail,sendOnSignUp:!!e.emailVerification?.sendOnSignUp,sendOnSignIn:!!e.emailVerification?.sendOnSignIn,autoSignInAfterVerification:!!e.emailVerification?.autoSignInAfterVerification,expiresIn:e.emailVerification?.expiresIn,onEmailVerification:!!e.emailVerification?.onEmailVerification,afterEmailVerification:!!e.emailVerification?.afterEmailVerification},emailAndPassword:{enabled:!!e.emailAndPassword?.enabled,disableSignUp:!!e.emailAndPassword?.disableSignUp,requireEmailVerification:!!e.emailAndPassword?.requireEmailVerification,maxPasswordLength:e.emailAndPassword?.maxPasswordLength,minPasswordLength:e.emailAndPassword?.minPasswordLength,sendResetPassword:!!e.emailAndPassword?.sendResetPassword,resetPasswordTokenExpiresIn:e.emailAndPassword?.resetPasswordTokenExpiresIn,onPasswordReset:!!e.emailAndPassword?.onPasswordReset,password:{hash:!!e.emailAndPassword?.password?.hash,verify:!!e.emailAndPassword?.password?.verify},autoSignIn:!!e.emailAndPassword?.autoSignIn,revokeSessionsOnPasswordReset:!!e.emailAndPassword?.revokeSessionsOnPasswordReset},socialProviders:Object.keys(e.socialProviders||{}).map(t=>{let r=e.socialProviders?.[t];return r?{id:t,mapProfileToUser:!!r.mapProfileToUser,disableDefaultScope:!!r.disableDefaultScope,disableIdTokenSignIn:!!r.disableIdTokenSignIn,disableImplicitSignUp:r.disableImplicitSignUp,disableSignUp:r.disableSignUp,getUserInfo:!!r.getUserInfo,overrideUserInfoOnSignIn:!!r.overrideUserInfoOnSignIn,prompt:r.prompt,verifyIdToken:!!r.verifyIdToken,scope:r.scope,refreshAccessToken:!!r.refreshAccessToken}:{}}),plugins:e.plugins?.map(e=>e.id.toString()),user:{modelName:e.user?.modelName,fields:e.user?.fields,additionalFields:e.user?.additionalFields,changeEmail:{enabled:e.user?.changeEmail?.enabled,sendChangeEmailVerification:!!e.user?.changeEmail?.sendChangeEmailVerification}},verification:{modelName:e.verification?.modelName,disableCleanup:e.verification?.disableCleanup,fields:e.verification?.fields},session:{modelName:e.session?.modelName,additionalFields:e.session?.additionalFields,cookieCache:{enabled:e.session?.cookieCache?.enabled,maxAge:e.session?.cookieCache?.maxAge,strategy:e.session?.cookieCache?.strategy},disableSessionRefresh:e.session?.disableSessionRefresh,expiresIn:e.session?.expiresIn,fields:e.session?.fields,freshAge:e.session?.freshAge,preserveSessionInDatabase:e.session?.preserveSessionInDatabase,storeSessionInDatabase:e.session?.storeSessionInDatabase,updateAge:e.session?.updateAge},account:{modelName:e.account?.modelName,fields:e.account?.fields,encryptOAuthTokens:e.account?.encryptOAuthTokens,updateAccountOnSignIn:e.account?.updateAccountOnSignIn,accountLinking:{enabled:e.account?.accountLinking?.enabled,trustedProviders:e.account?.accountLinking?.trustedProviders,updateUserInfoOnLink:e.account?.accountLinking?.updateUserInfoOnLink,allowUnlinkingAll:e.account?.accountLinking?.allowUnlinkingAll}},hooks:{after:!!e.hooks?.after,before:!!e.hooks?.before},secondaryStorage:!!e.secondaryStorage,advanced:{cookiePrefix:!!e.advanced?.cookiePrefix,cookies:!!e.advanced?.cookies,crossSubDomainCookies:{domain:!!e.advanced?.crossSubDomainCookies?.domain,enabled:e.advanced?.crossSubDomainCookies?.enabled,additionalCookies:e.advanced?.crossSubDomainCookies?.additionalCookies},database:{useNumberId:!!e.advanced?.database?.useNumberId||e.advanced?.database?.generateId==="serial",generateId:e.advanced?.database?.generateId,defaultFindManyLimit:e.advanced?.database?.defaultFindManyLimit},useSecureCookies:e.advanced?.useSecureCookies,ipAddress:{disableIpTracking:e.advanced?.ipAddress?.disableIpTracking,ipAddressHeaders:e.advanced?.ipAddress?.ipAddressHeaders},disableCSRFCheck:e.advanced?.disableCSRFCheck,cookieAttributes:{expires:e.advanced?.defaultCookieAttributes?.expires,secure:e.advanced?.defaultCookieAttributes?.secure,sameSite:e.advanced?.defaultCookieAttributes?.sameSite,domain:!!e.advanced?.defaultCookieAttributes?.domain,path:e.advanced?.defaultCookieAttributes?.path,httpOnly:e.advanced?.defaultCookieAttributes?.httpOnly}},trustedOrigins:e.trustedOrigins?.length,rateLimit:{storage:e.rateLimit?.storage,modelName:e.rateLimit?.modelName,window:e.rateLimit?.window,customStorage:!!e.rateLimit?.customStorage,enabled:e.rateLimit?.enabled,max:e.rateLimit?.max},onAPIError:{errorURL:e.onAPIError?.errorURL,onError:!!e.onAPIError?.onError,throw:e.onAPIError?.throw},logger:{disabled:e.logger?.disabled,level:e.logger?.level,log:!!e.logger?.log},databaseHooks:{user:{create:{after:!!e.databaseHooks?.user?.create?.after,before:!!e.databaseHooks?.user?.create?.before},update:{after:!!e.databaseHooks?.user?.update?.after,before:!!e.databaseHooks?.user?.update?.before}},session:{create:{after:!!e.databaseHooks?.session?.create?.after,before:!!e.databaseHooks?.session?.create?.before},update:{after:!!e.databaseHooks?.session?.update?.after,before:!!e.databaseHooks?.session?.update?.before}},account:{create:{after:!!e.databaseHooks?.account?.create?.after,before:!!e.databaseHooks?.account?.create?.before},update:{after:!!e.databaseHooks?.account?.update?.after,before:!!e.databaseHooks?.account?.update?.before}},verification:{create:{after:!!e.databaseHooks?.verification?.create?.after,before:!!e.databaseHooks?.verification?.create?.before},update:{after:!!e.databaseHooks?.verification?.update?.after,before:!!e.databaseHooks?.verification?.update?.before}}}},runtime:"undefined"!=typeof Deno?{name:"deno",version:Deno?.version?.deno??null}:"undefined"!=typeof Bun?{name:"bun",version:Bun?.version??null}:"undefined"!=typeof process&&process?.versions?.node?{name:"node",version:process.versions.node??null}:{name:"edge",version:null},database:await rj(),framework:await rV(),environment:"production"===(0,rS.u)("NODE_ENV")?"production":"false"!==ew.c.CI&&("BUILD_ID"in ew.c||"BUILD_NUMBER"in ew.c||"CI"in ew.c||"CI_APP_ID"in ew.c||"CI_BUILD_ID"in ew.c||"CI_BUILD_NUMBER"in ew.c||"CI_NAME"in ew.c||"CONTINUOUS_INTEGRATION"in ew.c||"RUN_ID"in ew.c)?"ci":(0,W.p)()?"test":"development",systemInfo:await rM(),packageManager:function(){let e=ew.c.npm_config_user_agent;if(!e)return;let t=e.split(" ")[0],r=t.lastIndexOf("/"),o=t.substring(0,r);return{name:"npminstall"===o?"cnpm":o,version:t.substring(r+1)}}()},anonymousId:r}));return{publish:async t=>{s&&(r||(r=await rG(e.baseURL)),await a({type:t.type,payload:t.payload,anonymousId:r}))}}}let rJ="better-auth-secret-12345678901234567890";function rX(e){return!!e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof e.then}async function r0(e){let t=e.options,r=t.plugins||[],o=e,i=[];for(let e of r)if(e.init){let r,a=e.init(o);if("object"==typeof(r=rX(a)?await a:a)){if(r.options){let{databaseHooks:e,...o}=r.options;e&&i.push(e),t=tY(t,o)}r.context&&(o={...o,...r.context})}}return i.push(t.databaseHooks),o.internalAdapter=es(o.adapter,{options:t,logger:o.logger,hooks:i.filter(e=>void 0!==e),generateId:o.generateId}),o.options=t,{context:o}}async function r1(e,t,r){var o,i;let a,n,s,c,l,d,u,p;t.database||(t=tY(t,{session:{cookieCache:{enabled:!0,strategy:"jwe",refreshCache:!0}},account:{storeStateStrategy:"cookie",storeAccountCookie:!0}}));let f=t.plugins||[],m=(o=t,o.advanced?.crossSubDomainCookies?.enabled,[]),h=(0,ee.n)(t.logger),g=ef(t.baseURL,t.basePath),w=t.secret||ew.c.BETTER_AUTH_SECRET||ew.c.AUTH_SECRET||rJ,y=w===rJ;if(!(0,W.p)()){let e;if(y&&ey.f)throw new er.BetterAuthError("You are using the default secret. Please set `BETTER_AUTH_SECRET` in your environment variables or pass `secret` in your auth config.");if(!w)throw new er.BetterAuthError("BETTER_AUTH_SECRET is missing. Set it in your environment or pass `secret` to betterAuth({ secret }).");if(w.length<32)throw new er.BetterAuthError("Invalid BETTER_AUTH_SECRET: must be at least 32 characters long for adequate security. Generate one with `npx @better-auth/cli secret` or `openssl rand -base64 32`.");120>(0===(e=new Set(w).size)?0:Math.log2(Math.pow(e,w.length)))&&h.warn("[better-auth] Warning: your BETTER_AUTH_SECRET appears low-entropy. Use a randomly generated secret for production.")}!function(e,t){let r=new Map;e.plugins?.forEach(e=>{if(e.endpoints){for(let[t,o]of Object.entries(e.endpoints))if(o&&"path"in o){let i=o.path,a=[];o.options&&"method"in o.options&&(Array.isArray(o.options.method)?a=o.options.method:"string"==typeof o.options.method&&(a=[o.options.method])),0===a.length&&(a=["*"]),r.has(i)||r.set(i,[]),r.get(i).push({pluginId:e.id,endpointKey:t,methods:a})}}});let o=[];for(let[e,t]of r.entries())if(t.length>1){let r=new Map,i=!1;for(let e of t)for(let o of e.methods)r.has(o)||r.set(o,[]),r.get(o).push(e.pluginId),r.get(o).length>1&&(i=!0),"*"===o&&t.length>1?i=!0:"*"!==o&&r.has("*")&&(i=!0);if(i){let i=[...new Set(t.map(e=>e.pluginId))],a=[];for(let[e,o]of r.entries())(o.length>1||"*"===e&&t.length>1||"*"!==e&&r.has("*"))&&a.push(e);o.push({path:e,plugins:i,conflictingMethods:a})}}if(o.length>0){let e=o.map(e=>`  - "${e.path}" [${e.conflictingMethods.join(", ")}] used by plugins: ${e.plugins.join(", ")}`).join("\n");t.error(`Endpoint path conflicts detected! Multiple plugins are trying to use the same endpoint paths with conflicting HTTP methods:
${e}

To resolve this, you can:
	1. Use only one of the conflicting plugins
	2. Configure the plugins to use different paths (if supported)
	3. Ensure plugins use different HTTP methods for the same path
`)}}(t={...t,secret:w,baseURL:g?new URL(g).origin:"",basePath:t.basePath||"/api/auth",plugins:f.concat(m)},h);let A=(s=(n=eC(i=t))("session_token",{maxAge:i.session?.expiresIn||ek("7d")/1e3}),c=n("session_data",{maxAge:i.session?.cookieCache?.maxAge||300}),l=n("account_data",{maxAge:i.session?.cookieCache?.maxAge||300}),d=n("dont_remember"),{sessionToken:{name:s.name,options:s.attributes},sessionData:{name:c.name,options:c.attributes},dontRememberToken:{name:d.name,options:d.attributes},accountData:{name:l.name,options:l.attributes}}),E=(0,P.a)(t),T=Object.entries(t.socialProviders||{}).map(([e,t])=>{if(null==t||!1===t.enabled)return null;t.clientId||h.warn(`Social provider ${e} is missing clientId or clientSecret`);let r=tB[e](t);return r.disableImplicitSignUp=t.disableImplicitSignUp,r}).filter(e=>null!==e),I=({model:e,size:r})=>"function"==typeof t.advanced?.generateId?t.advanced.generateId({model:e,size:r}):"function"==typeof t?.advanced?.database?.generateId?t.advanced.database.generateId({model:e,size:r}):(0,C.t)(r),{publish:b}=await rQ(t,{adapter:e.id,database:"function"==typeof t.database?"adapter":r(t.database)}),_=r0({appName:t.appName||"Better Auth",socialProviders:T,options:t,oauthConfig:{storeStateStrategy:t.account?.storeStateStrategy||"database",skipStateCookieCheck:!!t.account?.skipStateCookieCheck},tables:E,trustedOrigins:function(e){let t=ef(e.baseURL,e.basePath);if(!t)return[];let r=[new URL(t).origin];e.trustedOrigins&&Array.isArray(e.trustedOrigins)&&r.push(...e.trustedOrigins);let o=ew.c.BETTER_AUTH_TRUSTED_ORIGINS;if(o&&r.push(...o.split(",")),r.filter(e=>!e).length)throw new er.BetterAuthError("A provided trusted origin is invalid, make sure your trusted origins list is properly defined.");return r}(t),baseURL:g||"",sessionConfig:{updateAge:t.session?.updateAge!==void 0?t.session.updateAge:86400,expiresIn:t.session?.expiresIn||604800,freshAge:t.session?.freshAge===void 0?86400:t.session.freshAge,cookieRefreshCache:(u=t.session?.cookieCache?.refreshCache,p=t.session?.cookieCache?.maxAge||300,!1!==u&&void 0!==u&&(!0===u?{enabled:!0,updateAge:Math.floor(.2*p)}:{enabled:!0,updateAge:void 0!==u.updateAge?u.updateAge:Math.floor(.2*p)}))},secret:w,rateLimit:{...t.rateLimit,enabled:t.rateLimit?.enabled??ey.f,window:t.rateLimit?.window||10,max:t.rateLimit?.max||100,storage:t.rateLimit?.storage||(t.secondaryStorage?"secondary-storage":"memory")},authCookies:A,logger:h,generateId:I,session:null,secondaryStorage:t.secondaryStorage,password:{hash:t.emailAndPassword?.password?.hash||eu.i,verify:t.emailAndPassword?.password?.verify||eu.a,config:{minPasswordLength:t.emailAndPassword?.minPasswordLength||8,maxPasswordLength:t.emailAndPassword?.maxPasswordLength||128},checkPassword:rk},setNewSession(e){this.newSession=e},newSession:null,adapter:e,internalAdapter:es(e,{options:t,logger:h,hooks:t.databaseHooks?[t.databaseHooks]:[],generateId:I}),createAuthCookie:eC(t),async runMigrations(){throw new er.BetterAuthError("runMigrations will be set by the specific init implementation")},publishTelemetry:b,skipCSRFCheck:!!t.advanced?.disableCSRFCheck,skipOriginCheck:t.advanced?.disableOriginCheck!==void 0?t.advanced.disableOriginCheck:!!(0,W.p)()});return rX(_)?{context:a}=await _:{context:a}=_,a}let r2=async e=>{let t=await en(e),r=await r1(t,e,e=>(0,L.n)(e)||"unknown");return r.runMigrations=async function(){if(!e.database||"updateMany"in e.database)throw new er.BetterAuthError("Database is not provided or it's an adapter. Migrations are only supported with a database instance.");let{runMigrations:t}=await ed(e);await t()},r};var Q=Q;let r6=Y.object({id:Y.string(),createdAt:Y.date().default(()=>new Date),updatedAt:Y.date().default(()=>new Date)});r6.extend({providerId:Y.string(),accountId:Y.string(),userId:ei.coerce.string(),accessToken:Y.string().nullish(),refreshToken:Y.string().nullish(),idToken:Y.string().nullish(),accessTokenExpiresAt:Y.date().nullish(),refreshTokenExpiresAt:Y.date().nullish(),scope:Y.string().nullish(),password:Y.string().nullish()}),Y.object({key:Y.string(),count:Y.number(),lastRequest:Y.number()}),r6.extend({userId:ei.coerce.string(),expiresAt:Y.date(),token:Y.string(),ipAddress:Y.string().nullish(),userAgent:Y.string().nullish()}),r6.extend({email:Y.string().transform(e=>e.toLowerCase()),emailVerified:Y.boolean().default(!1),name:Y.string(),image:Y.string().nullish()}),r6.extend({value:Y.string(),expiresAt:Y.date(),identifier:Y.string()});var r4=e.i(48411),r5=e.i(75225),r3=e.i(49129);e.i(56325),e.i(44988);var r8=e.i(18899);function r9(e){return{newRole:e=>{var t;return{authorize(e,r="AND"){let o=!1;for(let[i,a]of Object.entries(e)){let e=t[i];if(!e)return{success:!1,error:`You are not allowed to access resource: ${i}`};if(Array.isArray(a))o=a.every(t=>e.includes(t));else if("object"==typeof a)o="OR"===a.connector?a.actions.some(t=>e.includes(t)):a.actions.every(t=>e.includes(t));else throw new er.BetterAuthError("Invalid access control request");if(o&&"OR"===r)return{success:o};if(!o&&"AND"===r)return{success:!1,error:`unauthorized to access resource "${i}"`}}return o?{success:o}:{success:!1,error:"Not authorized"}},statements:t=e}},statements:e}}let r7=r9({user:["create","list","set-role","ban","impersonate","delete","set-password","get","update"],session:["list","revoke","delete"]});r7.newRole({user:["create","list","set-role","ban","impersonate","delete","set-password","get","update"],session:["list","revoke","delete"]}),r7.newRole({user:[],session:[]});let oe=r9({organization:["update","delete"],member:["create","update","delete"],invitation:["create","cancel"],team:["create","update","delete"],ac:["create","read","update","delete"]});oe.newRole({organization:["update"],invitation:["create","cancel"],member:["create","update","delete"],team:["create","update","delete"],ac:["create","read","update","delete"]}),oe.newRole({organization:["update","delete"],member:["create","update","delete"],invitation:["create","cancel"],team:["create","update","delete"],ac:["create","read","update","delete"]}),oe.newRole({organization:[],member:[],invitation:[],team:[],ac:["read"]});var eq=eq,ot=tb;(0,ot.t)({FAILED_TO_CREATE_USER:"Failed to create user",USER_ALREADY_EXISTS:"User already exists.",USER_ALREADY_EXISTS_USE_ANOTHER_EMAIL:"User already exists. Use another email.",YOU_CANNOT_BAN_YOURSELF:"You cannot ban yourself",YOU_ARE_NOT_ALLOWED_TO_CHANGE_USERS_ROLE:"You are not allowed to change users role",YOU_ARE_NOT_ALLOWED_TO_CREATE_USERS:"You are not allowed to create users",YOU_ARE_NOT_ALLOWED_TO_LIST_USERS:"You are not allowed to list users",YOU_ARE_NOT_ALLOWED_TO_LIST_USERS_SESSIONS:"You are not allowed to list users sessions",YOU_ARE_NOT_ALLOWED_TO_BAN_USERS:"You are not allowed to ban users",YOU_ARE_NOT_ALLOWED_TO_IMPERSONATE_USERS:"You are not allowed to impersonate users",YOU_ARE_NOT_ALLOWED_TO_REVOKE_USERS_SESSIONS:"You are not allowed to revoke users sessions",YOU_ARE_NOT_ALLOWED_TO_DELETE_USERS:"You are not allowed to delete users",YOU_ARE_NOT_ALLOWED_TO_SET_USERS_PASSWORD:"You are not allowed to set users password",BANNED_USER:"You have been banned from this application",YOU_ARE_NOT_ALLOWED_TO_GET_USER:"You are not allowed to get user",NO_DATA_TO_UPDATE:"No data to update",YOU_ARE_NOT_ALLOWED_TO_UPDATE_USERS:"You are not allowed to update users",YOU_CANNOT_REMOVE_YOURSELF:"You cannot remove yourself",YOU_ARE_NOT_ALLOWED_TO_SET_NON_EXISTENT_VALUE:"You are not allowed to set a non-existent role value"});var ot=tb;(0,ot.t)({INVALID_EMAIL_FORMAT:"Email was not generated in a valid format",FAILED_TO_CREATE_USER:"Failed to create user",COULD_NOT_CREATE_SESSION:"Could not create session",ANONYMOUS_USERS_CANNOT_SIGN_IN_AGAIN_ANONYMOUSLY:"Anonymous users cannot sign in again anonymously"});var J=Q;e.i(27957),e.i(82100);var J=Q;j.APIError,Y.object({clientId:Y.string(),clientSecret:Y.string().optional(),type:Y.enum(["web","native","user-agent-based","public"]),name:Y.string(),icon:Y.string().optional(),metadata:Y.string().optional(),disabled:Y.boolean().optional().default(!1),redirectUrls:Y.string(),userId:Y.string().optional(),createdAt:Y.date(),updatedAt:Y.date()});var ey=Z,ot=tb;(0,ot.t)({INVALID_METADATA_TYPE:"metadata must be an object or undefined",REFILL_AMOUNT_AND_INTERVAL_REQUIRED:"refillAmount is required when refillInterval is provided",REFILL_INTERVAL_AND_AMOUNT_REQUIRED:"refillInterval is required when refillAmount is provided",USER_BANNED:"User is banned",UNAUTHORIZED_SESSION:"Unauthorized or invalid session",KEY_NOT_FOUND:"API Key not found",KEY_DISABLED:"API Key is disabled",KEY_EXPIRED:"API Key has expired",USAGE_EXCEEDED:"API Key has reached its usage limit",KEY_NOT_RECOVERABLE:"API Key is not recoverable",EXPIRES_IN_IS_TOO_SMALL:"The expiresIn is smaller than the predefined minimum value.",EXPIRES_IN_IS_TOO_LARGE:"The expiresIn is larger than the predefined maximum value.",INVALID_REMAINING:"The remaining count is either too large or too small.",INVALID_PREFIX_LENGTH:"The prefix length is either too large or too small.",INVALID_NAME_LENGTH:"The name length is either too large or too small.",METADATA_DISABLED:"Metadata is disabled.",RATE_LIMIT_EXCEEDED:"Rate limit exceeded.",NO_VALUES_TO_UPDATE:"No values to update.",KEY_DISABLED_EXPIRATION:"Custom key expiration values are disabled.",INVALID_API_KEY:"Invalid API key.",INVALID_USER_ID_FROM_API_KEY:"The user id from the API key is invalid.",INVALID_API_KEY_GETTER_RETURN_TYPE:"API Key getter returned an invalid key type. Expected string.",SERVER_ONLY_PROPERTY:"The property you're trying to set can only be set from the server auth instance only.",FAILED_TO_UPDATE_API_KEY:"Failed to update API key",NAME_REQUIRED:"API Key name is required."});var ot=tb;(0,ot.t)({VERIFICATION_FAILED:"Captcha verification failed",MISSING_RESPONSE:"Missing CAPTCHA response",UNKNOWN_ERROR:"Something went wrong"}),(0,ot.t)({MISSING_SECRET_KEY:"Missing secret key",SERVICE_UNAVAILABLE:"CAPTCHA service unavailable"}),Y.optional(Y.object({disableCookieCache:Y.boolean().meta({description:"Disable cookie cache and fetch session from database"}).or(Y.string().transform(e=>"true"===e)).optional(),disableRefresh:Y.boolean().meta({description:"Disable session refresh. Useful for checking session status, without updating the session"}).optional()}));var ot=tb;(0,ot.t)({INVALID_DEVICE_CODE:"Invalid device code",EXPIRED_DEVICE_CODE:"Device code has expired",EXPIRED_USER_CODE:"User code has expired",AUTHORIZATION_PENDING:"Authorization pending",ACCESS_DENIED:"Access denied",INVALID_USER_CODE:"Invalid user code",DEVICE_CODE_ALREADY_PROCESSED:"Device code already processed",POLLING_TOO_FREQUENTLY:"Polling too frequently",USER_NOT_FOUND:"User not found",FAILED_TO_CREATE_SESSION:"Failed to create session",INVALID_DEVICE_CODE_STATUS:"Invalid device code status",AUTHENTICATION_REQUIRED:"Authentication required"}),Y.object({id:Y.string(),deviceCode:Y.string(),userCode:Y.string(),userId:Y.string().optional(),expiresAt:Y.date(),status:Y.string(),lastPolledAt:Y.date().optional(),pollingInterval:Y.number().optional(),clientId:Y.string().optional(),scope:Y.string().optional()});let or=Y.custom(e=>{try{ek(e)}catch(e){return!1}return!0},{message:"Invalid time string format. Use formats like '30m', '5s', '1h', etc."});Y.object({expiresIn:or.default("30m").describe("Time in seconds until the device code expires. Use formats like '30m', '5s', '1h', etc."),interval:or.default("5s").describe("Time in seconds between polling attempts. Use formats like '30m', '5s', '1h', etc."),deviceCodeLength:Y.number().int().positive().default(40).describe("Length of the device code to be generated. Default is 40 characters."),userCodeLength:Y.number().int().positive().default(8).describe("Length of the user code to be generated. Default is 8 characters."),generateDeviceCode:Y.custom(e=>"function"==typeof e,{message:"generateDeviceCode must be a function that returns a string or a promise that resolves to a string."}).optional().describe("Function to generate a device code. If not provided, a default random string generator will be used."),generateUserCode:Y.custom(e=>"function"==typeof e,{message:"generateUserCode must be a function that returns a string or a promise that resolves to a string."}).optional().describe("Function to generate a user code. If not provided, a default random string generator will be used."),validateClient:Y.custom(e=>"function"==typeof e,{message:"validateClient must be a function that returns a boolean or a promise that resolves to a boolean."}).optional().describe("Function to validate the client ID. If not provided, no validation will be performed."),onDeviceAuthRequest:Y.custom(e=>"function"==typeof e,{message:"onDeviceAuthRequest must be a function that returns void or a promise that resolves to void."}).optional().describe("Function to handle device authorization requests. If not provided, no additional actions will be taken."),verificationUri:Y.string().optional().describe("The URI where users verify their device code. Can be an absolute URL (https://example.com/device) or relative path (/custom-path). This will be returned as verification_uri in the device code response. If not provided, defaults to /device."),schema:Y.custom(()=>!0)});var eq=eq,ot=tb;(0,ot.t)({OTP_EXPIRED:"OTP expired",INVALID_OTP:"Invalid OTP",TOO_MANY_ATTEMPTS:"Too many attempts"});var eq=eq,ot=tb;(0,ot.t)({INVALID_OAUTH_CONFIGURATION:"Invalid OAuth configuration",TOKEN_URL_NOT_FOUND:"Invalid OAuth configuration. Token URL not found.",PROVIDER_CONFIG_NOT_FOUND:"No config found for provider",PROVIDER_ID_REQUIRED:"Provider ID is required",INVALID_OAUTH_CONFIG:"Invalid OAuth configuration.",SESSION_REQUIRED:"Session is required"});var J=Q,ot=tb;(0,ot.t)({PASSWORD_COMPROMISED:"The password you entered has been compromised. Please choose a different password."});var ot=tb;(0,ot.t)({INVALID_SESSION_TOKEN:"Invalid session token"});var ew=Z,Q=Q,eq=eq,ot=tb;eB(async()=>({})),eB({use:[eY]},async e=>({session:e.context.session})),(0,ot.t)({YOU_ARE_NOT_ALLOWED_TO_CREATE_A_NEW_ORGANIZATION:"You are not allowed to create a new organization",YOU_HAVE_REACHED_THE_MAXIMUM_NUMBER_OF_ORGANIZATIONS:"You have reached the maximum number of organizations",ORGANIZATION_ALREADY_EXISTS:"Organization already exists",ORGANIZATION_SLUG_ALREADY_TAKEN:"Organization slug already taken",ORGANIZATION_NOT_FOUND:"Organization not found",USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION:"User is not a member of the organization",YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_ORGANIZATION:"You are not allowed to update this organization",YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_ORGANIZATION:"You are not allowed to delete this organization",NO_ACTIVE_ORGANIZATION:"No active organization",USER_IS_ALREADY_A_MEMBER_OF_THIS_ORGANIZATION:"User is already a member of this organization",MEMBER_NOT_FOUND:"Member not found",ROLE_NOT_FOUND:"Role not found",YOU_ARE_NOT_ALLOWED_TO_CREATE_A_NEW_TEAM:"You are not allowed to create a new team",TEAM_ALREADY_EXISTS:"Team already exists",TEAM_NOT_FOUND:"Team not found",YOU_CANNOT_LEAVE_THE_ORGANIZATION_AS_THE_ONLY_OWNER:"You cannot leave the organization as the only owner",YOU_CANNOT_LEAVE_THE_ORGANIZATION_WITHOUT_AN_OWNER:"You cannot leave the organization without an owner",YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_MEMBER:"You are not allowed to delete this member",YOU_ARE_NOT_ALLOWED_TO_INVITE_USERS_TO_THIS_ORGANIZATION:"You are not allowed to invite users to this organization",USER_IS_ALREADY_INVITED_TO_THIS_ORGANIZATION:"User is already invited to this organization",INVITATION_NOT_FOUND:"Invitation not found",YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION:"You are not the recipient of the invitation",EMAIL_VERIFICATION_REQUIRED_BEFORE_ACCEPTING_OR_REJECTING_INVITATION:"Email verification required before accepting or rejecting invitation",YOU_ARE_NOT_ALLOWED_TO_CANCEL_THIS_INVITATION:"You are not allowed to cancel this invitation",INVITER_IS_NO_LONGER_A_MEMBER_OF_THE_ORGANIZATION:"Inviter is no longer a member of the organization",YOU_ARE_NOT_ALLOWED_TO_INVITE_USER_WITH_THIS_ROLE:"You are not allowed to invite a user with this role",FAILED_TO_RETRIEVE_INVITATION:"Failed to retrieve invitation",YOU_HAVE_REACHED_THE_MAXIMUM_NUMBER_OF_TEAMS:"You have reached the maximum number of teams",UNABLE_TO_REMOVE_LAST_TEAM:"Unable to remove last team",YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_MEMBER:"You are not allowed to update this member",ORGANIZATION_MEMBERSHIP_LIMIT_REACHED:"Organization membership limit reached",YOU_ARE_NOT_ALLOWED_TO_CREATE_TEAMS_IN_THIS_ORGANIZATION:"You are not allowed to create teams in this organization",YOU_ARE_NOT_ALLOWED_TO_DELETE_TEAMS_IN_THIS_ORGANIZATION:"You are not allowed to delete teams in this organization",YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_TEAM:"You are not allowed to update this team",YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_TEAM:"You are not allowed to delete this team",INVITATION_LIMIT_REACHED:"Invitation limit reached",TEAM_MEMBER_LIMIT_REACHED:"Team member limit reached",USER_IS_NOT_A_MEMBER_OF_THE_TEAM:"User is not a member of the team",YOU_CAN_NOT_ACCESS_THE_MEMBERS_OF_THIS_TEAM:"You are not allowed to list the members of this team",YOU_DO_NOT_HAVE_AN_ACTIVE_TEAM:"You do not have an active team",YOU_ARE_NOT_ALLOWED_TO_CREATE_A_NEW_TEAM_MEMBER:"You are not allowed to create a new member",YOU_ARE_NOT_ALLOWED_TO_REMOVE_A_TEAM_MEMBER:"You are not allowed to remove a team member",YOU_ARE_NOT_ALLOWED_TO_ACCESS_THIS_ORGANIZATION:"You are not allowed to access this organization as an owner",YOU_ARE_NOT_A_MEMBER_OF_THIS_ORGANIZATION:"You are not a member of this organization",MISSING_AC_INSTANCE:"Dynamic Access Control requires a pre-defined ac instance on the server auth plugin. Read server logs for more information",YOU_MUST_BE_IN_AN_ORGANIZATION_TO_CREATE_A_ROLE:"You must be in an organization to create a role",YOU_ARE_NOT_ALLOWED_TO_CREATE_A_ROLE:"You are not allowed to create a role",YOU_ARE_NOT_ALLOWED_TO_UPDATE_A_ROLE:"You are not allowed to update a role",YOU_ARE_NOT_ALLOWED_TO_DELETE_A_ROLE:"You are not allowed to delete a role",YOU_ARE_NOT_ALLOWED_TO_READ_A_ROLE:"You are not allowed to read a role",YOU_ARE_NOT_ALLOWED_TO_LIST_A_ROLE:"You are not allowed to list a role",YOU_ARE_NOT_ALLOWED_TO_GET_A_ROLE:"You are not allowed to get a role",TOO_MANY_ROLES:"This organization has too many roles",INVALID_RESOURCE:"The provided permission includes an invalid resource",ROLE_NAME_IS_ALREADY_TAKEN:"That role name is already taken",CANNOT_DELETE_A_PRE_DEFINED_ROLE:"Cannot delete a pre-defined role"});let oo=Y.string(),oi=Y.enum(["pending","accepted","rejected","canceled"]).default("pending");Y.object({id:Y.string().default(C.t),name:Y.string(),slug:Y.string(),logo:Y.string().nullish().optional(),metadata:Y.record(Y.string(),Y.unknown()).or(Y.string().transform(e=>JSON.parse(e))).optional(),createdAt:Y.date()}),Y.object({id:Y.string().default(C.t),organizationId:Y.string(),userId:ei.coerce.string(),role:oo,createdAt:Y.date().default(()=>new Date)}),Y.object({id:Y.string().default(C.t),organizationId:Y.string(),email:Y.string(),role:oo,status:oi,teamId:Y.string().nullish(),inviterId:Y.string(),expiresAt:Y.date(),createdAt:Y.date().default(()=>new Date)}),Y.object({id:Y.string().default(C.t),name:Y.string().min(1),organizationId:Y.string(),createdAt:Y.date(),updatedAt:Y.date().optional()}),Y.object({id:Y.string().default(C.t),teamId:Y.string(),userId:Y.string(),createdAt:Y.date().default(()=>new Date)}),Y.object({id:Y.string().default(C.t),organizationId:Y.string(),role:Y.string(),permission:Y.record(Y.string(),Y.array(Y.string())),createdAt:Y.date().default(()=>new Date),updatedAt:Y.date().optional()});let oa=["admin","member","owner"];Y.union([Y.enum(oa),Y.array(Y.enum(oa))]);var eq=eq,ot=tb;(0,ot.t)({INVALID_PHONE_NUMBER:"Invalid phone number",PHONE_NUMBER_EXIST:"Phone number already exists",PHONE_NUMBER_NOT_EXIST:"phone number isn't registered",INVALID_PHONE_NUMBER_OR_PASSWORD:"Invalid phone number or password",UNEXPECTED_ERROR:"Unexpected error",OTP_NOT_FOUND:"OTP not found",OTP_EXPIRED:"OTP expired",INVALID_OTP:"Invalid OTP",PHONE_NUMBER_NOT_VERIFIED:"Phone number not verified",PHONE_NUMBER_CANNOT_BE_UPDATED:"Phone number cannot be updated",SEND_OTP_NOT_IMPLEMENTED:"sendOTP not implemented",TOO_MANY_ATTEMPTS:"Too many attempts"});var on=e.i(97858),os=e.i(91236);let oc=BigInt(0),ol=BigInt(1),od=BigInt(2),ou=BigInt(7),op=BigInt(256),of=BigInt(113),om=[],oh=[],og=[];for(let e=0,t=ol,r=1,o=0;e<24;e++){[r,o]=[o,(2*r+3*o)%5],om.push(2*(5*o+r)),oh.push((e+1)*(e+2)/2%64);let i=oc;for(let e=0;e<7;e++)(t=(t<<ol^(t>>ou)*of)%op)&od&&(i^=ol<<(ol<<BigInt(e))-ol);og.push(i)}let ow=(0,os.split)(og,!0),oy=ow[0],oA=ow[1];var eq=eq,ot=tb;(0,ot.t)({OTP_NOT_ENABLED:"OTP not enabled",OTP_HAS_EXPIRED:"OTP has expired",TOTP_NOT_ENABLED:"TOTP not enabled",TWO_FACTOR_NOT_ENABLED:"Two factor isn't enabled",BACKUP_CODES_NOT_ENABLED:"Backup codes aren't enabled",INVALID_BACKUP_CODE:"Invalid backup code",INVALID_CODE:"Invalid code",TOO_MANY_ATTEMPTS_REQUEST_NEW_CODE:"Too many attempts. Please request a new code.",INVALID_TWO_FACTOR_COOKIE:"Invalid two factor cookie"});var eq=eq,ot=tb;let oE=(0,ot.t)({INVALID_USERNAME_OR_PASSWORD:"Invalid username or password",EMAIL_NOT_VERIFIED:"Email not verified",UNEXPECTED_ERROR:"Unexpected error",USERNAME_IS_ALREADY_TAKEN:"Username is already taken. Please try another.",USERNAME_TOO_SHORT:"Username is too short",USERNAME_TOO_LONG:"Username is too long",INVALID_USERNAME:"Username is invalid",INVALID_DISPLAY_USERNAME:"Display username is invalid"});function oT(e){return/^[a-zA-Z0-9_.]+$/.test(e)}var oI=e.i(84501);e.i(11506);var ob=e.i(85111);let o_=((e,t)=>{let r=t(e),{api:o}=r_(r,e);return{handler:async t=>{let o=await r,i=o.options.basePath||"/api/auth";if(!o.options.baseURL){let e=ef(void 0,i,t,void 0,o.options.advanced?.trustedProxyHeaders);if(e)o.baseURL=e,o.options.baseURL=em(o.baseURL)||void 0;else throw new er.BetterAuthError("Could not get base URL from request. Please provide a valid base URL.")}o.trustedOrigins=[...e.trustedOrigins?Array.isArray(e.trustedOrigins)?e.trustedOrigins:await e.trustedOrigins(t):[],o.options.baseURL];let{handler:a}=((e,t)=>{let{api:r,middlewares:o}=r_(e,t),i=new URL(e.baseURL).pathname;return(0,j.createRouter)(r,{routerContext:e,openapi:{disabled:!0},basePath:i,routerMiddleware:[{path:"/**",middleware:tJ},...o],allowedMediaTypes:["application/json"],async onRequest(t){let r=e.options.disabledPaths||[],o=new URL(t.url).pathname.replace(i,"");if(r.includes(o))return new Response("Not Found",{status:404});for(let r of e.options.plugins||[])if(r.onRequest){let o=await r.onRequest(t,e);if(o&&"response"in o)return o.response;if(o&&"request"in o){let t=await t1(o.request,e);if(t)return t;return o.request}}return t1(t,e)},async onResponse(t){for(let r of e.options.plugins||[])if(r.onResponse){let o=await r.onResponse(t,e);if(o)return o.response}return t},onError(r){if(r instanceof j.APIError&&"FOUND"===r.status)return;if(t.onAPIError?.throw)throw r;if(t.onAPIError?.onError)return void t.onAPIError.onError(r,e);let o=t.logger?.level,i="error"===o||"warn"===o||"debug"===o?et.logger:void 0;if(t.logger?.disabled!==!0){if(r&&"object"==typeof r&&"message"in r&&"string"==typeof r.message&&(r.message.includes("no column")||r.message.includes("column")||r.message.includes("relation")||r.message.includes("table")||r.message.includes("does not exist")))return void e.logger?.error(r.message);r instanceof j.APIError?("INTERNAL_SERVER_ERROR"===r.status&&e.logger.error(r.status,r),i?.error(r.message)):e.logger?.error(r&&"object"==typeof r&&"name"in r?r.name:"",r)}}})})(o,e);return(0,rv.r)(o.adapter,()=>a(t))},api:o,options:e,$context:r,$ERROR_CODES:{...e.plugins?.reduce((e,t)=>t.$ERROR_CODES?{...e,...t.$ERROR_CODES}:e,{}),...eq.n}}})({database:(f=oI.db,m={provider:"pg",usePlural:!0,schema:{...ob,user:ob.users,session:ob.sessions,account:ob.accounts,verification:ob.verifications}},a=null,n=e=>({getFieldName:t,options:r})=>{function o(t){let r=m.schema||e._.fullSchema;if(!r)throw new er.BetterAuthError("Drizzle adapter failed to initialize. Schema not found. Please provide a schema object in the adapter options object.");let o=r[t];if(!o)throw new er.BetterAuthError(`[# Drizzle Adapter]: The model "${t}" was not found in the schema object. Please pass the schema directly to the adapter options.`);return o}let i=async(t,r,i,n)=>{if("mysql"!==m.provider)return(await r.returning())[0];await r.execute();let s=o(t),c=r.config?.values;if(n?.length){let r=a(n.map(e=>void 0!==i[e.field]?{...e,value:i[e.field]}:e),t);return(await e.select().from(s).where(...r))[0]}if(c&&c[0]?.id?.value){let t=c[0]?.id?.value;return t||(t=(await e.select({id:r8.sql`LAST_INSERT_ID()`}).from(s).orderBy((0,r3.desc)(s.id)).limit(1))[0].id),(await e.select().from(s).where((0,r5.eq)(s.id,t)).limit(1).execute())[0]}if(i.id)return(await e.select().from(s).where((0,r5.eq)(s.id,i.id)).limit(1).execute())[0];if(!("id"in s))throw new er.BetterAuthError(`The model "${t}" does not have an "id" field. Please use the "id" field as your primary key.`);return(await e.select().from(s).orderBy((0,r3.desc)(s.id)).limit(1).execute())[0]};function a(e,r){let i=o(r);if(!e)return[];if(1===e.length){let o=e[0];if(!o)return[];let a=t({model:r,field:o.field});if(!i[a])throw new er.BetterAuthError(`The field "${o.field}" does not exist in the schema for the model "${r}". Please update your schema.`);if("in"===o.operator){if(!Array.isArray(o.value))throw new er.BetterAuthError(`The value for the field "${o.field}" must be an array when using the "in" operator.`);return[(0,r5.inArray)(i[a],o.value)]}if("not_in"===o.operator){if(!Array.isArray(o.value))throw new er.BetterAuthError(`The value for the field "${o.field}" must be an array when using the "not_in" operator.`);return[(0,r5.notInArray)(i[a],o.value)]}return"contains"===o.operator?[(0,r5.like)(i[a],`%${o.value}%`)]:"starts_with"===o.operator?[(0,r5.like)(i[a],`${o.value}%`)]:"ends_with"===o.operator?[(0,r5.like)(i[a],`%${o.value}`)]:"lt"===o.operator?[(0,r5.lt)(i[a],o.value)]:"lte"===o.operator?[(0,r5.lte)(i[a],o.value)]:"ne"===o.operator?[(0,r5.ne)(i[a],o.value)]:"gt"===o.operator?[(0,r5.gt)(i[a],o.value)]:"gte"===o.operator?[(0,r5.gte)(i[a],o.value)]:[(0,r5.eq)(i[a],o.value)]}let a=e.filter(e=>"AND"===e.connector||!e.connector),n=e.filter(e=>"OR"===e.connector),s=(0,r5.and)(...a.map(e=>{let o=t({model:r,field:e.field});if("in"===e.operator){if(!Array.isArray(e.value))throw new er.BetterAuthError(`The value for the field "${e.field}" must be an array when using the "in" operator.`);return(0,r5.inArray)(i[o],e.value)}if("not_in"===e.operator){if(!Array.isArray(e.value))throw new er.BetterAuthError(`The value for the field "${e.field}" must be an array when using the "not_in" operator.`);return(0,r5.notInArray)(i[o],e.value)}return"contains"===e.operator?(0,r5.like)(i[o],`%${e.value}%`):"starts_with"===e.operator?(0,r5.like)(i[o],`${e.value}%`):"ends_with"===e.operator?(0,r5.like)(i[o],`%${e.value}`):"lt"===e.operator?(0,r5.lt)(i[o],e.value):"lte"===e.operator?(0,r5.lte)(i[o],e.value):"gt"===e.operator?(0,r5.gt)(i[o],e.value):"gte"===e.operator?(0,r5.gte)(i[o],e.value):"ne"===e.operator?(0,r5.ne)(i[o],e.value):(0,r5.eq)(i[o],e.value)})),c=(0,r5.or)(...n.map(e=>{let o=t({model:r,field:e.field});if("in"===e.operator){if(!Array.isArray(e.value))throw new er.BetterAuthError(`The value for the field "${e.field}" must be an array when using the "in" operator.`);return(0,r5.inArray)(i[o],e.value)}if("not_in"===e.operator){if(!Array.isArray(e.value))throw new er.BetterAuthError(`The value for the field "${e.field}" must be an array when using the "not_in" operator.`);return(0,r5.notInArray)(i[o],e.value)}return"contains"===e.operator?(0,r5.like)(i[o],`%${e.value}%`):"starts_with"===e.operator?(0,r5.like)(i[o],`${e.value}%`):"ends_with"===e.operator?(0,r5.like)(i[o],`%${e.value}`):"lt"===e.operator?(0,r5.lt)(i[o],e.value):"lte"===e.operator?(0,r5.lte)(i[o],e.value):"gt"===e.operator?(0,r5.gt)(i[o],e.value):"gte"===e.operator?(0,r5.gte)(i[o],e.value):"ne"===e.operator?(0,r5.ne)(i[o],e.value):(0,r5.eq)(i[o],e.value)})),l=[];return a.length&&l.push(s),n.length&&l.push(c),l}return{async create({model:t,data:r}){let a=o(t);if(!a)throw new er.BetterAuthError("Drizzle adapter failed to initialize. Drizzle Schema not found. Please provide a schema object in the adapter options object.");for(let e in r)if(!a[e])throw new er.BetterAuthError(`The field "${e}" does not exist in the "${t}" Drizzle schema. Please update your drizzle schema or re-generate using "npx @better-auth/cli@latest generate".`);return await i(t,e.insert(a).values(r),r)},async findOne({model:t,where:i,join:n}){let s=o(t),c=a(i,t);if(r.experimental?.joins)if(e.query&&e.query[t]){let o,i=[];if(n)for(let[e,t]of(o={},Object.entries(n))){let a=t.limit??r.advanced?.database?.defaultFindManyLimit??100,n="one-to-one"===t.relation,s=n||m.usePlural?"":"s";o[`${e}${s}`]=!!n||{limit:a},n||i.push(`${e}${s}`)}let a=await e.query[t].findFirst({where:c[0],with:o});if(a)for(let e of i){let t=m.usePlural?e:e.slice(0,-1);a[t]=a[e],e!==t&&delete a[e]}return a}else et.logger.error(`[# Drizzle Adapter]: The model "${t}" was not found in the query object. Please update your Drizzle schema to include relations or re-generate using "npx @better-auth/cli@latest generate".`),et.logger.info("Falling back to regular query");let l=await e.select().from(s).where(...c);return l.length?l[0]:null},async findMany({model:i,where:n,sortBy:s,limit:c,offset:l,join:d}){let u=o(i),p=n?a(n,i):[],f=s?.direction==="desc"?r3.desc:r3.asc;if(r.experimental?.joins)if(e.query[i]){let o,a,n=[];if(d)for(let[e,t]of(o={},Object.entries(d))){let i="one-to-one"===t.relation,a=t.limit??r.advanced?.database?.defaultFindManyLimit??100,s=i||m.usePlural?"":"s";o[`${e}${s}`]=!!i||{limit:a},i||n.push(`${e}${s}`)}s?.field&&(a=[f(u[t({model:i,field:s?.field})])]);let h=await e.query[i].findMany({where:p[0],with:o,limit:c??100,offset:l??0,orderBy:a});if(h)for(let e of h)for(let t of n){let r=m.usePlural?t:t.slice(0,-1);r!==t&&(e[r]=e[t],delete e[t])}return h}else et.logger.error(`[# Drizzle Adapter]: The model "${i}" was not found in the query object. Please update your Drizzle schema to include relations or re-generate using "npx @better-auth/cli@latest generate".`),et.logger.info("Falling back to regular query");let h=e.select().from(u);return void 0!==c&&(h=h.limit(c)),void 0!==l&&(h=h.offset(l)),s?.field&&(h=h.orderBy(f(u[t({model:i,field:s?.field})]))),await h.where(...p)},async count({model:t,where:r}){let i=o(t),n=r?a(r,t):[];return(await e.select({count:r8.sql`count(${r8.sql.raw("*")})`.mapWith(Number)}).from(i).where(...n))[0].count},async update({model:t,where:r,update:n}){let s=o(t),c=a(r,t);return await i(t,e.update(s).set(n).where(...c),n,r)},async updateMany({model:t,where:r,update:i}){let n=o(t),s=a(r,t);return await e.update(n).set(i).where(...s)},async delete({model:t,where:r}){let i=o(t),n=a(r,t);return await e.delete(i).where(...n)},async deleteMany({model:t,where:r}){let i=o(t),n=a(r,t),s=await e.delete(i).where(...n),c=0;return s&&"rowCount"in s?c=s.rowCount:Array.isArray(s)?c=s.length:s&&("affectedRows"in s||"rowsAffected"in s||"changes"in s)&&(c=s.affectedRows??s.rowsAffected??s.changes),"number"!=typeof c&&et.logger.error("[Drizzle Adapter] The result of the deleteMany operation is not a number. This is likely a bug in the adapter. Please report this issue to the Better Auth team.",{res:s,model:t,where:r}),c},options:m}},s=null,s={config:{adapterId:"drizzle",adapterName:"Drizzle Adapter",usePlural:m.usePlural??!1,debugLogs:m.debugLogs??!1,supportsUUIDs:"pg"===m.provider,transaction:!!m.transaction&&(e=>f.transaction(t=>e((0,r4.t)({config:s.config,adapter:n(t)})(a))))},adapter:n(f)},c=(0,r4.t)(s),e=>(a=e,c(e))),emailAndPassword:{enabled:!0,requireEmailVerification:!1},plugins:[(h={minUsernameLength:3,maxUsernameLength:30},l=e=>h?.usernameNormalization===!1?e:h?.usernameNormalization?h.usernameNormalization(e):e.toLowerCase(),d=e=>h?.displayUsernameNormalization?h.displayUsernameNormalization(e):e,{id:"username",init:e=>({options:{databaseHooks:{user:{create:{async before(e,t){let r="username"in e?e.username:null,o="displayUsername"in e?e.displayUsername:null;return{data:{...e,...r?{username:l(r)}:{},...o?{displayUsername:d(o)}:{}}}}},update:{async before(e,t){let r="username"in e?e.username:null,o="displayUsername"in e?e.displayUsername:null;return{data:{...e,...r?{username:l(r)}:{},...o?{displayUsername:d(o)}:{}}}}}}}}}),endpoints:{signInUsername:eH("/sign-in/username",{method:"POST",body:Y.object({username:Y.string().meta({description:"The username of the user"}),password:Y.string().meta({description:"The password of the user"}),rememberMe:Y.boolean().meta({description:"Remember the user session"}).optional(),callbackURL:Y.string().meta({description:"The URL to redirect to after email verification"}).optional()}),metadata:{openapi:{summary:"Sign in with username",description:"Sign in with username",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string",description:"Session token for the authenticated session"},user:{$ref:"#/components/schemas/User"}},required:["token","user"]}}}},422:{description:"Unprocessable Entity. Validation error",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}}}}}}},async e=>{if(!e.body.username||!e.body.password)throw e.context.logger.error("Username or password not found"),new j.APIError("UNAUTHORIZED",{message:oE.INVALID_USERNAME_OR_PASSWORD});let t=h?.validationOrder?.username==="pre-normalization"?l(e.body.username):e.body.username,r=h?.minUsernameLength||3,o=h?.maxUsernameLength||30;if(t.length<r)throw e.context.logger.error("Username too short",{username:t}),new j.APIError("UNPROCESSABLE_ENTITY",{code:"USERNAME_TOO_SHORT",message:oE.USERNAME_TOO_SHORT});if(t.length>o)throw e.context.logger.error("Username too long",{username:t}),new j.APIError("UNPROCESSABLE_ENTITY",{message:oE.USERNAME_TOO_LONG});if(!(h?.usernameValidator||oT)(t))throw new j.APIError("UNPROCESSABLE_ENTITY",{message:oE.INVALID_USERNAME});let i=await e.context.adapter.findOne({model:"user",where:[{field:"username",value:l(t)}]});if(!i)throw await e.context.password.hash(e.body.password),e.context.logger.error("User not found",{username:t}),new j.APIError("UNAUTHORIZED",{message:oE.INVALID_USERNAME_OR_PASSWORD});let a=await e.context.adapter.findOne({model:"account",where:[{field:"userId",value:i.id},{field:"providerId",value:"credential"}]});if(!a)throw new j.APIError("UNAUTHORIZED",{message:oE.INVALID_USERNAME_OR_PASSWORD});let n=a?.password;if(!n)throw e.context.logger.error("Password not found",{username:t}),new j.APIError("UNAUTHORIZED",{message:oE.INVALID_USERNAME_OR_PASSWORD});if(!await e.context.password.verify({hash:n,password:e.body.password}))throw e.context.logger.error("Invalid password"),new j.APIError("UNAUTHORIZED",{message:oE.INVALID_USERNAME_OR_PASSWORD});if(e.context.options?.emailAndPassword?.requireEmailVerification&&!i.emailVerified){if(!e.context.options?.emailVerification?.sendVerificationEmail)throw new j.APIError("FORBIDDEN",{message:oE.EMAIL_NOT_VERIFIED});if(e.context.options?.emailVerification?.sendOnSignIn){let t=await ro(e.context.secret,i.email,void 0,e.context.options.emailVerification?.expiresIn),r=`${e.context.baseURL}/verify-email?token=${t}&callbackURL=${e.body.callbackURL||"/"}`;await e.context.options.emailVerification.sendVerificationEmail({user:i,url:r,token:t},e.request)}throw new j.APIError("FORBIDDEN",{message:oE.EMAIL_NOT_VERIFIED})}let s=await e.context.internalAdapter.createSession(i.id,!1===e.body.rememberMe);return s?(await e$(e,{session:s,user:i},!1===e.body.rememberMe),e.json({token:s.token,user:{id:i.id,email:i.email,emailVerified:i.emailVerified,username:i.username,displayUsername:i.displayUsername,name:i.name,image:i.image,createdAt:i.createdAt,updatedAt:i.updatedAt}})):e.json(null,{status:500,body:{message:eq.n.FAILED_TO_CREATE_SESSION}})}),isUsernameAvailable:eH("/is-username-available",{method:"POST",body:Y.object({username:Y.string().meta({description:"The username to check"})})},async e=>{let t=e.body.username;if(!t)throw new j.APIError("UNPROCESSABLE_ENTITY",{message:oE.INVALID_USERNAME});let r=h?.minUsernameLength||3,o=h?.maxUsernameLength||30;if(t.length<r)throw new j.APIError("UNPROCESSABLE_ENTITY",{code:"USERNAME_TOO_SHORT",message:oE.USERNAME_TOO_SHORT});if(t.length>o)throw new j.APIError("UNPROCESSABLE_ENTITY",{message:oE.USERNAME_TOO_LONG});if(!await (h?.usernameValidator||oT)(t))throw new j.APIError("UNPROCESSABLE_ENTITY",{message:oE.INVALID_USERNAME});return await e.context.adapter.findOne({model:"user",where:[{field:"username",value:l(t)}]})?e.json({available:!1}):e.json({available:!0})})},schema:function(e,t){if(!t)return e;for(let r in t){let o=t[r]?.modelName;for(let i in o&&(e[r].modelName=o),e[r].fields){let o=t[r]?.fields?.[i];o&&(e[r].fields[i].fieldName=o)}}return e}((u={username:l,displayUsername:d},{user:{fields:{username:{type:"string",required:!1,sortable:!0,unique:!0,returned:!0,transform:{input:e=>"string"!=typeof e?e:u.username(e)}},displayUsername:{type:"string",required:!1,transform:{input:e=>"string"!=typeof e?e:u.displayUsername(e)}}}}}),h?.schema),hooks:{before:[{matcher:e=>"/sign-up/email"===e.path||"/update-user"===e.path,handler:eB(async e=>{let t="string"==typeof e.body.username&&h?.validationOrder?.username==="post-normalization"?l(e.body.username):e.body.username;if(void 0!==t&&"string"==typeof t){let r=h?.minUsernameLength||3,o=h?.maxUsernameLength||30;if(t.length<r)throw new j.APIError("BAD_REQUEST",{code:"USERNAME_TOO_SHORT",message:oE.USERNAME_TOO_SHORT});if(t.length>o)throw new j.APIError("BAD_REQUEST",{message:oE.USERNAME_TOO_LONG});if(!await (h?.usernameValidator||oT)(t))throw new j.APIError("BAD_REQUEST",{message:oE.INVALID_USERNAME});let i=await e.context.adapter.findOne({model:"user",where:[{field:"username",value:t}]}),a="/sign-up/email"===e.path&&i,n="/update-user"===e.path&&i&&e.context.session&&i.id!==e.context.session.session.userId;if(a||n)throw new j.APIError("BAD_REQUEST",{message:oE.USERNAME_IS_ALREADY_TAKEN})}let r="string"==typeof e.body.displayUsername&&h?.validationOrder?.displayUsername==="post-normalization"?d(e.body.displayUsername):e.body.displayUsername;if(void 0!==r&&"string"==typeof r&&h?.displayUsernameValidator&&!await h.displayUsernameValidator(r))throw new j.APIError("BAD_REQUEST",{message:oE.INVALID_DISPLAY_USERNAME})})},{matcher:e=>"/sign-up/email"===e.path||"/update-user"===e.path,handler:eB(async e=>{e.body.username&&!e.body.displayUsername&&(e.body.displayUsername=e.body.username),e.body.displayUsername&&!e.body.username&&(e.body.username=e.body.displayUsername)})}]},$ERROR_CODES:oE})],session:{cookieCache:{enabled:!0,maxAge:300},expiresIn:604800,updateAge:86400},user:{additionalFields:{schoolId:{type:"string",required:!1},role:{type:"string",required:!0,defaultValue:"student"},firstName:{type:"string",required:!0},lastName:{type:"string",required:!0},isActive:{type:"boolean",required:!1,defaultValue:!0},lastLoginAt:{type:"date",required:!1}}},trustedOrigins:[process.env.BETTER_AUTH_URL||"http://localhost:3000"]},r2),{GET:ok,POST:ov}={GET:p=async e=>"handler"in o_?o_.handler(e):o_(e),POST:p,PATCH:p,PUT:p,DELETE:p};e.s(["GET",0,ok,"POST",0,ov],67110);var oR=e.i(67110);let oU=new g.AppRouteRouteModule({definition:{kind:w.RouteKind.APP_ROUTE,page:"/api/auth/[...all]/route",pathname:"/api/auth/[...all]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/auth/[...all]/route.ts",nextConfigOutput:"",userland:oR}),{workAsyncStorage:oS,workUnitAsyncStorage:oO,serverHooks:ox}=oU;function oD(){return(0,y.patchFetch)({workAsyncStorage:oS,workUnitAsyncStorage:oO})}async function oN(e,t,r){oU.isDev&&(0,A.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let o="/api/auth/[...all]/route";o=o.replace(/\/index$/,"")||"/";let i=await oU.prepare(e,t,{srcPage:o,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:a,params:n,nextConfig:s,parsedUrl:c,isDraftMode:l,prerenderManifest:d,routerServerContext:u,isOnDemandRevalidate:p,revalidateOnlyGenerated:f,resolvedPathname:m,clientReferenceManifest:h,serverActionsManifest:g}=i,y=(0,b.normalizeAppPath)(o),L=!!(d.dynamicRoutes[y]||d.routes[m]),P=async()=>((null==u?void 0:u.render404)?await u.render404(e,t,c,!1):t.end("This page could not be found"),null);if(L&&!l){let e=!!d.routes[m],t=d.dynamicRoutes[y];if(t&&!1===t.fallback&&!e){if(s.experimental.adapterPath)return await P();throw new D.NoFallbackError}}let C=null;!L||oU.isDev||l||(C="/index"===(C=m)?"/":C);let j=!0===oU.isDev||!L,$=L&&!j;g&&h&&(0,T.setReferenceManifestsSingleton)({page:o,clientReferenceManifest:h,serverActionsManifest:g,serverModuleMap:(0,I.createServerModuleMap)({serverActionsManifest:g})});let V=e.method||"GET",q=(0,E.getTracer)(),M=q.getActiveScopeSpan(),z={params:n,prerenderManifest:d,renderOpts:{experimental:{authInterrupts:!!s.experimental.authInterrupts},cacheComponents:!!s.cacheComponents,supportsDynamicResponse:j,incrementalCache:(0,A.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:s.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,o)=>oU.onRequestError(e,t,o,u)},sharedContext:{buildId:a}},B=new _.NodeNextRequest(e),F=new _.NodeNextResponse(t),H=k.NextRequestAdapter.fromNodeNextRequest(B,(0,k.signalFromNodeResponse)(t));try{let i=async e=>oU.handle(H,z).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=q.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==v.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=r.get("next.route");if(i){let t=`${V} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${V} ${o}`)}),a=!!(0,A.getRequestMeta)(e,"minimalMode"),n=async n=>{var c,m;let h=async({previousCacheEntry:s})=>{try{if(!a&&p&&f&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await i(n);e.fetchMetrics=z.renderOpts.fetchMetrics;let c=z.renderOpts.pendingWaitUntil;c&&r.waitUntil&&(r.waitUntil(c),c=void 0);let l=z.renderOpts.collectedTags;if(!L)return await (0,U.sendResponse)(B,F,o,z.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,S.toNodeOutgoingHttpHeaders)(o.headers);l&&(t[x.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==z.renderOpts.collectedRevalidate&&!(z.renderOpts.collectedRevalidate>=x.INFINITE_CACHE)&&z.renderOpts.collectedRevalidate,i=void 0===z.renderOpts.collectedExpire||z.renderOpts.collectedExpire>=x.INFINITE_CACHE?void 0:z.renderOpts.collectedExpire;return{value:{kind:N.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:i}}}}catch(t){throw(null==s?void 0:s.isStale)&&await oU.onRequestError(e,t,{routerKind:"App Router",routePath:o,routeType:"route",revalidateReason:(0,R.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:p})},u),t}},g=await oU.handleResponse({req:e,nextConfig:s,cacheKey:C,routeKind:w.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:d,isRoutePPREnabled:!1,isOnDemandRevalidate:p,revalidateOnlyGenerated:f,responseGenerator:h,waitUntil:r.waitUntil,isMinimalMode:a});if(!L)return null;if((null==g||null==(c=g.value)?void 0:c.kind)!==N.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==g||null==(m=g.value)?void 0:m.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});a||t.setHeader("x-nextjs-cache",p?"REVALIDATED":g.isMiss?"MISS":g.isStale?"STALE":"HIT"),l&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let y=(0,S.fromNodeOutgoingHttpHeaders)(g.value.headers);return a&&L||y.delete(x.NEXT_CACHE_TAGS_HEADER),!g.cacheControl||t.getHeader("Cache-Control")||y.get("Cache-Control")||y.set("Cache-Control",(0,O.getCacheControlHeader)(g.cacheControl)),await (0,U.sendResponse)(B,F,new Response(g.value.body,{headers:y,status:g.value.status||200})),null};M?await n(M):await q.withPropagatedContext(e.headers,()=>q.trace(v.BaseServerSpan.handleRequest,{spanName:`${V} ${o}`,kind:E.SpanKind.SERVER,attributes:{"http.method":V,"http.target":e.url}},n))}catch(t){if(t instanceof D.NoFallbackError||await oU.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,R.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:p})}),L)throw t;return await (0,U.sendResponse)(B,F,new Response(null,{status:500})),null}}e.s(["handler",()=>oN,"patchFetch",()=>oD,"routeModule",()=>oU,"serverHooks",()=>ox,"workAsyncStorage",()=>oS,"workUnitAsyncStorage",()=>oO],67691)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_3590c788.js.map